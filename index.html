<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #10B981;
            --primary-dark: #059669;
            --bg-dark: #1f2937;
            --text-dark: #f3f4f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
            border: 1px solid #4b5563;
        }

        input, select, textarea {
            background-color: #4b5563;
            color: var(--text-dark);
            border-color: #6b7280;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .scrollable-content {
            height: calc(100vh - 120px); 
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollable-content::-webkit-scrollbar {
            display: none;
        }
        
        .tab-button.active {
            border-bottom-width: 3px;
            border-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Global Modals and Overlays -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
            <p class="mt-4 text-white text-lg" id="loading-text">ဒေတာများ ဆွဲယူနေပါသည်...</p>
        </div>
    </div>
    
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-transform duration-300 transform translate-x-full"></div>

    <!-- Login/Sign Up Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <!-- Auth UI will be rendered here -->
    </div>
    
    <!-- Main App Content (Hidden until authenticated) -->
    <div id="app-content-wrapper" class="max-w-xl mx-auto min-h-screen flex flex-col hidden">
        <!-- Header -->
        <header id="app-header" class="p-4 pt-6 text-center">
            <h1 class="text-2xl font-extrabold" id="app-title">ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)</h1>
            <p id="user-info" class="text-sm mt-1 text-gray-500">Loading user...</p>
        </header>

        <!-- Content Area -->
        <main id="content-area" class="flex-grow p-4 scrollable-content">
            <!-- Content will be rendered here based on the current screen -->
        </main>

        <!-- Navigation Footer -->
        <footer id="nav-footer" class="sticky bottom-0 w-full max-w-xl mx-auto bg-gray-800 border-t border-gray-700 p-2 shadow-lg">
            <div class="flex justify-around text-xs font-medium" id="nav-container">
                <!-- Nav items will be generated here -->
            </div>
        </footer>
    </div>
    
    <!-- Firebase SDKs and Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // --- Cloudinary Configuration ---
        const CLOUDINARY_CLOUD_NAME = 'waiyansoe';
        const CLOUDINARY_UPLOAD_PRESET = 'waiyansoe118234';
        
        // --- Firebase Configuration ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAUL74mqVCIY1MMclrRhdVbY_VyP4lgQpY",
            authDomain: "waiappstore.firebaseapp.com",
            projectId: "waiappstore",
            storageBucket: "waiappstore.firebasestorage.app",
            messagingSenderId: "161610339691",
            appId: "1:161610339691:web:ce59fafb6a21729030682e",
            measurementId: "G-HH95X102MG"
        };

        const ADMIN_EMAIL = 'c388925@gmail.com';
        const APP_ID = 'thai-myanmar-remittance';
        
        let app, db, auth;
        let userId = null, userEmail = null, isAdmin = false;
        let currentScreen = 'home', isAuthReady = false, currentTransferTab = 'account';

        // State for rates - ပြင်ဆင်ထားသော format
        let currentRates = {
            THB_TO_MMK: 121.95, // ၁ ဘတ်လျှင် ကျပ် (အကောင့်ထဲထည့်ဖို့ ၁သိန်းရရန်)
            MMK_TO_THB: 126.58, // ၁ သိန်းလျှင် ရမည့်ဘတ်
            rateHomeDeliveryTHB: 820, // အိမ်အရောက်ပို့ ၁သိန်းရရန် ဘတ်
            lastUpdated: 'Loading...'
        };

        let adminBankInfo = {
            image1URL: 'https://placehold.co/200x100/10B981/ffffff?text=Bank+QR+1',
            image2URL: 'https://placehold.co/200x100/60A5FA/ffffff?text=Bank+QR+2'
        };

        let transferDirection = 'THB_TO_MMK'; 
        let userTransfers = [];
        let adminTransfers = [];
        let userNotifications = [];

        // --- Utility Functions ---
        const showMessage = (msg, type = 'success') => {
            const box = document.getElementById('message-box');
            const color = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
            const html = `
                <div class="${color} text-white p-3 rounded-lg shadow-xl mb-3 text-sm" style="min-width: 250px;">
                    ${msg}
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const messageElement = tempDiv.firstChild;
            
            box.prepend(messageElement);
            box.classList.remove('translate-x-full');
            box.classList.add('translate-x-0');

            setTimeout(() => {
                messageElement.remove();
                if (box.children.length === 0) {
                    box.classList.remove('translate-x-0');
                    box.classList.add('translate-x-full');
                }
            }, 5000);
        };

        // Cloudinary Upload Function
        const uploadToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            
            try {
                console.log('Uploading to Cloudinary...');
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Cloudinary upload failed: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Upload successful:', data.secure_url);
                return data.secure_url;
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                throw new Error(`ပုံတင်ရာတွင် အမှားရှိပါသည်: ${error.message}`);
            }
        };

        // --- Firebase Initialization and Auth ---
        const initFirebase = async () => {
            try {
                app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userEmail = user.email;
                        isAdmin = user.email === ADMIN_EMAIL;
                        
                        document.getElementById('user-info').textContent = `${user.displayName || user.email} (ID: ${userId.substring(0, 8)}...)`;
                        
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('app-content-wrapper').classList.remove('hidden');

                        if (!isAuthReady) {
                            isAuthReady = true;
                            updateStaticText();
                            loadRates();
                            loadAdminBankInfo();
                            loadTransfers();
                            loadNotifications();
                            showScreen('home'); 
                        }
                    } else {
                        isAuthReady = false;
                        userId = null;
                        userEmail = null;
                        isAdmin = false;
                        document.getElementById('app-content-wrapper').classList.add('hidden');
                        document.getElementById('auth-screen').classList.remove('hidden');
                        renderAuthScreen();
                    }
                    document.getElementById('loading-overlay').classList.add('hidden');
                });
                
                document.getElementById('loading-overlay').classList.remove('hidden');

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading-overlay').classList.add('hidden');
                showMessage(`Firebase အမှား: ${error.message}`, 'error');
            }
        };

        const renderAuthScreen = (isLogin = true) => {
            const authScreen = document.getElementById('auth-screen');
            authScreen.innerHTML = `
                <div class="card w-full max-w-sm p-8 rounded-xl space-y-6">
                    <h2 class="text-3xl font-bold text-center text-emerald-400">${isLogin ? 'အကောင့်ဝင်ရန်' : 'အကောင့်ဖွင့်ရန်'}</h2>
                    
                    <form id="auth-form" onsubmit="event.preventDefault(); handleAuthSubmit(${isLogin})">
                        ${!isLogin ? `
                            <div>
                                <label for="username" class="block text-sm font-medium mb-1">Username</label>
                                <input type="text" id="username" required class="w-full p-3 border rounded-lg" placeholder="သင့်အမည်">
                            </div>` : ''}
                        <div>
                            <label for="email" class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" id="email" required class="w-full p-3 border rounded-lg" placeholder="example@gmail.com">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="password" required class="w-full p-3 border rounded-lg" placeholder="လျှို့ဝှက်နံပါတ် (၆ လုံးအထက်)">
                        </div>
                        
                        <button type="submit" class="btn-primary w-full py-3 rounded-lg mt-4 font-bold">
                            ${isLogin ? 'အကောင့်ဝင်ရန်' : 'အကောင့်ဖွင့်ရန်'}
                        </button>
                    </form>
                    
                    <button onclick="renderAuthScreen(!${isLogin})" class="w-full text-sm text-center text-blue-400 hover:text-blue-300">
                        ${isLogin ? 'အကောင့်မရှိသေးဘူးလား? အကောင့်ဖွင့်ရန်' : 'အကောင့်ရှိပြီးသားလား? အကောင့်ဝင်ရန်'}
                    </button>
                </div>
            `;
        };

        const handleAuthSubmit = async (isLogin) => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = isLogin ? null : document.getElementById('username').value;
            
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage('အကောင့်ဝင်ခြင်း အောင်မြင်ပါသည်။');
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: username });
                    showMessage('အကောင့်ဖွင့်ခြင်း အောင်မြင်ပါသည်။');
                }
            } catch (error) {
                console.error("Auth Error:", error);
                let msg = 'အမှားရှိသည်';
                if (error.code === 'auth/invalid-email') msg = 'Email မှားယွင်းနေသည်။';
                else if (error.code === 'auth/wrong-password') msg = 'Password မှားယွင်းနေသည်။';
                else if (error.code === 'auth/user-not-found') msg = 'ဤအကောင့် မရှိပါ။';
                else if (error.code === 'auth/email-already-in-use') msg = 'ဤ Email ဖြင့် အကောင့်ဖွင့်ထားပြီးဖြစ်သည်။';
                else if (error.code === 'auth/weak-password') msg = 'Password မှာ အနည်းဆုံး ၆ လုံးရှိရမည်။';

                showMessage(msg, 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Firestore Data Handlers ---
        const PUBLIC_DATA_PATH = `artifacts/${APP_ID}/public/data`;
        const USER_DATA_PATH = (uid) => `artifacts/${APP_ID}/users/${uid}`;

        const updateStaticText = () => {
            const adminButtonHtml = isAdmin ? `
                <button onclick="showScreen('admin')" id="admin-nav-button" class="nav-button flex flex-col items-center p-2 rounded-lg text-red-400 hover:text-red-300">
                    <i class="fa-solid fa-screwdriver-wrench text-xl"></i>
                    <span class="mt-1">စီမံခန့်ခွဲမှု</span>
                </button>
            ` : '';

            const navContainer = document.getElementById('nav-container');
            navContainer.innerHTML = `
                <button onclick="showScreen('home')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-exchange-alt text-xl"></i>
                    <span class="mt-1">ငွေလဲနှုန်း</span>
                </button>
                <button onclick="showScreen('transfer')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-paper-plane text-xl"></i>
                    <span class="mt-1">ငွေလွဲရန်</span>
                </button>
                <button onclick="showScreen('inbox')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500 relative">
                    <i class="fa-solid fa-inbox text-xl"></i>
                    <span id="inbox-badge" class="absolute top-0 right-0 inline-block w-3 h-3 bg-red-500 rounded-full hidden"></span>
                    <span class="mt-1">အဝင်စာ</span>
                </button>
                <button onclick="showScreen('profile')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-user-gear text-xl"></i>
                    <span class="mt-1">Profile</span>
                </button>
                ${adminButtonHtml}
            `;
            showScreen(currentScreen);
        };

        // --- Rate Management (ပြင်ဆင်ထားသော version) ---
        const loadRates = () => {
            const docRef = doc(db, PUBLIC_DATA_PATH, 'rates', 'current');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentRates.THB_TO_MMK = data.rateBuyMMK || 121.95;
                    currentRates.MMK_TO_THB = data.rateBuyTHB || 126.58;
                    currentRates.rateHomeDeliveryTHB = data.rateHomeDeliveryTHB || 820;
                    
                    const timestamp = data.lastUpdated;
                    if (timestamp) {
                        const date = timestamp.toDate();
                        currentRates.lastUpdated = date.toLocaleString('my-MM', {
                            year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                    } else {
                        currentRates.lastUpdated = 'ယခုလေးတင်';
                    }
                    if (currentScreen === 'home') renderHome();
                } else {
                    // Create initial rates document if it doesn't exist
                    setDoc(docRef, { 
                        rateBuyMMK: currentRates.THB_TO_MMK,
                        rateBuyTHB: currentRates.MMK_TO_THB,
                        rateHomeDeliveryTHB: currentRates.rateHomeDeliveryTHB,
                        lastUpdated: serverTimestamp() 
                    });
                }
            }, (error) => {
                console.error("Error fetching rates: ", error);
                showMessage('ငွေလဲနှုန်းများ ဆွဲယူရာတွင် အမှားရှိပါသည်', 'error');
            });
        };

        const loadAdminBankInfo = () => {
            const docRef = doc(db, PUBLIC_DATA_PATH, 'config', 'bankInfo');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    adminBankInfo.image1URL = data.image1URL || adminBankInfo.image1URL;
                    adminBankInfo.image2URL = data.image2URL || adminBankInfo.image2URL;
                    if (currentScreen === 'home') renderHome();
                } else {
                    setDoc(docRef, adminBankInfo, { merge: true });
                }
            }, (error) => console.error("Error fetching bank info: ", error));
        };

        // --- Transfers and Notifications (ပြင်ဆင်ထားသော version) ---
        const loadTransfers = () => {
            if (!isAuthReady || !userId) return;
            
            const transfersColRef = collection(db, PUBLIC_DATA_PATH, 'transfers');
            
            onSnapshot(transfersColRef, (snapshot) => {
                const transfers = [];
                snapshot.forEach((doc) => {
                    transfers.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('Loaded transfers:', transfers.length);
                
                // Admin transfers - all transfers
                adminTransfers = transfers.sort((a, b) => {
                    if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                    if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                    return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
                });

                // User transfers - only user's transfers
                userTransfers = transfers.filter(t => t.senderId === userId)
                                         .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                console.log('User transfers:', userTransfers.length);
                console.log('Admin transfers:', adminTransfers.length);
                
                if (currentScreen === 'admin') renderAdminPanel();
                if (currentScreen === 'profile') renderProfile();

            }, (error) => {
                console.error("Error fetching transfers: ", error);
                showMessage('ငွေလွဲမှုများ ဆွဲယူရာတွင် အမှားရှိပါသည်', 'error');
            });
        };

        const loadNotifications = () => {
            if (!isAuthReady || !userId) return;
            
            const notificationsColRef = collection(db, `artifacts/${APP_ID}/users/${userId}`, 'notifications');
            
            onSnapshot(notificationsColRef, (snapshot) => {
                userNotifications = [];
                snapshot.forEach((doc) => {
                    userNotifications.push({ id: doc.id, ...doc.data() });
                });
                
                userNotifications.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                const unreadCount = userNotifications.filter(n => !n.isRead).length;
                const badge = document.getElementById('inbox-badge');
                if (badge) {
                    badge.classList.toggle('hidden', unreadCount === 0);
                }

                if (currentScreen === 'inbox') renderInbox();
            }, (error) => {
                console.error("Error fetching notifications: ", error);
            });
        };

        // --- UI Rendering Functions ---
        const renderHome = () => {
            const lastUpdated = currentRates.lastUpdated;
            
            // အကောင့်ထဲထည့်ဖို့ ၁သိန်းရရန် ဘတ်
            const thbFor100kMMK = (100000 / currentRates.THB_TO_MMK).toFixed(2);
            // ၁သိန်းလျှင် ရမည့်ဘတ်
            const thbFor100kMMK_reverse = (100000 / currentRates.MMK_TO_THB).toFixed(2);
            // အိမ်အရောက်ပို့ ၁သိန်းရရန် ဘတ်
            const thbHomeDelivery = currentRates.rateHomeDeliveryTHB;

            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="space-y-6">
                    <p class="text-sm font-semibold text-emerald-400">ငွေလဲနှုန်း (၁ ဘတ်လျှင် မြန်မာကျပ်)</p>
                    <p class="text-xs text-gray-400">နောက်ဆုံး အပ်ဒိတ်: ${lastUpdated}</p>

                    <!-- Home Delivery Rate Card -->
                    <div class="card p-6 rounded-xl space-y-4 border border-red-500/50">
                        <h2 class="text-lg font-bold text-red-400">အိမ်သို့ ငွေလွဲရန် (Home Delivery Rate) (ထိုင်းမှသာ)</h2>
                        <div class="flex items-center justify-between p-4 bg-gray-600 rounded-xl">
                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300">ဘတ်</p>
                                <p class="text-2xl font-bold text-gray-50 mt-1">${thbHomeDelivery} ဘတ်</p>
                            </div>
                            <i class="fa-solid fa-arrow-right text-2xl text-red-400"></i>
                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300">ကျပ်</p>
                                <p class="text-2xl font-bold text-gray-50 mt-1">100,000 ကျပ်</p>
                            </div>
                        </div>
                        <p class="text-sm text-center text-gray-200">
                            ၁ ဘတ် = ${(100000 / thbHomeDelivery).toFixed(2)} ကျပ်
                        </p>
                    </div>

                    <!-- Account Transfer Rate Card -->
                    <div class="card p-6 rounded-xl space-y-4">
                        <h2 class="text-lg font-bold text-emerald-400">အကောင့်သို့ ငွေလွဲရန်</h2>
                        <div class="flex items-center justify-between p-4 bg-gray-600 rounded-xl">
                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300">${transferDirection === 'THB_TO_MMK' ? 'ထိုင်းမှ' : 'မြန်မာမှ'}</p>
                                <p class="text-xl font-bold text-gray-50 mt-1">
                                    ${transferDirection === 'THB_TO_MMK' ? `${thbFor100kMMK} ဘတ်` : `100,000 ကျပ်`}
                                </p>
                            </div>

                            <button onclick="toggleRateDirection()" class="text-2xl text-emerald-400 transition-transform duration-300">
                                <i class="fa-solid fa-arrows-left-right"></i>
                            </button>

                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300">${transferDirection === 'THB_TO_MMK' ? 'ကျပ်' : 'ဘတ်'}</p>
                                <p class="text-xl font-bold text-gray-50 mt-1">
                                    ${transferDirection === 'THB_TO_MMK' ? `100,000 ကျပ်` : `${thbFor100kMMK_reverse} ဘတ်`}
                                </p>
                            </div>
                        </div>
                        <div class="text-center pt-2">
                            <p class="text-sm font-bold text-gray-200">
                                ${transferDirection === 'THB_TO_MMK' ? 
                                    `အကောင့်ထဲထည့်ဖို့ ၁သိန်းရရန်: ${thbFor100kMMK} ဘတ်` : 
                                    `၁သိန်းလျှင်ရမည့်ဘတ်: ${thbFor100kMMK_reverse} ဘတ်`}
                            </p>
                        </div>
                    </div>

                    <!-- Admin Bank Info -->
                    ${renderAdminBankInfo()}
                    
                    ${isAdmin ? renderAdminRatePanel() : ''}
                </div>
            `;
        };

        const renderAdminBankInfo = () => {
            return `
                <div class="card p-5 rounded-xl border border-blue-400/50">
                    <h2 class="text-xl font-bold text-blue-400 mb-3">Admin ၏ ငွေလွဲမည့် ဘဏ်အချက်အလက်</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <img src="${adminBankInfo.image1URL}" onerror="this.src='https://placehold.co/200x100/374151/ffffff?text=Bank+QR+1'" class="w-full rounded-lg object-cover border border-gray-600" alt="ဘဏ်ပုံ ၁">
                            <button onclick="downloadImage('${adminBankInfo.image1URL}')" class="w-full flex items-center justify-center p-2 text-xs bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                                <i class="fa-solid fa-download mr-2"></i> ပုံကို Save
                            </button>
                        </div>
                        <div class="space-y-2">
                            <img src="${adminBankInfo.image2URL}" onerror="this.src='https://placehold.co/200x100/374151/ffffff?text=Bank+QR+2'" class="w-full rounded-lg object-cover border border-gray-600" alt="ဘဏ်ပုံ ၂">
                            <button onclick="downloadImage('${adminBankInfo.image2URL}')" class="w-full flex items-center justify-center p-2 text-xs bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                                <i class="fa-solid fa-download mr-2"></i> ပုံကို Save
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderAdminRatePanel = () => {
            return `
                <div class="card p-5 rounded-xl border border-red-400/50">
                    <h2 class="text-xl font-bold text-red-400 mb-3">Admin: ငွေလဲနှုန်းများ ပြင်ဆင်ရန်</h2>
                    <form id="rate-update-form" onsubmit="event.preventDefault(); updateRates()" class="space-y-3">
                        <div>
                            <label for="rateBuyMMKInput" class="block text-sm font-medium">ထိုင်းမှမြန်မာ (အကောင့်ထဲထည့်ဖို့ ၁သိန်းရရန် ဘတ်)</label>
                            <input type="number" id="rateBuyMMKInput" step="0.01" value="${(100000 / currentRates.THB_TO_MMK).toFixed(2)}" required class="mt-1 w-full p-2 border rounded-lg">
                            <p class="text-xs text-gray-400 mt-1">လက်ရှိ: ၁ ဘတ် = ${currentRates.THB_TO_MMK.toFixed(2)} ကျပ်</p>
                        </div>
                        <div>
                            <label for="rateBuyTHBInput" class="block text-sm font-medium">မြန်မာမှထိုင်း (၁သိန်းလျှင်ရမည့်ဘတ်)</label>
                            <input type="number" id="rateBuyTHBInput" step="0.01" value="${(100000 / currentRates.MMK_TO_THB).toFixed(2)}" required class="mt-1 w-full p-2 border rounded-lg">
                            <p class="text-xs text-gray-400 mt-1">လက်ရှိ: ၁ ဘတ် = ${currentRates.MMK_TO_THB.toFixed(2)} ကျပ်</p>
                        </div>
                        <div>
                            <label for="rateHomeDeliveryTHBInput" class="block text-sm font-medium">အိမ်အရောက်ပို့ (၁သိန်းရရန် ဘတ်)</label>
                            <input type="number" id="rateHomeDeliveryTHBInput" step="0.01" value="${currentRates.rateHomeDeliveryTHB}" required class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                        <button type="submit" class="btn-primary w-full py-2 rounded-lg font-semibold">နှုန်းထားများ အပ်ဒိတ်လုပ်ရန်</button>
                    </form>
                </div>
            `;
        };

        const updateRates = async () => {
            if (!isAdmin) return showMessage('Admin လုပ်ဆောင်ချက်သာ ဖြစ်သည်', 'error');

            // Get values from the new input format
            const thbFor100kMMK = parseFloat(document.getElementById('rateBuyMMKInput').value);
            const thbFor100kMMK_reverse = parseFloat(document.getElementById('rateBuyTHBInput').value);
            const rateHomeDeliveryTHB = parseFloat(document.getElementById('rateHomeDeliveryTHBInput').value);
            
            if (isNaN(thbFor100kMMK) || isNaN(thbFor100kMMK_reverse) || isNaN(rateHomeDeliveryTHB)) {
                return showMessage('မှန်ကန်သော နှုန်းထားများကို ဖြည့်သွင်းပါ', 'error');
            }

            // Convert back to rate per 1 THB
            const rateBuyMMK = 100000 / thbFor100kMMK;
            const rateBuyTHB = 100000 / thbFor100kMMK_reverse;

            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                const docRef = doc(db, PUBLIC_DATA_PATH, 'rates', 'current');
                await updateDoc(docRef, { 
                    rateBuyMMK, 
                    rateBuyTHB,
                    rateHomeDeliveryTHB,
                    lastUpdated: serverTimestamp() 
                });
                showMessage('နှုန်းထားများ အောင်မြင်စွာ အပ်ဒိတ်လုပ်ပြီးပါပြီ။');
            } catch (e) {
                console.error("Error updating rates: ", e);
                showMessage('နှုန်းထား အပ်ဒိတ်လုပ်ရာတွင် အမှားရှိသည်', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // Transfer related functions continue...
        // (ကျန်ရှိသော function များ ဆက်ရှိပါမည်)

        // Start initialization
        initFirebase();

        // Global functions
        window.renderAuthScreen = renderAuthScreen;
        window.handleAuthSubmit = handleAuthSubmit;
        window.handleLogout = async () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await signOut(auth);
                showMessage('အောင်မြင်စွာ ထွက်ခွာခဲ့ပြီးပါပြီ။');
            } catch (error) {
                showMessage('ထွက်ခွာရန် အမှားရှိသည်', 'error');
            }
        };
        window.toggleRateDirection = () => {
            transferDirection = transferDirection === 'THB_TO_MMK' ? 'MMK_TO_THB' : 'THB_TO_MMK';
            renderHome();
        };
        window.updateRates = updateRates;
        window.showScreen = (screenName) => {
            if (!isAuthReady) return;
            if (screenName === 'admin' && !isAdmin) screenName = 'home';
            
            currentScreen = screenName;
            const content = document.getElementById('content-area');
            
            // Reset and set active nav
            document.querySelectorAll('.nav-button').forEach(btn => {
                if (btn.id !== 'admin-nav-button') {
                    btn.classList.remove('text-emerald-400');
                    btn.classList.add('text-gray-400');
                }
            });
            
            const activeBtn = document.querySelector(`[onclick="showScreen('${screenName}')"]`);
            if (activeBtn) {
                if (screenName === 'admin') {
                    activeBtn.classList.add('text-red-400');
                } else {
                    activeBtn.classList.add('text-emerald-400');
                }
            }

            content.innerHTML = `<p class="text-center text-gray-500">ဒေတာများ ဆွဲယူနေပါသည်...</p>`;

            switch (screenName) {
                case 'home': renderHome(); break;
                case 'transfer': renderTransfer(); break;
                case 'inbox': renderInbox(); break;
                case 'profile': renderProfile(); break;
                case 'admin': renderAdminPanel(); break;
                default: renderHome();
            }
        };

    </script>
</body>
</html>
