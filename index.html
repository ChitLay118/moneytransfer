<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pyidaungsu&display=swap" rel="stylesheet">
    <style>
        body {font-family:'Pyidaungsu','Inter',sans-serif;background:#1f2937;color:#f3f4f6;}
        .card {background:#374151;border:1px solid #4b5563;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.3);}
        .btn-primary {background:#10B981;color:#fff;padding:0.75rem 1.5rem;border-radius:0.5rem;font-weight:600;}
        .btn-primary:hover {background:#059669;}
        .scrollable {height:calc(100vh - 120px);overflow-y:auto;-ms-overflow-style:none;scrollbar-width:none;}
        .scrollable::-webkit-scrollbar {display:none;}
        .tab-active {border-bottom:3px solid #10B981;color:#10B981;font-weight:600;}
        .grid-2 {display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
    </style>
</head>
<body class="min-h-screen">

<div id="loading" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-emerald-500 mx-auto"></div>
        <p class="mt-4 text-white">ဒေတာများ ဆွဲယူနေပါသည်...</p>
    </div>
</div>

<div id="msg" class="fixed top-4 right-4 z-50"></div>

<div id="auth" class="min-h-screen flex items-center justify-center p-4"></div>

<div id="app" class="max-w-xl mx-auto min-h-screen flex flex-col hidden">
    <header class="p-6 text-center">
        <h1 class="text-2xl font-bold">ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)</h1>
        <p id="user-info" class="text-sm text-gray-400 mt-1">Loading...</p>
    </header>

    <main id="content" class="flex-grow p-4 scrollable"></main>

    <nav class="sticky bottom-0 bg-gray-800 border-t border-gray-700 p-3">
        <div class="flex justify-around" id="nav"></div>
    </nav>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAUL74mqVCIY1MMclrRhdVbY_VyP4lgQpY",
    authDomain: "waiappstore.firebaseapp.com",
    projectId: "waiappstore",
    storageBucket: "waiappstore.firebasestorage.app",
    messagingSenderId: "161610339691",
    appId: "1:161610339691:web:ce59fafb6a21729030682e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const APP_ID = 'thai-myanmar-remittance';
const ADMIN_EMAIL = 'c388925@gmail.com';

let userId, isAdmin = false;
let rates = { THB_TO_MMK:121.95, rateHomeTHBtoMMK:820, rateHomeMMKtoTHB:750 };
let mpImages = {i1:'',i2:'',i3:'',i4:''};

const loading = document.getElementById('loading');
const msgBox = document.getElementById('msg');

const showMsg = (text,type='success') => {
    const el = document.createElement('div');
    el.className = type==='success'?'bg-emerald-600':'bg-red-600';
    el.classList.add('text-white','px-4','py-2','rounded-lg','mb-2','shadow-lg');
    el.textContent = text;
    msgBox.prepend(el);
    setTimeout(()=>el.remove(),5000);
};

const uploadImg = async file => {
    const f = new FormData();
    f.append('file',file);
    f.append('upload_preset','waiyansoe118234');
    const r = await fetch('https://api.cloudinary.com/v1_1/waiyansoe/image/upload', {method:'POST',body:f});
    const d = await r.json();
    return d.secure_url;
};

// Auth
const authDiv = document.getElementById('auth');
const renderLogin = (login=true) => {
    authDiv.innerHTML = `
        <div class="card p-8 max-w-sm w-full">
            <h2 class="text-3xl font-bold text-center text-emerald-400 mb-8">${login?'အကောင့်ဝင်ရန်':'အကောင့်ဖွင့်ရန်'}</h2>
            <form id="authForm">
                ${!login?`<input type="text" id="name" placeholder="အမည်" required class="w-full p-3 rounded border mb-4 w-full">`:''}
                <input type="email" id="email" placeholder="email@gmail.com" required class="w-full p-3 rounded border mb-4">
                <input type="password" id="pass" placeholder="လျှို့ဝှက်နံပါတ်" required class="w-full p-3 rounded border mb-6">
                <button type="submit" class="btn-primary w-full">${login?'ဝင်ရန်':'ဖွင့်ရန်'}</button>
            </form>
            <p class="text-center mt-4 text-sm"><a href="#" onclick="renderLogin(${!login})" class="text-blue-400">
                ${login?'အကောင့်မရှိသေးဘူးလား? ဖွင့်ရန်':'အကောင့်ရှိပြီးသားလား? ဝင်ရန်'}
            </a></p>
        </div>`;
    document.getElementById('authForm').onsubmit = async e => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        try {
            if(login) await signInWithEmailAndPassword(auth,email,pass);
            else {
                const name = document.getElementById('name').value;
                const cred = await createUserWithEmailAndPassword(auth,email,pass);
                await updateProfile(cred.user,{displayName:name});
            }
        } catch(err) { showMsg(err.message,'error'); }
    };
};
renderLogin();

// Main App
onAuthStateChanged(auth, user => {
    if(user){
        userId = user.uid;
        isAdmin = user.email===ADMIN_EMAIL;
        document.getElementById('user-info').textContent = `${user.displayName||user.email}`;
        document.getElementById('auth').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        loading.classList.add('hidden');
        initApp();
    } else {
        document.getElementById('app').classList.add('hidden');
        authDiv.classList.remove('hidden');
        loading.classList.add('hidden');
        renderLogin();
    }
});

const initApp = () => {
    // Rates
    onSnapshot(doc(db,`artifacts/${APP_ID}/public/data/rates/current`), snap=>{
        if(snap.exists()){
            const d = snap.data();
            rates.THB_TO_MMK = d.THB_TO_MMK||121.95;
            rates.rateHomeTHBtoMMK = d.rateHomeTHBtoMMK||820;
            rates.rateHomeMMKtoTHB = d.rateHomeMMKtoTHB||750;
        }
        if(currentPage==='home') home();
    });

    // MyanmarPay Images
    onSnapshot(doc(db,`artifacts/${APP_ID}/public/data/config/myanmarPay`), snap=>{
        if(snap.exists()){
            const d = snap.data();
            mpImages = {i1:d.i1||'',i2:d.i2||'',i3:d.i3||'',i4:d.i4||''};
        }
        if(currentPage==='home') home();
    });

    nav();
    home();
};

let currentPage = 'home';
const content = document.getElementById('content');

const nav = () => {
    const n = document.getElementById('nav');
    n.innerHTML = `
        <button onclick="home()" class="flex flex-col items-center p-2 ${currentPage==='home'?'text-emerald-400':''}"><i class="fas fa-home text-xl"></i><span class="text-xs mt-1">ပင်မစာမျက်နှာ</span></button>
        <button onclick="transfer()" class="flex flex-col items-center p-2 ${currentPage==='transfer'?'text-emerald-400':''}"><i class="fas fa-paper-plane text-xl"></i><span class="text-xs mt-1">ငွေလွှဲရန်</span></button>
        ${isAdmin?`<button onclick="admin()" class="flex flex-col items-center p-2 text-red-400"><i class="fas fa-cog text-xl"></i><span class="text-xs mt-1">စီမံ</span></button>`:''}
    `;
};

const home = () => {
    currentPage = 'home';
    nav();
    const thb1 = Math.round(100000 / rates.rateHomeTHBtoMMK);
    const thb2 = Math.round(100000 / rates.rateHomeMMKtoTHB);
    content.innerHTML = `
        <div class="space-y-6">
            <div class="text-center">
                <p class="text-3xl font-bold text-emerald-400">ငွေလဲနှုန်း</p>
            </div>

            <!-- Home Delivery နှစ်ဖက်လုံး -->
            <div class="card p-6 border-2 border-red-500/50">
                <h2 class="text-xl font-bold text-red-400 text-center mb-6">အိမ်သို့ ငွေလွဲရန် (Home Delivery)</h2>
                <div class="grid grid-cols-3 items-center text-center text-2xl font-bold">
                    <div>${thb1} ဘတ်</div>
                    <i class="fas fa-left-right text-red-400"></i>
                    <div>100,000 ကျပ်</div>
                </div>
                <div class="grid grid-cols-3 items-center text-center text-2xl font-bold mt-6">
                    <div>100,000 ကျပ်</div>
                    <i class="fas fa-left-right text-red-400"></i>
                    <div>${thb2} ဘတ်</div>
                </div>
            </div>

            <!-- Account Transfer -->
            <div class="card p-6">
                <h2 class="text-xl font-bold text-emerald-400">အကောင့်သို့ ငွေလွဲရန်</h2>
                <div class="text-2xl text-center my-4">
                    ${(100000/rates.THB_TO_MMK).toFixed(0)} ဘတ် <i class="fas fa-arrow-right mx-4"></i> 100,000 ကျပ်
                </div>
            </div>

            <!-- MyanmarPay ၄ ပုံ -->
            <div class="card p-6">
                <h2 class="text-xl font-bold text-blue-400 mb-4">MyanmarPay ဘဏ်အချက်အလကာ</h2>
                <div class="grid-2">
                    ${[mpImages.i1,mpImages.i2,mpImages.i3,mpImages.i4].map(url=> url?`<div><img src="${url}" class="rounded-lg"><button onclick="download('${url}')" class="w-full mt-2 btn-primary text-sm py-1">Save</button></div>`:'').join('')}
                </div>
                ${isAdmin ? `
                    <div class="mt-6 pt-6 border-t">
                        <p class="font-bold text-blue-400 mb-3">MyanmarPay ပုံများ ပြင်ဆင်ရန်</p>
                        ${[1,2,3,4].map(i=>`<input type="file" id="mp${i}" accept="image/*" class="mb-2 w-full">`).join('')}
                        <button onclick="saveMPImages()" class="btn-primary w-full mt-3">အပ်ဒိတ်လုပ်ရန်</button>
                    </div>` : ''}
            </div>

            ${isAdmin?adminRatePanel():''}
        </div>`;
};

const adminRatePanel = () => `
    <div class="card p-6 border-2 border-red-500/50 mt-8">
        <h3 class="text-xl font-bold text-red-400 mb-4">နှုန်းထားများ ပြင်ဆင်ရန်</h3>
        <div class="space-y-4">
            <div><label>အကောင့်သို့ (၁သိန်းရရန် ဘတ်)</label><input type="number" id="accRate" value="${(100000/rates.THB_TO_MMK).toFixed(0)}" class="w-full p-2 rounded border"></div>
            <div><label>အိမ်သို့ ထိုင်းမှမြန်မာ (၁သိန်းရရန် ဘတ်)</label><input type="number" id="home1" value="${rates.rateHomeTHBtoMMK}" class="w-full p-2 rounded border"></div>
            <div><label>အိမ်သို့ မြန်မာမှထိုင်း (၁သိန်းပေးရန် ဘတ်ရမည်)</label><input type="number" id="home2" value="${rates.rateHomeMMKtoTHB}" class="w-full p-2 rounded border"></div>
            <button onclick="saveRates()" class="btn-primary w-full">သိမ်းရန်</button>
        </div>
    </div>`;

window.saveRates = async () => {
    const a = parseFloat(document.getElementById('accRate').value);
    const h1 = parseFloat(document.getElementById('home1').value);
    const h2 = parseFloat(document.getElementById('home2').value);
    await setDoc(doc(db,`artifacts/${APP_ID}/public/data/rates/current`),{
        THB_TO_MMK:100000/a,
        rateHomeTHBtoMMK:h1,
        rateHomeMMKtoTHB:h2,
        lastUpdated:serverTimestamp()
    },{merge:true});
    showMsg('နှုန်းထားများ သိမ်းပြီးပါပြီ');
};

window.saveMPImages = async () => {
    const files = [1,2,3,4].map(i=>document.getElementById(`mp${i}`).files[0]).filter(Boolean);
    if(!files.length) return showMsg('ပုံအနည်းဆုံး ၁ ပုံ ရွေးပါ','error');
    loading.classList.remove('hidden');
    const urls = await Promise.all(files.map(uploadImg));
    const obj = {};
    urls.forEach((u,i)=> obj[`i${files.indexOf(u)+1}`] = u);
    await setDoc(doc(db,`artifacts/${APP_ID}/public/data/config/myanmarPay`),obj,{merge:true});
    loading.classList.add('hidden');
    showMsg('MyanmarPay ပုံများ အပ်ဒိတ်ပြီးပါပြီ');
};

window.download = url => {
    fetch(url).then(r=>r.blob()).then(b=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'image.png';
        a.click();
    });
};

// ကျန်တဲ့ စာမျက်နှာများ (ငွေလွှဲရန်၊ admin panel စသည်) ကို လိုအပ်သလို ထပ်ထည့်ပေးနိုင်ပါသည်။

</script>
</body>
</html>
