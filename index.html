<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #10B981; /* Emerald 500 */
            --primary-dark: #059669; /* Emerald 600 */
            --bg-dark: #1f2937;
            --text-dark: #f3f4f6;
        }

        /* Enforce Dark Mode */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: #374151; /* Gray 700 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
            border: 1px solid #4b5563;
        }

        input, select, textarea {
            background-color: #4b5563; /* Gray 600 */
            color: var(--text-dark);
            border-color: #6b7280;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .scrollable-content {
            height: calc(100vh - 120px); 
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollable-content::-webkit-scrollbar {
            display: none;
        }
        
        .tab-button.active {
            border-bottom-width: 3px;
            border-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Global Modals and Overlays -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
            <p class="mt-4 text-white text-lg" id="loading-text">ဒေတာများ ဆွဲယူနေပါသည်...</p>
        </div>
    </div>
    
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-transform duration-300 transform translate-x-full"></div>

    <!-- Login/Sign Up Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <!-- Auth UI will be rendered here -->
    </div>
    
    <!-- Main App Content (Hidden until authenticated) -->
    <div id="app-content-wrapper" class="max-w-xl mx-auto min-h-screen flex flex-col hidden">
        <!-- Header -->
        <header id="app-header" class="p-4 pt-6 text-center">
            <h1 class="text-2xl font-extrabold" id="app-title">ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)</h1>
            <p id="user-info" class="text-sm mt-1 text-gray-500">Loading user...</p>
            <!-- Admin button is now in the footer navigation -->
        </header>

        <!-- Content Area -->
        <main id="content-area" class="flex-grow p-4 scrollable-content">
            <!-- Content will be rendered here based on the current screen -->
        </main>

        <!-- Navigation Footer -->
        <footer id="nav-footer" class="sticky bottom-0 w-full max-w-xl mx-auto bg-gray-800 border-t border-gray-700 p-2 shadow-lg">
            <div class="flex justify-around text-xs font-medium" id="nav-container">
                <!-- Nav items will be generated here -->
            </div>
        </footer>
    </div>
    
    <!-- Appwrite SDK and Logic -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script type="module">
        // --- Appwrite Imports ---
        const { Client, Account, Databases, Storage } = Appwrite;
        
        // --- Global Variables and Constants ---
        const ADMIN_EMAIL = 'c388925@gmail.com';
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Appwrite Configuration
        const APPWRITE_CONFIG = {
            endpoint: 'https://sgp.cloud.appwrite.io/v1',
            projectId: '692ab4ee0030433b4b61',
            databaseId: '692abb320000cc971136',
            transferCollectionId: 'wai118234',
            userCollectionId: 'yan118234',
            notificationCollectionId: 'soe118234',
            storageBucketId: 'waiyansoe118234',
            adminApiKey: 'standard_69074ed91e0a2b3ef3040bfbc0bfc36d473a6713582827d874f3b8bf3d8943f12f581e2b85c333cc7320bb78a726b98871605cd9448dd8f9b155cf388ccf7e239e409921aa9f1453a91eb94b57fd6968fa0c37c0bc97547cc7dca4b191745d97a93ce7a87396ecbf2ef9b9504107468863699eb011853439cdf508e548ebe367'
        };
        
        let client;
        let account;
        let databases;
        let storage;
        let userId = null;
        let userEmail = null;
        let isAdmin = false;
        let currentScreen = 'home';
        let isAuthReady = false;
        let currentTransferTab = 'account'; 

        // State for rates
        let currentRates = {
            THB_TO_MMK: 121.95, 
            MMK_TO_THB: 126.58, 
            rateHomeDeliveryTHB: 820, 
            lastUpdated: 'Loading...'
        };
        let adminBankInfo = {
            image1URL: 'https://placehold.co/200x100/10B981/ffffff?text=Bank+QR+1',
            image2URL: 'https://placehold.co/200x100/60A5FA/ffffff?text=Bank+QR+2'
        };
        let transferDirection = 'THB_TO_MMK'; 
        let userTransfers = [];
        let adminTransfers = [];
        let userNotifications = [];
        
        // --- Internationalization (I18N) ---
        const I18N = {
            my: {
                appTitle: 'ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)',
                loading: 'ဒေတာများ ဆွဲယူနေပါသည်...',
                home: 'ငွေလဲနှုန်း',
                transfer: 'ငွေလွဲရန်',
                inbox: 'အဝင်စာ',
                profile: 'Profile',
                adminPanel: 'စီမံခန့်ခွဲမှု', 
                rateTitle: 'ငွေလဲနှုန်း (၁ ဘတ်လျှင် မြန်မာကျပ်)',
                homeDeliveryRateTitle: 'အိမ်သို့ ငွေလွဲရန် (Home Delivery Rate)', 
                thbToMmk: 'ထိုင်းမှ',
                mmkToThb: 'မြန်မာမှ',
                thb: 'ဘတ်',
                mmk: 'ကျပ်',
                transferAccountTab: 'အကောင့်သို့ ငွေလွဲရန်',
                transferHomeTab: 'အိမ်အရောက် ပို့ရန်',
                bankInfo: 'Admin ၏ ငွေလွဲမည့် ဘဏ်အချက်အလက်',
                bankImage: 'ဘဏ်ပုံ',
                download: 'ပုံကို Save',
                pending: 'စစ်ဆေးဆဲ',
                completed: 'အောင်မြင်',
                adminPendingTitle: 'Admin စစ်ဆေးဆဲ စာရင်း',
                adminDetailTitle: 'ငွေလွဲမှု အသေးစိတ်',
                reply: 'စာ/ပုံ ပြန်ပို့ရန်',
                typeAccount: 'အကောင့်သို့ ငွေလွဲ',
                typeHome: 'အိမ်အရောက် ပို့ရန်',
            }
            // English strings omitted for brevity as the request is Burmese-focused
        };
        let currentLang = 'my'; // Enforce Burmese as default
        const t = (key) => I18N[currentLang][key] || key;

        // --- Utility Functions ---

        const showMessage = (msg, type = 'success') => {
            const box = document.getElementById('message-box');
            const color = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
            const html = `
                <div class="${color} text-white p-3 rounded-lg shadow-xl mb-3 text-sm" style="min-width: 250px;">
                    ${msg}
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const messageElement = tempDiv.firstChild;
            
            box.prepend(messageElement);
            box.classList.remove('translate-x-full');
            box.classList.add('translate-x-0');

            setTimeout(() => {
                messageElement.remove();
                if (box.children.length === 0) {
                    box.classList.remove('translate-x-0');
                    box.classList.add('translate-x-full');
                }
            }, 5000);
        };
        
        const downloadImage = (url) => {
            fetch(url, { mode: 'cors' })
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = `remittance_image_${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(blobUrl);
                    showMessage('ပုံကို အောင်မြင်စွာ သိမ်းဆည်းပြီးပါပြီ။');
                })
                .catch(error => {
                    console.error("Download error:", error);
                    showMessage('ပုံဒေါင်းလုတ်ဆွဲရာတွင် အမှားရှိပါသည်', 'error');
                });
        };
        window.downloadImage = downloadImage;

        // --- Appwrite Initialization and Auth ---

        const initAppwrite = async () => {
            try {
                client = new Client()
                    .setEndpoint(APPWRITE_CONFIG.endpoint)
                    .setProject(APPWRITE_CONFIG.projectId);
                
                account = new Account(client);
                databases = new Databases(client);
                storage = new Storage(client);
                
                // Set admin API key for server-side operations
                client.setKey(APPWRITE_CONFIG.adminApiKey);
                
                // Check if user is already logged in
                try {
                    const user = await account.get();
                    handleAuthStateChange(user);
                } catch (error) {
                    // User is not logged in
                    handleAuthStateChange(null);
                }
                
                // Show loading initially
                document.getElementById('loading-overlay').classList.remove('hidden');

            } catch (error) {
                console.error("Appwrite Initialization Error:", error);
                document.getElementById('loading-overlay').classList.add('hidden');
                showMessage(`Appwrite အမှား: ${error.message}`, 'error');
            }
        };

        const handleAuthStateChange = (user) => {
            if (user) {
                userId = user.$id;
                userEmail = user.email;
                isAdmin = user.email === ADMIN_EMAIL;
                
                document.getElementById('user-info').textContent = `${user.name || user.email} (ID: ${userId.substring(0, 8)}...)`;
                // Admin button is now handled in updateStaticText/nav bar
                
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-content-wrapper').classList.remove('hidden');

                if (!isAuthReady) {
                    isAuthReady = true;
                    updateStaticText();
                    loadRates();
                    loadAdminBankInfo();
                    loadTransfers();
                    loadNotifications();
                    showScreen('home'); 
                } else {
                    // Only update navigation if admin status changes (shouldn't happen post-login, but good for safety)
                    updateStaticText(); 
                }
            } else {
                isAuthReady = false;
                userId = null;
                userEmail = null;
                isAdmin = false;
                document.getElementById('app-content-wrapper').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                renderAuthScreen();
            }
            document.getElementById('loading-overlay').classList.add('hidden');
        };

        const renderAuthScreen = (isLogin = true) => {
            const authScreen = document.getElementById('auth-screen');
            authScreen.innerHTML = `
                <div class="card w-full max-w-sm p-8 rounded-xl space-y-6">
                    <h2 class="text-3xl font-bold text-center text-emerald-400">${isLogin ? 'အကောင့်ဝင်ရန်' : 'အကောင့်ဖွင့်ရန်'}</h2>
                    
                    <form id="auth-form" onsubmit="event.preventDefault(); handleAuthSubmit(${isLogin})">
                        ${!isLogin ? `
                            <div>
                                <label for="username" class="block text-sm font-medium mb-1">Username</label>
                                <input type="text" id="username" required class="w-full p-3 border rounded-lg" placeholder="သင့်အမည်">
                            </div>` : ''}
                        <div>
                            <label for="email" class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" id="email" required class="w-full p-3 border rounded-lg" placeholder="example@gmail.com">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="password" required class="w-full p-3 border rounded-lg" placeholder="လျှို့ဝှက်နံပါတ် (၆ လုံးအထက်)">
                        </div>
                        
                        <button type="submit" class="btn-primary w-full py-3 rounded-lg mt-4 font-bold">
                            ${isLogin ? 'အကောင့်ဝင်ရန်' : 'အကောင့်ဖွင့်ရန်'}
                        </button>
                    </form>
                    
                    <button onclick="renderAuthScreen(!${isLogin})" class="w-full text-sm text-center text-blue-400 hover:text-blue-300">
                        ${isLogin ? 'အကောင့်မရှိသေးဘူးလား? အကောင့်ဖွင့်ရန်' : 'အကောင့်ရှိပြီးသားလား? အကောင့်ဝင်ရန်'}
                    </button>
                </div>
            `;
        };
        window.renderAuthScreen = renderAuthScreen;
        
        const handleAuthSubmit = async (isLogin) => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = isLogin ? null : document.getElementById('username').value;
            
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                if (isLogin) {
                    await account.createEmailSession(email, password);
                    const user = await account.get();
                    handleAuthStateChange(user);
                    showMessage('အကောင့်ဝင်ခြင်း အောင်မြင်ပါသည်။');
                } else {
                    await account.create(email, password, username);
                    await account.createEmailSession(email, password);
                    const user = await account.get();
                    handleAuthStateChange(user);
                    showMessage('အကောင့်ဖွင့်ခြင်း အောင်မြင်ပါသည်။');
                }
            } catch (error) {
                console.error("Auth Error:", error);
                let msg = 'အမှားရှိသည်';
                if (error.code === 400) msg = 'Email သို့မဟုတ် Password မှားယွင်းနေသည်။';
                else if (error.code === 409) msg = 'ဤ Email ဖြင့် အကောင့်ဖွင့်ထားပြီးဖြစ်သည်။';

                showMessage(msg, 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };
        window.handleAuthSubmit = handleAuthSubmit;

        const handleLogout = async () => {
             document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await account.deleteSession('current');
                handleAuthStateChange(null);
                showMessage('အောင်မြင်စွာ ထွက်ခွာခဲ့ပြီးပါပြီ။');
            } catch (error) {
                 showMessage('ထွက်ခွာရန် အမှားရှိသည်', 'error');
            }
        };
        window.handleLogout = handleLogout;

        // --- Appwrite Data Handlers & Paths ---

        const PUBLIC_DATA_PATH = 'public';
        const USER_DATA_PATH = (uid) => `users/${uid}`;

        const updateStaticText = () => {
            const adminButtonHtml = isAdmin ? `
                <button onclick="showScreen('admin')" id="admin-nav-button" class="nav-button flex flex-col items-center p-2 rounded-lg text-red-400 hover:text-red-300">
                    <i class="fa-solid fa-screwdriver-wrench text-xl"></i>
                    <span class="mt-1">${t('adminPanel')}</span>
                </button>
            ` : '';

            // Navigation buttons update
            const navContainer = document.getElementById('nav-container');
            navContainer.innerHTML = `
                <button onclick="showScreen('home')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-exchange-alt text-xl"></i>
                    <span class="mt-1">${t('home')}</span>
                </button>
                <button onclick="showScreen('transfer')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-paper-plane text-xl"></i>
                    <span class="mt-1">${t('transfer')}</span>
                </button>
                <button onclick="showScreen('inbox')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500 relative">
                    <i class="fa-solid fa-inbox text-xl"></i>
                    <span id="inbox-badge" class="absolute top-0 right-0 inline-block w-3 h-3 bg-red-500 rounded-full hidden"></span>
                    <span class="mt-1">${t('inbox')}</span>
                </button>
                <button onclick="showScreen('profile')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-user-gear text-xl"></i>
                    <span class="mt-1">${t('profile')}</span>
                </button>
                ${adminButtonHtml} <!-- Admin button is now here -->
            `;
            showScreen(currentScreen);
        };
        
        // --- Rate and Bank Info Management ---

        const loadRates = () => {
            // Using Appwrite to fetch rates
            const fetchRates = async () => {
                try {
                    const response = await databases.getDocument(
                        APPWRITE_CONFIG.databaseId,
                        PUBLIC_DATA_PATH,
                        'rates'
                    );
                    
                    if (response) {
                        const data = response;
                        currentRates.THB_TO_MMK = data.rateBuyMMK || 121.95; 
                        currentRates.MMK_TO_THB = data.rateBuyTHB || 126.58; 
                        currentRates.rateHomeDeliveryTHB = data.rateHomeDeliveryTHB || 820; 
                        
                        const timestamp = data.lastUpdated;
                        if (timestamp) {
                            const date = new Date(timestamp);
                            currentRates.lastUpdated = date.toLocaleString('my-MM', {
                                year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
                            });
                        } else {
                            currentRates.lastUpdated = 'ယခုလေးတင်';
                        }
                        if (currentScreen === 'home') renderHome(); 
                    }
                } catch (error) {
                    console.error("Error fetching rates: ", error);
                    // Create default rates if they don't exist
                    if (error.code === 404) {
                        try {
                            await databases.createDocument(
                                APPWRITE_CONFIG.databaseId,
                                PUBLIC_DATA_PATH,
                                'rates',
                                {
                                    rateBuyMMK: currentRates.THB_TO_MMK, 
                                    rateBuyTHB: currentRates.MMK_TO_THB,
                                    rateHomeDeliveryTHB: currentRates.rateHomeDeliveryTHB, 
                                    lastUpdated: new Date().toISOString()
                                }
                            );
                        } catch (createError) {
                            console.error("Error creating rates: ", createError);
                        }
                    }
                }
            };
            
            fetchRates();
            // Set up real-time updates if needed
            // client.subscribe(`databases.${APPWRITE_CONFIG.databaseId}.collections.${PUBLIC_DATA_PATH}.documents.rates`, fetchRates);
        };
        
        const loadAdminBankInfo = () => {
            const fetchBankInfo = async () => {
                try {
                    const response = await databases.getDocument(
                        APPWRITE_CONFIG.databaseId,
                        PUBLIC_DATA_PATH,
                        'bankInfo'
                    );
                    
                    if (response) {
                        const data = response;
                        adminBankInfo.image1URL = data.image1URL || adminBankInfo.image1URL;
                        adminBankInfo.image2URL = data.image2URL || adminBankInfo.image2URL;
                        if (currentScreen === 'home' || currentScreen === 'admin') renderHome();
                    }
                } catch (error) {
                    console.error("Error fetching bank info: ", error);
                    // Create default bank info if it doesn't exist
                    if (error.code === 404) {
                        try {
                            await databases.createDocument(
                                APPWRITE_CONFIG.databaseId,
                                PUBLIC_DATA_PATH,
                                'bankInfo',
                                adminBankInfo
                            );
                        } catch (createError) {
                            console.error("Error creating bank info: ", createError);
                        }
                    }
                }
            };
            
            fetchBankInfo();
        };
        
        // --- Transfers and Notifications ---

        const loadTransfers = () => {
            if (!isAuthReady || !userId) return;
            
            const fetchTransfers = async () => {
                try {
                    const response = await databases.listDocuments(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.transferCollectionId
                    );
                    
                    const transfers = response.documents.map(doc => ({ id: doc.$id, ...doc }));
                    
                    adminTransfers = transfers;
                    adminTransfers.sort((a, b) => {
                        if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                        if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    });

                    userTransfers = transfers.filter(t => t.senderId === userId)
                                             .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    if (currentScreen === 'admin') renderAdminPanel();
                    if (currentScreen === 'profile') renderProfile(); 

                } catch (error) {
                    console.error("Error fetching transfers: ", error);
                }
            };
            
            fetchTransfers();
        };

        const loadNotifications = () => {
            if (!isAuthReady || !userId) return;
            
            const fetchNotifications = async () => {
                try {
                    const response = await databases.listDocuments(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.notificationCollectionId,
                        [
                            `equal("userId", "${userId}")`
                        ]
                    );
                    
                    userNotifications = response.documents.map(doc => ({ id: doc.$id, ...doc }))
                                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    const unreadCount = userNotifications.filter(n => !n.isRead).length;
                    const badge = document.getElementById('inbox-badge');
                    if (badge) {
                         badge.classList.toggle('hidden', unreadCount === 0);
                    }

                    if (currentScreen === 'inbox') renderInbox();
                } catch (error) {
                    console.error("Error fetching notifications: ", error);
                }
            };
            
            fetchNotifications();
        };
        
        const markNotificationAsRead = async (id) => {
            if (!userId) return;
            try {
                await databases.updateDocument(
                    APPWRITE_CONFIG.databaseId,
                    APPWRITE_CONFIG.notificationCollectionId,
                    id,
                    { isRead: true }
                );
            } catch(e) {
                console.error("Error marking as read:", e);
            }
        };
        window.markNotificationAsRead = markNotificationAsRead;

        // --- UI Rendering Functions ---

        const renderHome = () => {
            const lastUpdated = currentRates.lastUpdated;
            const thbAmount_MMK = (100000 / currentRates.THB_TO_MMK).toFixed(2);
            const thbAmount_THB = (100000 / currentRates.MMK_TO_THB).toFixed(2);
            const thbHomeDelivery = currentRates.rateHomeDeliveryTHB; 
            const rateHomeDelivery = 100000 / thbHomeDelivery;

            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="space-y-6">
                    <p class="text-sm font-semibold text-emerald-400">${t('rateTitle')}</p>
                    <p class="text-xs text-gray-400">နောက်ဆုံး အပ်ဒိတ်: ${lastUpdated}</p>

                    <!-- Home Delivery Rate Card (Updated Title) -->
                    <div class="card p-6 rounded-xl space-y-4 border border-red-500/50">
                        <h2 class="text-lg font-bold text-red-400">${t('homeDeliveryRateTitle')} (${t('thbToMmk')}သာ)</h2>
                        <div class="flex items-center justify-between p-4 bg-gray-600 rounded-xl">
                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300">${t('thb')}</p>
                                <p class="text-2xl font-bold text-gray-50 mt-1">${thbHomeDelivery} ${t('thb')}</p>
                            </div>
                            <i class="fa-solid fa-arrow-right text-2xl text-red-400"></i>
                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300">${t('mmk')}</p>
                                <p class="text-2xl font-bold text-gray-50 mt-1">100,000 ${t('mmk')}</p>
                            </div>
                        </div>
                        <p class="text-sm text-center text-gray-200">
                             ၁ ဘတ် = ${rateHomeDelivery.toFixed(2)} ${t('mmk')}
                        </p>
                    </div>

                    <!-- Account Transfer Rate Card (Same as before) -->
                    <div class="card p-6 rounded-xl space-y-4">
                        <h2 class="text-lg font-bold text-emerald-400">${t('transferAccountTab')}</h2>
                        <!-- Display Panel with toggle logic... -->
                        <div class="flex items-center justify-between p-4 bg-gray-600 rounded-xl">
                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300" id="currency-from">
                                    ${transferDirection === 'THB_TO_MMK' ? t('thbToMmk') : t('mmkToThb')}
                                </p>
                                <p class="text-xl font-bold text-gray-50 mt-1">
                                    ${transferDirection === 'THB_TO_MMK' ? `${thbAmount_MMK} ${t('thb')}` : `100,000 ${t('mmk')}`}
                                </p>
                            </div>

                            <button onclick="toggleRateDirection()" class="text-2xl text-emerald-400 transition-transform duration-300">
                                <i class="fa-solid fa-arrows-left-right"></i>
                            </button>

                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300" id="currency-to">
                                    ${transferDirection === 'THB_TO_MMK' ? t('mmk') : t('thb')}
                                </p>
                                <p class="text-xl font-bold text-gray-50 mt-1">
                                    ${transferDirection === 'THB_TO_MMK' ? `100,000 ${t('mmk')}` : `${thbAmount_THB} ${t('thb')}`}
                                </p>
                            </div>
                        </div>
                        <div class="text-center pt-2">
                             <p class="text-sm font-bold text-gray-200">
                                ${transferDirection === 'THB_TO_MMK' ? '၁ ဘတ် = ' + currentRates.THB_TO_MMK.toFixed(2) + ' ကျပ်' : '၁ ဘတ် = ' + currentRates.MMK_TO_THB.toFixed(2) + ' ကျပ်'}
                            </p>
                        </div>
                    </div>

                    <!-- Admin Bank QR/Image Section (New) -->
                    ${renderAdminBankInfo()}
                    
                    ${isAdmin ? renderAdminRatePanel() : ''}
                </div>
            `;
        };
        window.renderHome = renderHome;
        
        const renderAdminBankInfo = () => {
            return `
                <div class="card p-5 rounded-xl border border-blue-400/50">
                    <h2 class="text-xl font-bold text-blue-400 mb-3">${t('bankInfo')}</h2>
                    <div class="grid grid-cols-2 gap-4">
                        ${renderBankImage(adminBankInfo.image1URL, 'ဘဏ်ပုံ (၁)', 'bankImage1')}
                        ${renderBankImage(adminBankInfo.image2URL, 'ဘဏ်ပုံ (၂)', 'bankImage2')}
                    </div>
                     ${isAdmin ? renderAdminBankUpdateForm() : ''}
                </div>
            `;
        };

        const renderBankImage = (url, alt, id) => {
            return `
                <div class="space-y-2">
                    <img id="${id}" src="${url}" onerror="this.src='https://placehold.co/200x100/374151/ffffff?text=${alt}'" class="w-full rounded-lg object-cover border border-gray-600" alt="">
                    <button onclick="downloadImage('${url}')" class="w-full flex items-center justify-center p-2 text-xs bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                        <i class="fa-solid fa-download mr-2"></i> ${t('download')}
                    </button>
                </div>
            `;
        };

        const renderAdminRatePanel = () => {
            return `
                <div class="card p-5 rounded-xl border border-red-400/50">
                    <h2 class="text-xl font-bold text-red-400 mb-3">Admin: ငွေလဲနှုန်းများ ပြင်ဆင်ရန်</h2>
                    <form id="rate-update-form" onsubmit="event.preventDefault(); updateRates()" class="space-y-3">
                        <div>
                            <label for="rateBuyMMKInput" class="block text-sm font-medium">ထိုင်းမှမြန်မာ (၁ ဘတ်လျှင် ကျပ်)</label>
                            <input type="number" id="rateBuyMMKInput" step="0.01" value="${currentRates.THB_TO_MMK}" required class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="rateBuyTHBInput" class="block text-sm font-medium">မြန်မာမှထိုင်း (၁ ဘတ်လျှင် ကျပ်)</label>
                            <input type="number" id="rateBuyTHBInput" step="0.01" value="${currentRates.MMK_TO_THB}" required class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="rateHomeDeliveryTHBInput" class="block text-sm font-medium">အိမ်အရောက်ပို့ (၁ သိန်းရရန် ဘတ်)</label>
                            <input type="number" id="rateHomeDeliveryTHBInput" step="0.01" value="${currentRates.rateHomeDeliveryTHB}" required class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                        <button type="submit" class="btn-primary w-full py-2 rounded-lg font-semibold">နှုန်းထားများ အပ်ဒိတ်လုပ်ရန်</button>
                    </form>
                </div>
            `;
        };

        const updateRates = async () => {
            if (!isAdmin) return showMessage('Admin လုပ်ဆောင်ချက်သာ ဖြစ်သည်', 'error');

            const rateBuyMMK = parseFloat(document.getElementById('rateBuyMMKInput').value);
            const rateBuyTHB = parseFloat(document.getElementById('rateBuyTHBInput').value);
            const rateHomeDeliveryTHB = parseFloat(document.getElementById('rateHomeDeliveryTHBInput').value);
            
            if (isNaN(rateBuyMMK) || isNaN(rateBuyTHB) || isNaN(rateHomeDeliveryTHB)) {
                return showMessage('မှန်ကန်သော နှုန်းထားများကို ဖြည့်သွင်းပါ', 'error');
            }

            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                await databases.updateDocument(
                    APPWRITE_CONFIG.databaseId,
                    PUBLIC_DATA_PATH,
                    'rates',
                    { 
                        rateBuyMMK, 
                        rateBuyTHB,
                        rateHomeDeliveryTHB,
                        lastUpdated: new Date().toISOString()
                    }
                );
                showMessage('နှုန်းထားများ အောင်မြင်စွာ အပ်ဒိတ်လုပ်ပြီးပါပြီ။');
            } catch (e) {
                console.error("Error updating rates: ", e);
                showMessage('နှုန်းထား အပ်ဒိတ်လုပ်ရာတွင် အမှားရှိသည်', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };
        window.updateRates = updateRates;
        
        const renderAdminBankUpdateForm = () => {
            return `
                <form id="bank-image-update-form" onsubmit="event.preventDefault(); updateBankImages()" class="mt-4 pt-4 border-t border-gray-600 space-y-3">
                    <h3 class="text-lg font-semibold text-red-400">Admin: ဘဏ်ပုံများ ပြင်ဆင်ရန်</h3>
                    <div>
                        <label for="bankImage1File" class="block text-sm font-medium">ဘဏ်ပုံ (၁) အပ်လုဒ်</label>
                        <input type="file" id="bankImage1File" accept="image/*" class="mt-1 w-full p-1 border rounded-lg">
                    </div>
                    <div>
                        <label for="bankImage2File" class="block text-sm font-medium">ဘဏ်ပုံ (၂) အပ်လုဒ်</label>
                        <input type="file" id="bankImage2File" accept="image/*" class="mt-1 w-full p-1 border rounded-lg">
                    </div>
                    <button type="submit" class="btn-primary w-full py-2 rounded-lg font-semibold">ပုံများ အပ်ဒိတ်လုပ်ရန်</button>
                </form>
            `;
        };

        const updateBankImages = async () => {
            if (!isAdmin) return showMessage('Admin လုပ်ဆောင်ချက်သာ ဖြစ်သည်', 'error');
            const file1 = document.getElementById('bankImage1File').files[0];
            const file2 = document.getElementById('bankImage2File').files[0];
            
            if (!file1 && !file2) return showMessage('ပုံအသစ် အနည်းဆုံးတစ်ပုံကို ရွေးချယ်ပါ', 'error');

            document.getElementById('loading-overlay').classList.remove('hidden');
            let updatedURLs = {};

            const uploadFile = async (file, slot) => {
                const fileName = `${APP_ID}_bank_${slot}_${Date.now()}.png`;
                const response = await storage.createFile(
                    APPWRITE_CONFIG.storageBucketId,
                    fileName,
                    file
                );
                return storage.getFilePreview(APPWRITE_CONFIG.storageBucketId, response.$id);
            };

            try {
                if (file1) {
                    updatedURLs.image1URL = await uploadFile(file1, '1');
                }
                if (file2) {
                    updatedURLs.image2URL = await uploadFile(file2, '2');
                }

                await databases.updateDocument(
                    APPWRITE_CONFIG.databaseId,
                    PUBLIC_DATA_PATH,
                    'bankInfo',
                    updatedURLs
                );
                showMessage('ဘဏ်ပုံများ အောင်မြင်စွာ အပ်ဒိတ်လုပ်ပြီးပါပြီ။');

            } catch (e) {
                console.error("Error updating bank images: ", e);
                let errorMessage = 'ဘဏ်ပုံ အပ်ဒိတ်လုပ်ရာတွင် အမှားရှိသည် (သို့) ပုံတင်ရာတွင် ပြဿနာရှိပါသည်။ Console ကို စစ်ဆေးပါ (Security Rules ပြဿနာ ဖြစ်နိုင်သည်)။';
                showMessage(errorMessage, 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };
        window.updateBankImages = updateBankImages;
        
        const toggleRateDirection = () => {
            transferDirection = transferDirection === 'THB_TO_MMK' ? 'MMK_TO_THB' : 'THB_TO_MMK';
            renderHome();
        };
        window.toggleRateDirection = toggleRateDirection;

        // --- Transfer Screen ---

        const renderTransfer = () => {
            const content = document.getElementById('content-area');
            const rateBuyMMK = currentRates.THB_TO_MMK;
            const rateBuyTHB = currentRates.MMK_TO_THB;
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="card p-5 rounded-xl border border-blue-400/50">
                        <h2 class="text-xl font-bold text-blue-400 mb-3">ငွေလွဲမှု အမျိုးအစား</h2>
                        <p class="text-sm text-gray-300 mb-2">Admin မှ ပေးထားသော QR/ဖုန်းနံပါတ်သို့ ငွေပို့ပြီးမှ ဖောင်ဖြည့်ပါ။</p>
                    </div>

                    <!-- Tabs for Transfer Type -->
                    <div class="flex border-b border-gray-700">
                        <button id="tab-account" onclick="setTransferTab('account')" 
                                class="tab-button flex-1 py-3 text-sm font-medium text-gray-400 hover:text-emerald-400 ${currentTransferTab === 'account' ? 'active' : ''}">
                            <i class="fa-solid fa-wallet mr-2"></i> ${t('transferAccountTab')}
                        </button>
                        <button id="tab-home" onclick="setTransferTab('home')" 
                                class="tab-button flex-1 py-3 text-sm font-medium text-gray-400 hover:text-emerald-400 ${currentTransferTab === 'home' ? 'active' : ''}">
                            <i class="fa-solid fa-house-chimney-user mr-2"></i> ${t('transferHomeTab')}
                        </button>
                    </div>

                    <!-- Transfer Form Section -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-xl font-bold mb-4" id="transfer-form-title">${currentTransferTab === 'account' ? t('transferAccountTab') : t('transferHomeTab')} ဖောင်</h2>
                        <form id="transfer-form" onsubmit="event.preventDefault(); submitTransfer('${currentTransferTab}')">
                            <div class="space-y-4">
                                
                                <!-- Transfer Account Selection (ONLY for Account Tab) -->
                                <div id="account-type-field" class="${currentTransferTab === 'account' ? '' : 'hidden'}">
                                    <label for="transferAccountType" class="block text-sm font-medium">ငွေပို့ထားသည့် အကောင့် (ရွေးချယ်ပါ)</label>
                                    <select id="transferAccountType" ${currentTransferTab === 'account' ? 'required' : ''} class="mt-1 w-full p-2 border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                                        <option value="">-- ရွေးချယ်ပါ --</option>
                                        <option value="KayPay">Kay Pay</option>
                                        <option value="WavePay">Wave Pay</option>
                                        <option value="Other">အခြား (Other)</option>
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="senderName" class="block text-sm font-medium">ငွေလွဲမည့်သူအမည်</label>
                                        <input type="text" id="senderName" required class="mt-1 w-full p-2 border rounded-lg" placeholder="Aung Aung">
                                    </div>
                                    <div>
                                        <label for="receiverName" class="block text-sm font-medium">ငွေလက်ခံမည့်သူအမည်</label>
                                        <input type="text" id="receiverName" required class="mt-1 w-full p-2 border rounded-lg" placeholder="Ma Ma">
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="senderPhoneTH" class="block text-sm font-medium">ဖုန်းနံပါတ် (ထိုင်း)</label>
                                        <input type="tel" id="senderPhoneTH" required class="mt-1 w-full p-2 border rounded-lg" placeholder="09xxxxxxxxx">
                                    </div>
                                    <div>
                                        <label for="receiverPhoneMM" class="block text-sm font-medium">ဖုန်းနံပါတ် (မြန်မာ)</label>
                                        <input type="tel" id="receiverPhoneMM" required class="mt-1 w-full p-2 border rounded-lg" placeholder="09xxxxxxxxx">
                                    </div>
                                </div>
                                
                                <!-- Amount Input -->
                                <div>
                                    <label for="amountInput" class="block text-sm font-medium">ငွေလွဲမည့် ပမာဏ</label>
                                    <div class="mt-1 flex rounded-lg shadow-sm">
                                        <select id="amountDirection" onchange="updateCalculatedAmount()" class="p-2 border border-r-0 rounded-l-lg focus:ring-emerald-500 focus:border-emerald-500">
                                            <option value="THB_MMK">ဘတ် ➜ ကျပ်</option>
                                            <option value="MMK_THB">ကျပ် ➜ ဘတ်</option>
                                        </select>
                                        <input type="number" id="amountInput" step="0.01" min="1" required class="flex-grow p-2 border focus:ring-emerald-500 focus:border-emerald-500" placeholder="1000">
                                    </div>
                                    <p id="calculated-amount" class="mt-1 text-sm text-emerald-400 font-medium">
                                        ရရှိမည့်ပမာဏ: 0.00
                                    </p>
                                </div>
                                
                                <!-- Home Delivery Specific Field -->
                                <div id="home-address-field" class="${currentTransferTab === 'home' ? '' : 'hidden'}">
                                    <label for="deliveryAddress" class="block text-sm font-medium text-red-400">ပို့ရမည့်လိပ်စာ (မဖြစ်မနေ)</label>
                                    <textarea id="deliveryAddress" rows="3" ${currentTransferTab === 'home' ? 'required' : ''} class="mt-1 w-full p-2 border rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="လက်ခံမည့်သူ၏ လိပ်စာ အပြည့်အစုံ"></textarea>
                                </div>

                                <!-- Receipt File Upload -->
                                <div>
                                    <label for="receiptFile" class="block text-sm font-medium">ငွေပို့ထားသော စလစ်ပုံ ထည့်ရန် (ပုံဖိုင်)</label>
                                    <input type="file" id="receiptFile" accept="image/*" required class="mt-1 w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-emerald-400 hover:file:bg-gray-500">
                                    <p class="text-xs text-red-400 mt-1">** လွဲပြီးကြောင်း အတည်ပြုရန်အတွက် ပုံဖိုင်ကို မဖြစ်မနေ ထည့်သွင်းပေးရပါမည်။</p>
                                </div>
                                
                            </div>
                            
                            <button type="submit" class="btn-primary w-full py-3 rounded-lg mt-6 text-lg font-semibold">ပို့ရန်</button>
                        </form>
                    </div>
                </div>
            `;
            setTimeout(() => { updateCalculatedAmount(); }, 0);
            document.getElementById('amountInput').addEventListener('input', updateCalculatedAmount);
            document.getElementById('amountDirection').addEventListener('change', updateCalculatedAmount);
        };
        window.renderTransfer = renderTransfer;

        const updateCalculatedAmount = () => {
            const input = parseFloat(document.getElementById('amountInput').value);
            const direction = document.getElementById('amountDirection').value;
            const output = document.getElementById('calculated-amount');
            
            if (isNaN(input) || input <= 0) {
                output.textContent = `ရရှိမည့်ပမာဏ: 0.00`;
                return;
            }

            let result, fromCurrency, toCurrency;
            
            if (direction === 'THB_MMK') {
                result = input * currentRates.THB_TO_MMK;
                fromCurrency = 'ဘတ်';
                toCurrency = 'ကျပ်';
            } else {
                result = input / currentRates.MMK_TO_THB;
                fromCurrency = 'ကျပ်';
                toCurrency = 'ဘတ်';
            }
            
            output.textContent = `${input.toFixed(2)} ${fromCurrency} သည် ရရှိမည့်ပမာဏ: ${result.toFixed(2)} ${toCurrency} ဖြစ်သည်`;
        };
        window.updateCalculatedAmount = updateCalculatedAmount;
        
        const setTransferTab = (tab) => {
            currentTransferTab = tab;
            // Update Tab Styles
            document.getElementById('tab-account').classList.remove('active');
            document.getElementById('tab-home').classList.remove('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Update Form Fields
            document.getElementById('transfer-form-title').textContent = `${tab === 'account' ? t('transferAccountTab') : t('transferHomeTab')} ဖောင်`;
            
            const accountTypeField = document.getElementById('account-type-field');
            const accountTypeInput = document.getElementById('transferAccountType');
            const addressField = document.getElementById('home-address-field');
            const addressInput = document.getElementById('deliveryAddress');

            // Account Type Visibility (Only for 'account' tab)
            if (tab === 'account') {
                accountTypeField.classList.remove('hidden');
                accountTypeInput.setAttribute('required', 'required');
            } else {
                accountTypeField.classList.add('hidden');
                accountTypeInput.removeAttribute('required');
            }
            
            // Address Visibility (Only for 'home' tab)
            if (tab === 'home') {
                addressField.classList.remove('hidden');
                addressInput.setAttribute('required', 'required');
            } else {
                addressField.classList.add('hidden');
                addressInput.removeAttribute('required');
            }
            
            // Update Submission handler
            document.getElementById('transfer-form').onsubmit = (e) => {
                e.preventDefault();
                submitTransfer(currentTransferTab);
            };
        };
        window.setTransferTab = setTransferTab;

        const submitTransfer = async (transferType) => {
            if (!userId) return showMessage('အသုံးပြုသူအချက်အလက် မရှိပါ', 'error');

            const form = document.getElementById('transfer-form');
            const transferAccountType = transferType === 'account' ? document.getElementById('transferAccountType').value : 'N/A';
            const senderName = document.getElementById('senderName').value;
            const senderPhoneTH = document.getElementById('senderPhoneTH').value;
            const receiverName = document.getElementById('receiverName').value;
            const receiverPhoneMM = document.getElementById('receiverPhoneMM').value;
            const amountInput = parseFloat(document.getElementById('amountInput').value);
            const amountDirection = document.getElementById('amountDirection').value;
            const receiptFileInput = document.getElementById('receiptFile');
            const receiptFile = receiptFileInput.files[0];
            
            let deliveryAddress = '';
            if (transferType === 'home') {
                deliveryAddress = document.getElementById('deliveryAddress').value;
            }
            
            if (isNaN(amountInput) || amountInput <= 0 || !receiptFile) {
                return showMessage('ပမာဏ သို့မဟုတ် စလစ်ပုံဖိုင်ကို မှန်ကန်စွာ ဖြည့်သွင်းပါ', 'error');
            }

            let amountTHB, amountMMK;
            if (amountDirection === 'THB_MMK') {
                amountTHB = amountInput;
                amountMMK = amountInput * currentRates.THB_TO_MMK;
            } else {
                amountMMK = amountInput;
                amountTHB = amountInput / currentRates.MMK_TO_THB;
            }

            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                // --- 1. Upload Logic ---
                let receiptImageURL = '';
                const fileExtension = receiptFile.name.split('.').pop();
                const fileName = `${userId}_${Date.now()}_receipt.${fileExtension}`;
                
                const uploadResult = await storage.createFile(
                    APPWRITE_CONFIG.storageBucketId,
                    fileName,
                    receiptFile
                );
                receiptImageURL = storage.getFilePreview(APPWRITE_CONFIG.storageBucketId, uploadResult.$id);

                // --- 2. Appwrite Database Logic ---
                await databases.createDocument(
                    APPWRITE_CONFIG.databaseId,
                    APPWRITE_CONFIG.transferCollectionId,
                    'unique()',
                    {
                        senderId: userId,
                        senderEmail: userEmail,
                        senderName,
                        senderPhoneTH,
                        receiverName,
                        receiverPhoneMM,
                        transferAccountType, 
                        amountTHB: parseFloat(amountTHB.toFixed(2)),
                        amountMMK: parseFloat(amountMMK.toFixed(2)),
                        transferDirection: amountDirection,
                        transferType: transferType, 
                        deliveryAddress: deliveryAddress || 'N/A', 
                        receiptImageURL, 
                        timestamp: new Date().toISOString(),
                        status: 'Pending',
                        adminReply: { message: '', imageURL: '' }
                    }
                );

                form.reset();
                updateCalculatedAmount(); 
                showMessage('ငွေလွဲမှု တောင်းဆိုချက် အောင်မြင်စွာ ပို့ပြီးပါပြီ။');
                showScreen('home');

            } catch (e) {
                console.error("Error in transfer process (Upload or Database): ", e);
                let errorMessage = 'ငွေလွဲမှု တောင်းဆိုချက် ပို့ရာတွင် အမှားရှိပါသည် (သို့) ပုံတင်ရာတွင် ပြဿနာရှိပါသည်။ Console ကို စစ်ဆေးပါ (Security Rules ပြဿနာ ဖြစ်နိုင်သည်)။';
                showMessage(errorMessage, 'error');
            } finally {
                // Ensure loading spinner is always hidden, regardless of success or failure
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };
        window.submitTransfer = submitTransfer;

        // --- Admin Panel Functions ---
        
        const renderAdminPanel = () => {
            if (!isAdmin) return showScreen('home');
            
            const pendingTransfers = adminTransfers.filter(t => t.status === 'Pending');
            const content = document.getElementById('content-area');

            content.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-red-400">${t('adminPendingTitle')} (${pendingTransfers.length})</h2>
                    <p class="text-sm text-gray-400">စစ်ဆေးရန်ကျန်ရှိသော စာရင်းများ</p>

                    <div id="admin-transfers-list" class="space-y-3">
                        ${pendingTransfers.length === 0 ? 
                            '<p class="text-gray-400 p-4 card rounded-lg text-center">စစ်ဆေးရန် ငွေလွဲမှုများ မရှိပါ</p>' :
                            pendingTransfers.map(t => `
                                <div onclick="renderAdminTransferDetail('${t.id}')" class="card p-4 rounded-xl cursor-pointer hover:bg-gray-700 transition duration-150">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-bold text-lg text-emerald-400">${t.senderName || 'N/A'}</p>
                                            <p class="text-xs text-gray-400">${t.senderEmail}</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-sm font-semibold px-2 py-1 rounded-full ${t.transferType === 'home' ? 'bg-red-600' : 'bg-blue-600'} text-white">
                                                ${t.transferType === 'home' ? t('typeHome') : t('typeAccount')}
                                            </span>
                                            <p class="text-xs mt-1">${t.amountTHB} ${t('thb')} ➜ ${t.amountMMK} ${t('mmk')}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        };
        window.renderAdminPanel = renderAdminPanel;

        const renderAdminTransferDetail = (transferId) => {
            const transfer = adminTransfers.find(t => t.id === transferId);
            if (!transfer) return showMessage('အချက်အလက် ရှာမတွေ့ပါ', 'error');

            const content = document.getElementById('content-area');
            const transferTypeLabel = transfer.transferType === 'home' ? t('typeHome') : t('typeAccount');
            const date = transfer.timestamp ? new Date(transfer.timestamp).toLocaleString('my-MM') : 'N/A';
            
            content.innerHTML = `
                <div class="space-y-6">
                    <button onclick="showScreen('admin')" class="text-blue-400 hover:text-blue-300 mb-4"><i class="fa-solid fa-arrow-left mr-2"></i> ${t('adminPanel')} သို့ ပြန်သွားရန်</button>
                    
                    <h2 class="text-2xl font-bold text-red-400">${t('adminDetailTitle')} - (${transferTypeLabel})</h2>
                    <div class="card p-5 rounded-xl space-y-3">
                        <p><strong>ငွေလွဲသူ (Name):</strong> ${transfer.senderName}</p>
                        <p><strong>Email:</strong> ${transfer.senderEmail}</p>
                        <p><strong>Phone (TH):</strong> ${transfer.senderPhoneTH}</p>
                        <p><strong>လက်ခံသူ (Name):</strong> ${transfer.receiverName}</p>
                        <p><strong>Phone (MM):</strong> ${transfer.receiverPhoneMM}</p>
                        <p><strong>Amount:</strong> ${transfer.amountTHB.toFixed(2)} ${t('thb')} ➜ ${transfer.amountMMK.toFixed(2)} ${t('mmk')}</p>
                        <p><strong>Type:</strong> ${transferTypeLabel} (${transfer.transferAccountType})</p>
                        <p class="text-red-400"><strong>ပို့ရမည့်လိပ်စာ:</strong> ${transfer.deliveryAddress || 'N/A'}</p>
                        <p><strong>ရက်စွဲ:</strong> ${date}</p>
                        <p><strong>Status:</strong> <span class="font-bold text-yellow-400">${transfer.status}</span></p>
                    </div>

                    <!-- Receipt Image and Download -->
                    <div class="card p-5 rounded-xl space-y-3">
                        <h3 class="text-xl font-bold mb-2">ငွေပို့စလစ်ပုံ</h3>
                        <img src="${transfer.receiptImageURL}" onerror="this.src='https://placehold.co/400x200/374151/ffffff?text=No+Receipt'" class="w-full rounded-lg object-cover border border-gray-600 max-h-48" alt="[Image of Transfer Receipt]">
                        <button onclick="downloadImage('${transfer.receiptImageURL}')" class="w-full flex items-center justify-center p-2 text-sm bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                            <i class="fa-solid fa-download mr-2"></i> ${t('download')} စလစ်ပုံ
                        </button>
                    </div>

                    <!-- Admin Reply Form -->
                    <div class="card p-5 rounded-xl space-y-3">
                        <h3 class="text-xl font-bold mb-2 text-emerald-400">${t('reply')}</h3>
                        <form id="admin-reply-form" onsubmit="event.preventDefault(); sendAdminReply('${transfer.id}')">
                            <div>
                                <label for="replyMessage" class="block text-sm font-medium">စာသား</label>
                                <textarea id="replyMessage" rows="2" class="mt-1 w-full p-2 border rounded-lg" placeholder="ငွေလွဲမှု အတည်ပြုချက် သို့မဟုတ် မက်ဆေ့ခ်ျ"></textarea>
                            </div>
                            <div>
                                <label for="replyImage" class="block text-sm font-medium">ပုံ ပြန်ပို့ရန် (ရွေးချယ်ရန်)</label>
                                <input type="file" id="replyImage" accept="image/*" class="mt-1 w-full p-2 border rounded-lg file:bg-gray-600 file:text-emerald-400">
                            </div>
                            <button type="submit" class="w-full py-2 rounded-lg font-semibold bg-emerald-600 text-white mt-3 hover:bg-emerald-500">
                                <i class="fa-solid fa-reply mr-2"></i> User သို့ ပြန်ပို့ရန်
                            </button>
                        </form>
                    </div>

                    <!-- Complete Button -->
                    <button onclick="completeTransfer('${transfer.id}')" class="w-full py-3 rounded-lg font-bold bg-green-600 text-white hover:bg-green-500">
                        <i class="fa-solid fa-check-circle mr-2"></i> ငွေလွဲမှု ပြီးဆုံးကြောင်း အတည်ပြုရန်
                    </button>
                </div>
            `;
        };
        window.renderAdminTransferDetail = renderAdminTransferDetail;

        const sendAdminReply = async (transferId) => {
            if (!isAdmin) return;
            const transfer = adminTransfers.find(t => t.id === transferId);
            if (!transfer) return;
            
            const message = document.getElementById('replyMessage').value.trim();
            const imageFile = document.getElementById('replyImage').files[0];

            if (!message && !imageFile) return showMessage('စာ သို့မဟုတ် ပုံ တစ်ခုခု ထည့်သွင်းပေးပါ', 'error');

            document.getElementById('loading-overlay').classList.remove('hidden');

            let replyImageURL = '';
            
            try {
                if (imageFile) {
                    const fileExtension = imageFile.name.split('.').pop();
                    const fileName = `${transferId}_admin_reply_${Date.now()}.${fileExtension}`;
                    const uploadResult = await storage.createFile(
                        APPWRITE_CONFIG.storageBucketId,
                        fileName,
                        imageFile
                    );
                    replyImageURL = storage.getFilePreview(APPWRITE_CONFIG.storageBucketId, uploadResult.$id);
                }

                // 1. Send Notification to User's Inbox
                await databases.createDocument(
                    APPWRITE_CONFIG.databaseId,
                    APPWRITE_CONFIG.notificationCollectionId,
                    'unique()',
                    {
                        userId: transfer.senderId,
                        title: `Admin မှ ${transfer.amountMMK.toFixed(0)} ကျပ် ငွေလွဲမှု အကြောင်း ပြန်ကြားချက်`,
                        message: message || 'Admin မှ သင့်အား ပုံဖြင့် အကြောင်းပြန်ကြားထားပါသည်။',
                        imageURL: replyImageURL,
                        isRead: false,
                        timestamp: new Date().toISOString(),
                        relatedTransferId: transferId
                    }
                );

                // 2. Update Transfer status to Completed if message contains key phrase (optional, but good practice)
                if (message.includes('ပြီးပါပြီ') || message.includes('Completed')) {
                    await databases.updateDocument(
                        APPWRITE_CONFIG.databaseId,
                        APPWRITE_CONFIG.transferCollectionId,
                        transferId,
                        { status: 'Completed' }
                    );
                }

                showMessage('User သို့ အကြောင်းပြန်ကြားချက် အောင်မြင်စွာ ပို့ပြီးပါပြီ။');
                document.getElementById('admin-reply-form').reset();
            } catch (e) {
                console.error("Error sending reply: ", e);
                showMessage('ပြန်ပို့ရာတွင် အမှားရှိသည်', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };
        window.sendAdminReply = sendAdminReply;
        
        const completeTransfer = async (transferId) => {
            if (!isAdmin) return;
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                await databases.updateDocument(
                    APPWRITE_CONFIG.databaseId,
                    APPWRITE_CONFIG.transferCollectionId,
                    transferId,
                    { status: 'Completed' }
                );
                
                // Also send a formal notification
                const transfer = adminTransfers.find(t => t.id === transferId);
                await databases.createDocument(
                    APPWRITE_CONFIG.databaseId,
                    APPWRITE_CONFIG.notificationCollectionId,
                    'unique()',
                    {
                        userId: transfer.senderId,
                        title: `✅ ငွေလွဲမှု အောင်မြင်ပါသည်။`,
                        message: `သင့်၏ ${transfer.amountTHB.toFixed(2)} ဘတ် ➜ ${transfer.amountMMK.toFixed(0)} ကျပ် ငွေလွဲမှု အောင်မြင်စွာ ပြီးဆုံးကြောင်း အတည်ပြုပါသည်။`,
                        isRead: false,
                        timestamp: new Date().toISOString(),
                        relatedTransferId: transferId
                    }
                );

                showMessage('ငွေလွဲမှု ပြီးဆုံးကြောင်း အောင်မြင်စွာ အတည်ပြုပြီးပါပြီ။');
                showScreen('admin');
            } catch (e) {
                console.error("Error completing transfer: ", e);
                showMessage('အတည်ပြုရာတွင် အမှားရှိသည်', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };
        window.completeTransfer = completeTransfer;

        // --- Inbox Screen ---

        const renderInbox = () => {
            const content = document.getElementById('content-area');
            
            content.innerHTML = `
                <div class="space-y-6" id="inbox-content">
                    <h2 class="text-2xl font-bold text-emerald-400">${t('inbox')}</h2>
                    <p class="text-sm text-gray-400">Admin မှ ပို့သော မက်ဆေ့ခ်ျများ</p>
                    
                    <div id="notifications-list" class="space-y-3">
                        ${userNotifications.length === 0 ? 
                            '<p class="text-gray-400 p-4 card rounded-lg text-center">အဝင်စာ မရှိပါ</p>' :
                            userNotifications.map(n => {
                                const date = n.timestamp ? new Date(n.timestamp).toLocaleString('my-MM') : 'N/A';
                                return `
                                    <div onclick="markNotificationAsRead('${n.id}')" class="card p-4 rounded-xl cursor-pointer transition duration-150 ${n.isRead ? 'opacity-80' : 'border-2 border-yellow-400'}">
                                        <div class="flex items-start">
                                            <i class="fa-solid fa-bell text-xl ${n.isRead ? 'text-gray-400' : 'text-yellow-400'} mr-3 mt-1"></i>
                                            <div class="flex-grow">
                                                <p class="font-bold ${n.isRead ? 'text-gray-200' : 'text-white'}">${n.title}</p>
                                                <p class="text-sm text-gray-400">${n.message}</p>
                                                ${n.imageURL ? `
                                                    <img src="${n.imageURL}" onerror="this.src='https://placehold.co/100x50/374151/ffffff?text=Image'" class="mt-2 rounded-lg max-h-20 object-contain border border-gray-600" alt="">
                                                    <a href="${n.imageURL}" target="_blank" onclick="event.stopPropagation();" class="text-xs text-blue-400 hover:text-blue-300 mt-1 inline-block"><i class="fa-solid fa-expand-alt mr-1"></i> ပုံကြီးချဲ့ကြည့်ရန်</a>
                                                ` : ''}
                                                <p class="text-xs text-gray-500 mt-2">${date}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                </div>
            `;
        };
        window.renderInbox = renderInbox;

        // --- Profile Screen ---

        const renderProfile = () => {
            const content = document.getElementById('content-area');
            const user = account.current();
            const userEmail = user?.email || 'N/A';
            const userDisplayName = user?.name || '';

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Profile Card -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-2xl font-bold mb-4">${t('profile')} နှင့် Account</h2>
                        
                        <div class="space-y-3">
                            <p><strong>Username:</strong> ${userDisplayName || 'N/A'}</p>
                            <p><strong>Email:</strong> ${userEmail}</p>
                            <p><strong>User ID:</strong> ${userId || 'N/A'}</p>
                        </div>
                        
                        <form id="update-profile-form" onsubmit="event.preventDefault(); updateProfileName()" class="mt-4 pt-4 border-t border-gray-600">
                            <label for="usernameInput" class="block text-sm font-medium">Username (ပြောင်းလဲရန်)</label>
                            <input type="text" id="usernameInput" value="${userDisplayName}" placeholder="သင့်အမည်" class="mt-1 w-full p-2 border rounded-lg">
                            <button type="submit" class="btn-primary w-full py-2 rounded-lg mt-3 font-semibold">Username အပ်ဒိတ်</button>
                        </form>
                    </div>

                    <!-- Past Transfers Section -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-xl font-bold mb-3">ငွေပို့ထားသည့် စာရင်းများ</h2>
                        <div id="profile-transfers-list" class="space-y-3">
                            ${renderProfileTransfers()}
                        </div>
                    </div>

                    <!-- Settings & Logout -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-xl font-bold mb-3">Settings</h2>
                        
                        <!-- Language Selection -->
                        <div class="flex justify-between items-center py-2 border-b border-gray-600">
                            <span class="font-medium">ဘာသာစကား (Language)</span>
                            <select onchange="setLanguage(this.value)" class="p-1 border rounded-lg bg-gray-600">
                                <option value="my" ${currentLang === 'my' ? 'selected' : ''}>မြန်မာ (Burmese)</option>
                                <option value="en" ${currentLang === 'en' ? 'selected' : ''}>English</option>
                            </select>
                        </div>

                        <!-- Logout Button -->
                        <button onclick="handleLogout()" class="w-full py-2 rounded-lg font-bold bg-red-600 text-white mt-4 hover:bg-red-500">
                            <i class="fa-solid fa-sign-out-alt mr-2"></i> Log Out
                        </button>
                    </div>
                </div>
            `;
        };
        window.renderProfile = renderProfile;

        const renderProfileTransfers = () => {
            if (userTransfers.length === 0) return '<p class="text-gray-400 text-center">သင် ငွေလွဲထားသော စာရင်းများ မရှိပါ</p>';

            return userTransfers.map(t => {
                const date = t.timestamp ? new Date(t.timestamp).toLocaleString('my-MM') : 'N/A';
                const statusColor = t.status === 'Completed' ? 'bg-green-600' : (t.status === 'Pending' ? 'bg-yellow-600' : 'bg-red-600');
                const transferTypeLabel = t.transferType === 'home' ? t('typeHome') : t('typeAccount');

                return `
                    <div class="card p-3 rounded-xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-100">${t.amountTHB.toFixed(2)} ${t('thb')} ➜ ${t.amountMMK.toFixed(2)} ${t('mmk')}</p>
                                <p class="text-xs text-gray-400 mt-1">${transferTypeLabel} (${t.receiverName})</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColor} text-white">${t.status}</span>
                                <p class="text-xs text-gray-500 mt-1">${date}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };
        window.renderProfileTransfers = renderProfileTransfers;

        const updateProfileName = async () => {
            const usernameInput = document.getElementById('usernameInput').value.trim();
            if (!usernameInput) return showMessage('Username ဖြည့်သွင်းပါ', 'error');

            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await account.updateName(usernameInput);
                showMessage('Username အောင်မြင်စွာ ပြောင်းလဲပြီးပါပြီ။');
                // Re-render to show updated name
                showScreen('profile');
            } catch (error) {
                console.error("Error updating profile:", error);
                showMessage('Username ပြောင်းလဲရာတွင် အမှားရှိသည်', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };
        window.updateProfileName = updateProfileName;

        // --- Core Application Logic ---

        const showScreen = (screenName) => {
            if (!isAuthReady) return;

            if (screenName === 'admin' && !isAdmin) {
                screenName = 'home';
            }

            currentScreen = screenName;
            const navButtons = document.querySelectorAll('.nav-button');

            // Reset navigation styles
            navButtons.forEach(btn => {
                // Ensure only non-admin buttons reset to gray
                if (btn.id !== 'admin-nav-button') {
                    btn.classList.remove('text-emerald-400');
                    btn.classList.add('text-gray-400');
                } else {
                    btn.classList.remove('text-red-400');
                }
            });

            // Set active navigation style
            const activeBtn = document.querySelector(`[onclick="showScreen('${screenName}')"]`);
            if (activeBtn) {
                if (screenName === 'admin') {
                    activeBtn.classList.add('text-red-400');
                    activeBtn.classList.remove('text-gray-400');
                } else {
                    activeBtn.classList.add('text-emerald-400');
                    activeBtn.classList.remove('text-gray-400');
                }
            }

            const content = document.getElementById('content-area');
            content.innerHTML = `<p class="text-center text-gray-500">${t('loading')}...</p>`;

            switch (screenName) {
                case 'home':
                    renderHome();
                    break;
                case 'transfer':
                    renderTransfer();
                    break;
                case 'inbox':
                    renderInbox();
                    break;
                case 'profile':
                    renderProfile();
                    break;
                case 'admin':
                    renderAdminPanel();
                    break;
                default:
                    renderHome();
            }
        };
        window.showScreen = showScreen;

        window.setLanguage = (lang) => {
            currentLang = lang;
            updateStaticText();
            showScreen(currentScreen);
        };

        // Start initialization
        initAppwrite();
    </script>
</body>
</html>
