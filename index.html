<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #10B981;
            --primary-dark: #059669;
            --bg-dark: #1f2937;
            --text-dark: #f3f4f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
            border: 1px solid #4b5563;
        }

        input, select, textarea {
            background-color: #4b5563;
            color: var(--text-dark);
            border-color: #6b7280;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .scrollable-content {
            height: calc(100vh - 100px); 
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollable-content::-webkit-scrollbar {
            display: none;
        }
        
        .tab-button.active {
            border-bottom-width: 3px;
            border-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .arrow-right {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .contact-link {
            transition: all 0.3s ease;
        }
        
        .contact-link:hover {
            transform: translateX(5px);
        }
        
        .payment-image {
            width: 100%;
            height: 80px;
            object-fit: contain;
            border-radius: 8px;
            border: 2px solid #4b5563;
        }
        
        .bank-image-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .bank-image-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .bank-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #4b5563;
        }
        
        .language-selector {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Language Selector -->
    <div class="language-selector">
        <select id="language-select" onchange="setLanguage(this.value)" class="p-2 border rounded-lg bg-gray-700 text-white">
            <option value="my">မြန်မာ</option>
            <option value="en">English</option>
        </select>
    </div>

    <!-- Global Modals and Overlays -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
            <p class="mt-4 text-white text-lg" id="loading-text">ဒေတာများ ဆွဲယူနေပါသည်...</p>
        </div>
    </div>
    
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-transform duration-300 transform translate-x-full"></div>

    <!-- Login/Sign Up Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <!-- Auth UI will be rendered here -->
    </div>
    
    <!-- Main App Content (Hidden until authenticated) -->
    <div id="app-content-wrapper" class="max-w-xl mx-auto min-h-screen flex flex-col hidden">
        <!-- Header -->
        <header id="app-header" class="p-4 pt-6 text-center">
            <h1 class="text-2xl font-extrabold" id="app-title">ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)</h1>
        </header>

        <!-- Content Area -->
        <main id="content-area" class="flex-grow p-4 scrollable-content">
            <!-- Content will be rendered here based on the current screen -->
        </main>

        <!-- Navigation Footer -->
        <footer id="nav-footer" class="sticky bottom-0 w-full max-w-xl mx-auto bg-gray-800 border-t border-gray-700 p-2 shadow-lg">
            <div class="flex justify-around text-xs font-medium" id="nav-container">
                <!-- Nav items will be generated here -->
            </div>
        </footer>
    </div>
    
    <!-- Firebase SDKs and Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, serverTimestamp, getDocs, deleteDoc, orderBy, limit, where, addDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // --- Cloudinary Configuration ---
        const CLOUDINARY_CLOUD_NAME = 'drizdw5nc';
        const CLOUDINARY_UPLOAD_PRESET = 'waiyansoe118234';
        
        // --- Firebase Configuration ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAUL74mqVCIY1MMclrRhdVbY_VyP4lgQpY",
            authDomain: "waiappstore.firebaseapp.com",
            projectId: "waiappstore",
            storageBucket: "waiappstore.firebasestorage.app",
            messagingSenderId: "161610339691",
            appId: "1:161610339691:web:ce59fafb6a21729030682e",
            measurementId: "G-HH95X102MG"
        };

        const ADMIN_EMAIL = 'c388925@gmail.com';
        const APP_ID = 'thai-myanmar-remittance';
        
        let app, db, auth;
        let userId = null, userEmail = null, isAdmin = false;
        let currentScreen = 'home', isAuthReady = false, currentTransferTab = 'account';
        let currentLanguage = 'my'; // Default language

        // State for rates
        let currentRates = {
            THB_TO_MMK: 121.95,
            MMK_TO_THB: 126.58,
            rateHomeDeliveryTHB_TO_MMK: 820,
            rateHomeDeliveryMMK_TO_THB: 830,
            lastUpdated: 'Loading...'
        };

        let adminBankInfo = {
            image1URL: 'https://placehold.co/200x100/10B981/ffffff?text=Bank+QR+1',
            image2URL: 'https://placehold.co/200x100/60A5FA/ffffff?text=Bank+QR+2',
            image3URL: 'https://placehold.co/200x100/8B5CF6/ffffff?text=Bank+QR+3',
            image4URL: 'https://placehold.co/200x100/F59E0B/ffffff?text=Bank+QR+4'
        };

        let paymentMethodImages = {
            wavepay: 'https://placehold.co/150x80/0066FF/ffffff?text=Wave+Pay',
            kpay: 'https://placehold.co/150x80/00CC88/ffffff?text=K+Pay'
        };

        let transferDirection = 'THB_TO_MMK'; 
        let userTransfers = [];
        let adminTransfers = [];
        let userNotifications = [];
        let adminNotifications = [];

        // Translations
        const translations = {
            my: {
                appTitle: "ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)",
                loading: "ဒေတာများ ဆွဲယူနေပါသည်...",
                login: "အကောင့်ဝင်ရန်",
                signup: "အကောင့်ဖွင့်ရန်",
                email: "Email",
                password: "Password",
                username: "Username",
                loginButton: "အကောင့်ဝင်ရန်",
                signupButton: "အကောင့်ဖွင့်ရန်",
                haveAccount: "အကောင့်ရှိပြီးသားလား? အကောင့်ဝင်ရန်",
                noAccount: "အကောင့်မရှိသေးဘူးလား? အကောင့်ဖွင့်ရန်",
                home: "ငွေလဲနှုန်း",
                transfer: "ငွေလွဲရန်",
                inbox: "အဝင်စာ",
                profile: "Profile",
                admin: "စီမံခန့်ခွဲမှု",
                ratesTitle: "ငွေလဲနှုန်း (၁ ဘတ်လျှင် မြန်မာကျပ်)",
                lastUpdate: "နောက်ဆုံး အပ်ဒိတ်:",
                homeDelivery: "အိမ်သို့ ငွေလွဲရန် (Home Delivery Rate)",
                accountTransfer: "အကောင့်သို့ ငွေလွဲရန်",
                baht: "ဘတ်",
                kyat: "ကျပ်",
                download: "ပုံကို Save",
                adminRates: "Admin: ငွေလဲနှုန်းများ ပြင်ဆင်ရန်",
                updateRates: "နှုန်းထားများ အပ်ဒိတ်လုပ်ရန်",
                adminBankImages: "Admin: MyanmarPay ဘဏ်ပုံများ ပြင်ဆင်ရန်",
                updateBankImages: "ပုံများ အပ်ဒိတ်လုပ်ရန်",
                transferFormTitle: "ဖောင်",
                paymentMethod: "ငွေပို့ထားသည့် အကောင့် (ရွေးချယ်ပါ)",
                senderName: "ငွေလွဲမည့်သူအမည်",
                receiverName: "ငွေလက်ခံမည့်သူအမည်",
                senderPhone: "ဖုန်းနံပါတ် (ထိုင်း)",
                receiverPhone: "ဖုန်းနံပါတ် (မြန်မာ)",
                amount: "ငွေလွဲမည့် ပမာဏ",
                calculatedAmount: "ရရှိမည့်ပမာဏ:",
                bankQr: "ငွေလက်ခံမည့်သူ၏ ဘဏ် QR ပုံ",
                deliveryAddress: "ပို့ရမည့်လိပ်စာ (မဖြစ်မနေ)",
                receipt: "ငွေပို့ထားသော စလစ်ပုံ ထည့်ရန်",
                submit: "ပို့ရန်",
                adminPanel: "စီမံခန့်ခွဲမှု စစ်ဆေးဆဲ စာရင်း",
                pending: "စစ်ဆေးရန်ကျန်ရှိသော စာရင်းများ",
                noTransfers: "စစ်ဆေးရန် ငွေလွဲမှုများ မရှိပါ",
                transferDetail: "ငွေလွဲမှု အသေးစိတ်",
                reply: "စာ/ပုံ ပြန်ပို့ရန်",
                sendReply: "User သို့ ပြန်ပို့ရန်",
                complete: "ငွေလွဲမှု ပြီးဆုံးကြောင်း အတည်ပြုရန်",
                inboxTitle: "အဝင်စာ",
                noNotifications: "အဝင်စာ မရှိပါ",
                profileTitle: "Profile နှင့် Account",
                updateProfile: "Username အပ်ဒိတ်",
                logout: "Log Out",
                pastTransfers: "ငွေပို့ထားသည့် စာရင်းများ",
                noPastTransfers: "သင် ငွေလွဲထားသော စာရင်းများ မရှိပါ",
                settings: "Settings",
                language: "ဘာသာစကား (Language)",
                contact: "ဆက်သွယ်ရန်",
                success: "အောင်မြင်ပါသည်",
                error: "အမှားရှိပါသည်",
                adminNotifications: "Admin အသိပေးချက်များ",
                markAllRead: "အားလုံးဖတ်ပြီးအဖြစ် မှတ်ရန်"
            },
            en: {
                appTitle: "Thai-Myanmar Remittance",
                loading: "Loading data...",
                login: "Login",
                signup: "Sign Up",
                email: "Email",
                password: "Password",
                username: "Username",
                loginButton: "Login",
                signupButton: "Sign Up",
                haveAccount: "Already have an account? Login",
                noAccount: "Don't have an account? Sign Up",
                home: "Exchange Rates",
                transfer: "Transfer Money",
                inbox: "Inbox",
                profile: "Profile",
                admin: "Admin Panel",
                ratesTitle: "Exchange Rates (1 Baht to MMK)",
                lastUpdate: "Last Updated:",
                homeDelivery: "Home Delivery Rate",
                accountTransfer: "Account Transfer Rate",
                baht: "Baht",
                kyat: "Kyat",
                download: "Save Image",
                adminRates: "Admin: Update Exchange Rates",
                updateRates: "Update Rates",
                adminBankImages: "Admin: Update Bank Images",
                updateBankImages: "Update Images",
                transferFormTitle: "Form",
                paymentMethod: "Payment Method",
                senderName: "Sender Name",
                receiverName: "Receiver Name",
                senderPhone: "Phone (Thailand)",
                receiverPhone: "Phone (Myanmar)",
                amount: "Amount",
                calculatedAmount: "You will receive:",
                bankQr: "Receiver's Bank QR Code",
                deliveryAddress: "Delivery Address (Required)",
                receipt: "Transfer Receipt Image",
                submit: "Submit",
                adminPanel: "Admin - Pending Transfers",
                pending: "Transfers to review",
                noTransfers: "No transfers to review",
                transferDetail: "Transfer Details",
                reply: "Send Reply",
                sendReply: "Send to User",
                complete: "Mark as Completed",
                inboxTitle: "Inbox",
                noNotifications: "No notifications",
                profileTitle: "Profile and Account",
                updateProfile: "Update Username",
                logout: "Log Out",
                pastTransfers: "Past Transfers",
                noPastTransfers: "No past transfers",
                settings: "Settings",
                language: "Language",
                contact: "Contact",
                success: "Success",
                error: "Error",
                adminNotifications: "Admin Notifications",
                markAllRead: "Mark All as Read"
            }
        };

        // Auto delete old transfers after 7 days
        const AUTO_DELETE_DAYS = 7;

        // --- Utility Functions ---
        const t = (key) => {
            return translations[currentLanguage][key] || key;
        };

        const showMessage = (msg, type = 'success') => {
            const box = document.getElementById('message-box');
            const color = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
            const html = `
                <div class="${color} text-white p-3 rounded-lg shadow-xl mb-3 text-sm" style="min-width: 250px;">
                    ${msg}
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const messageElement = tempDiv.firstChild;
            
            box.prepend(messageElement);
            box.classList.remove('translate-x-full');
            box.classList.add('translate-x-0');

            setTimeout(() => {
                messageElement.remove();
                if (box.children.length === 0) {
                    box.classList.remove('translate-x-0');
                    box.classList.add('translate-x-full');
                }
            }, 5000);
        };

        const downloadImage = (url) => {
            fetch(url, { mode: 'cors' })
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = `remittance_image_${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(blobUrl);
                    showMessage(t('download') + ' ' + t('success'), 'success');
                })
                .catch(error => {
                    console.error("Download error:", error);
                    showMessage(t('download') + ' ' + t('error'), 'error');
                });
        };

        // Cloudinary Upload Function
        const uploadToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            
            try {
                console.log('Uploading to Cloudinary...');
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Cloudinary upload failed: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Upload successful:', data.secure_url);
                return data.secure_url;
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                throw new Error(`Upload error: ${error.message}`);
            }
        };

        // Auto delete old transfers
        const autoDeleteOldTransfers = async () => {
            if (!isAdmin) return;
            
            try {
                const transfersColRef = collection(db, PUBLIC_DATA_PATH, 'transfers');
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - AUTO_DELETE_DAYS);
                
                const transfersSnapshot = await getDocs(transfersColRef);
                let deletedCount = 0;
                
                transfersSnapshot.forEach(async (docSnap) => {
                    const transfer = docSnap.data();
                    if (transfer.timestamp) {
                        const transferDate = transfer.timestamp.toDate();
                        if (transferDate < sevenDaysAgo) {
                            await deleteDoc(doc(db, PUBLIC_DATA_PATH, 'transfers', docSnap.id));
                            deletedCount++;
                            console.log('Auto deleted old transfer:', docSnap.id);
                        }
                    }
                });
                
                if (deletedCount > 0) {
                    console.log(`Auto deleted ${deletedCount} old transfers`);
                    showMessage(`Auto deleted ${deletedCount} old transfers`, 'success');
                }
            } catch (error) {
                console.error('Error auto deleting old transfers:', error);
            }
        };

        // --- Firebase Initialization and Auth ---
        const initFirebase = async () => {
            try {
                app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userEmail = user.email;
                        isAdmin = user.email === ADMIN_EMAIL;
                        
                        console.log('User logged in:', { userId, userEmail, isAdmin });
                        
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('app-content-wrapper').classList.remove('hidden');

                        if (!isAuthReady) {
                            isAuthReady = true;
                            updateStaticText();
                            loadRates();
                            loadAdminBankInfo();
                            loadPaymentMethodImages();
                            loadTransfers();
                            loadNotifications();
                            
                            // Load admin notifications if admin
                            if (isAdmin) {
                                loadAdminNotifications();
                            }
                            
                            // Auto delete old transfers for admin
                            if (isAdmin) {
                                autoDeleteOldTransfers();
                                setInterval(autoDeleteOldTransfers, 24 * 60 * 60 * 1000); // Daily check
                            }
                            
                            showScreen('home'); 
                        }
                    } else {
                        isAuthReady = false;
                        userId = null;
                        userEmail = null;
                        isAdmin = false;
                        document.getElementById('app-content-wrapper').classList.add('hidden');
                        document.getElementById('auth-screen').classList.remove('hidden');
                        renderAuthScreen();
                    }
                    document.getElementById('loading-overlay').classList.add('hidden');
                });
                
                document.getElementById('loading-overlay').classList.remove('hidden');

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading-overlay').classList.add('hidden');
                showMessage(`Firebase Error: ${error.message}`, 'error');
            }
        };

        const renderAuthScreen = (isLogin = true) => {
            const authScreen = document.getElementById('auth-screen');
            authScreen.innerHTML = `
                <div class="card w-full max-w-sm p-8 rounded-xl space-y-6">
                    <h2 class="text-3xl font-bold text-center text-emerald-400">${isLogin ? t('login') : t('signup')}</h2>
                    
                    <form id="auth-form" onsubmit="event.preventDefault(); handleAuthSubmit(${isLogin})">
                        ${!isLogin ? `
                            <div>
                                <label for="username" class="block text-sm font-medium mb-1">${t('username')}</label>
                                <input type="text" id="username" required class="w-full p-3 border rounded-lg" placeholder="${t('username')}">
                            </div>` : ''}
                        <div>
                            <label for="email" class="block text-sm font-medium mb-1">${t('email')}</label>
                            <input type="email" id="email" required class="w-full p-3 border rounded-lg" placeholder="example@gmail.com">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium mb-1">${t('password')}</label>
                            <input type="password" id="password" required class="w-full p-3 border rounded-lg" placeholder="${t('password')} (6+ characters)">
                        </div>
                        
                        <button type="submit" class="btn-primary w-full py-3 rounded-lg mt-4 font-bold">
                            ${isLogin ? t('loginButton') : t('signupButton')}
                        </button>
                    </form>
                    
                    <button onclick="renderAuthScreen(!${isLogin})" class="w-full text-sm text-center text-blue-400 hover:text-blue-300">
                        ${isLogin ? t('noAccount') : t('haveAccount')}
                    </button>
                </div>
            `;
        };

        const handleAuthSubmit = async (isLogin) => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = isLogin ? null : document.getElementById('username').value;
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-text').textContent = t('loading');

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage('Login ' + t('success'), 'success');
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: username });
                    showMessage('Signup ' + t('success'), 'success');
                }
            } catch (error) {
                console.error("Auth Error:", error);
                let msg = t('error');
                if (error.code === 'auth/invalid-email') msg = 'Invalid email';
                else if (error.code === 'auth/wrong-password') msg = 'Wrong password';
                else if (error.code === 'auth/user-not-found') msg = 'User not found';
                else if (error.code === 'auth/email-already-in-use') msg = 'Email already in use';
                else if (error.code === 'auth/weak-password') msg = 'Password too weak (min 6 chars)';

                showMessage(msg, 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Firestore Data Handlers ---
        const PUBLIC_DATA_PATH = `artifacts/${APP_ID}/public/data`;
        const USER_DATA_PATH = (uid) => `artifacts/${APP_ID}/users/${uid}`;

        const updateStaticText = () => {
            const adminButtonHtml = isAdmin ? `
                <button onclick="showScreen('admin')" id="admin-nav-button" class="nav-button flex flex-col items-center p-2 rounded-lg text-red-400 hover:text-red-300 relative">
                    <i class="fa-solid fa-screwdriver-wrench text-xl"></i>
                    ${adminNotifications.length > 0 ? `
                        <span class="notification-badge">${adminNotifications.length}</span>
                    ` : ''}
                    <span class="mt-1">${t('admin')}</span>
                </button>
            ` : '';

            const navContainer = document.getElementById('nav-container');
            navContainer.innerHTML = `
                <button onclick="showScreen('home')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-exchange-alt text-xl"></i>
                    <span class="mt-1">${t('home')}</span>
                </button>
                <button onclick="showScreen('transfer')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-paper-plane text-xl"></i>
                    <span class="mt-1">${t('transfer')}</span>
                </button>
                <button onclick="showScreen('inbox')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500 relative">
                    <i class="fa-solid fa-inbox text-xl"></i>
                    <span id="inbox-badge" class="absolute top-0 right-0 inline-block w-3 h-3 bg-red-500 rounded-full hidden"></span>
                    <span class="mt-1">${t('inbox')}</span>
                </button>
                <button onclick="showScreen('profile')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-user-gear text-xl"></i>
                    <span class="mt-1">${t('profile')}</span>
                </button>
                ${adminButtonHtml}
            `;
        };

        // --- Rate Management ---
        const loadRates = () => {
            const docRef = doc(db, PUBLIC_DATA_PATH, 'rates', 'current');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentRates.THB_TO_MMK = data.rateBuyMMK || 121.95;
                    currentRates.MMK_TO_THB = data.rateBuyTHB || 126.58;
                    currentRates.rateHomeDeliveryTHB_TO_MMK = data.rateHomeDeliveryTHB_TO_MMK || 820;
                    currentRates.rateHomeDeliveryMMK_TO_THB = data.rateHomeDeliveryMMK_TO_THB || 830;
                    
                    const timestamp = data.lastUpdated;
                    if (timestamp) {
                        const date = timestamp.toDate();
                        currentRates.lastUpdated = date.toLocaleString('my-MM', {
                            year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                    } else {
                        currentRates.lastUpdated = 'Just now';
                    }
                    if (currentScreen === 'home') renderHome();
                } else {
                    setDoc(docRef, { 
                        rateBuyMMK: currentRates.THB_TO_MMK,
                        rateBuyTHB: currentRates.MMK_TO_THB,
                        rateHomeDeliveryTHB_TO_MMK: currentRates.rateHomeDeliveryTHB_TO_MMK,
                        rateHomeDeliveryMMK_TO_THB: currentRates.rateHomeDeliveryMMK_TO_THB,
                        lastUpdated: serverTimestamp() 
                    });
                }
            }, (error) => {
                console.error("Error fetching rates: ", error);
            });
        };

        const loadAdminBankInfo = () => {
            const docRef = doc(db, PUBLIC_DATA_PATH, 'config', 'bankInfo');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    adminBankInfo.image1URL = data.image1URL || adminBankInfo.image1URL;
                    adminBankInfo.image2URL = data.image2URL || adminBankInfo.image2URL;
                    adminBankInfo.image3URL = data.image3URL || adminBankInfo.image3URL;
                    adminBankInfo.image4URL = data.image4URL || adminBankInfo.image4URL;
                    if (currentScreen === 'home') renderHome();
                } else {
                    setDoc(docRef, adminBankInfo, { merge: true });
                }
            }, (error) => console.error("Error fetching bank info: ", error));
        };

        const loadPaymentMethodImages = () => {
            const docRef = doc(db, PUBLIC_DATA_PATH, 'config', 'paymentMethods');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    paymentMethodImages.wavepay = data.wavepay || paymentMethodImages.wavepay;
                    paymentMethodImages.kpay = data.kpay || paymentMethodImages.kpay;
                    if (currentScreen === 'transfer') renderTransfer();
                } else {
                    setDoc(docRef, paymentMethodImages, { merge: true });
                }
            }, (error) => console.error("Error fetching payment method images: ", error));
        };

        // --- Transfers and Notifications ---
        const loadTransfers = () => {
            if (!isAuthReady || !userId) return;
            
            const transfersColRef = collection(db, PUBLIC_DATA_PATH, 'transfers');
            
            onSnapshot(transfersColRef, (snapshot) => {
                const transfers = [];
                snapshot.forEach((doc) => {
                    transfers.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('Loaded transfers:', transfers.length);
                
                adminTransfers = transfers.sort((a, b) => {
                    if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                    if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                    return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
                });

                // User transfers - only user's transfers, limit to 5 and auto delete oldest
                userTransfers = transfers.filter(t => t.senderId === userId)
                                         .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                // Keep only latest 5 transfers, delete older ones
                if (userTransfers.length > 5) {
                    const transfersToDelete = userTransfers.slice(5);
                    userTransfers = userTransfers.slice(0, 5);
                    
                    // Delete older transfers in background
                    transfersToDelete.forEach(async (transfer) => {
                        try {
                            await deleteDoc(doc(db, PUBLIC_DATA_PATH, 'transfers', transfer.id));
                            console.log('Deleted old transfer:', transfer.id);
                        } catch (error) {
                            console.error('Error deleting old transfer:', error);
                        }
                    });
                }
                
                if (currentScreen === 'admin') renderAdminPanel();
                if (currentScreen === 'profile') renderProfile();

            }, (error) => {
                console.error("Error fetching transfers: ", error);
            });
        };

        const loadNotifications = () => {
            if (!isAuthReady || !userId) return;
            
            const notificationsColRef = collection(db, `artifacts/${APP_ID}/users/${userId}`, 'notifications');
            
            onSnapshot(notificationsColRef, (snapshot) => {
                userNotifications = [];
                snapshot.forEach((doc) => {
                    userNotifications.push({ id: doc.id, ...doc.data() });
                });
                
                userNotifications.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                const unreadCount = userNotifications.filter(n => !n.isRead).length;
                const badge = document.getElementById('inbox-badge');
                if (badge) {
                    badge.classList.toggle('hidden', unreadCount === 0);
                }

                if (currentScreen === 'inbox') renderInbox();
            }, (error) => {
                console.error("Error fetching notifications: ", error);
            });
        };

        const loadAdminNotifications = () => {
            if (!isAdmin) return;
            
            const adminNotificationsColRef = collection(db, PUBLIC_DATA_PATH, 'adminNotifications');
            
            onSnapshot(adminNotificationsColRef, (snapshot) => {
                adminNotifications = [];
                snapshot.forEach((doc) => {
                    adminNotifications.push({ id: doc.id, ...doc.data() });
                });
                
                adminNotifications.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                // Update admin button badge
                updateStaticText();
                
                if (currentScreen === 'admin') renderAdminPanel();
            }, (error) => {
                console.error("Error fetching admin notifications: ", error);
            });
        };

        // Send notification to admin
        const sendAdminNotification = async (transferId, transferData) => {
            try {
                const adminNotificationsRef = collection(db, PUBLIC_DATA_PATH, 'adminNotifications');
                
                await addDoc(adminNotificationsRef, {
                    type: 'NEW_TRANSFER',
                    title: 'New Transfer Request',
                    message: `New transfer from ${transferData.senderName} (${transferData.senderEmail}) for ${transferData.amountTHB} THB to ${transferData.amountMMK} MMK`,
                    transferId: transferId,
                    transferData: transferData,
                    senderId: userId,
                    senderEmail: userEmail,
                    senderName: transferData.senderName,
                    isRead: false,
                    timestamp: serverTimestamp()
                });
                
                console.log('Admin notification sent successfully');
                return true;
            } catch (error) {
                console.error('Error sending admin notification:', error);
                return false;
            }
        };

        // Send notification to user
        const sendUserNotification = async (receiverUserId, title, message, imageURL = '', transferId = '') => {
            try {
                const notificationRef = doc(collection(db, `artifacts/${APP_ID}/users/${receiverUserId}`, 'notifications'));
                await setDoc(notificationRef, {
                    title: title,
                    message: message,
                    imageURL: imageURL,
                    isRead: false,
                    timestamp: serverTimestamp(),
                    relatedTransferId: transferId
                });
                console.log('User notification sent to:', receiverUserId);
                return true;
            } catch (error) {
                console.error('Error sending user notification:', error);
                return false;
            }
        };

        // Mark admin notification as read
        const markAdminNotificationAsRead = async (notificationId) => {
            if (!isAdmin) return;
            try {
                const docRef = doc(db, PUBLIC_DATA_PATH, 'adminNotifications', notificationId);
                await updateDoc(docRef, { isRead: true });
                console.log('Admin notification marked as read:', notificationId);
            } catch (error) {
                console.error('Error marking admin notification as read:', error);
            }
        };

        // --- UI Rendering Functions ---
        const renderHome = () => {
            const lastUpdated = currentRates.lastUpdated;
            
            const thbFor100kMMK = (100000 / currentRates.THB_TO_MMK).toFixed(2);
            const thbFor100kMMK_reverse = (100000 / currentRates.MMK_TO_THB).toFixed(2);
            const thbHomeDelivery_TO_MMK = currentRates.rateHomeDeliveryTHB_TO_MMK;
            const thbHomeDelivery_MMK_TO_THB = (100000 / currentRates.rateHomeDeliveryMMK_TO_THB).toFixed(2);

            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="space-y-6">
                    <p class="text-sm font-semibold text-emerald-400">${t('ratesTitle')}</p>
                    <p class="text-xs text-gray-400">${t('lastUpdate')} ${lastUpdated}</p>

                    <!-- Home Delivery Rate Card -->
                    <div class="card p-6 rounded-xl space-y-4 border border-red-500/50">
                        <h2 class="text-lg font-bold text-red-400">${t('homeDelivery')}</h2>
                        <div class="space-y-4">
                            <!-- ထိုင်းမှမြန်မာ -->
                            <div class="flex items-center justify-between p-4 bg-gray-600 rounded-xl">
                                <div class="text-center w-1/3">
                                    <p class="text-xs font-medium text-gray-300">${t('baht')}</p>
                                    <p class="text-2xl font-bold text-gray-50 mt-1">${thbHomeDelivery_TO_MMK} ${t('baht')}</p>
                                </div>
                                <div class="arrow-right">
                                    <i class="fa-solid fa-arrow-right-arrow-left text-2xl text-red-400"></i>
                                </div>
                                <div class="text-center w-1/3">
                                    <p class="text-xs font-medium text-gray-300">${t('kyat')}</p>
                                    <p class="text-2xl font-bold text-gray-50 mt-1">100,000 ${t('kyat')}</p>
                                </div>
                            </div>
                            <p class="text-sm text-center text-gray-200">
                                ${currentLanguage === 'my' ? 'ထိုင်းမှမြန်မာ: ၁ ဘတ် =' : 'THB to MMK: 1 Baht ='} ${(100000 / thbHomeDelivery_TO_MMK).toFixed(2)} ${t('kyat')}
                            </p>
                            
                            <!-- မြန်မာမှထိုင်း -->
                            <div class="flex items-center justify-between p-4 bg-gray-600 rounded-xl mt-4">
                                <div class="text-center w-1/3">
                                    <p class="text-xs font-medium text-gray-300">${t('kyat')}</p>
                                    <p class="text-2xl font-bold text-gray-50 mt-1">100,000 ${t('kyat')}</p>
                                </div>
                                <div class="arrow-right">
                                    <i class="fa-solid fa-arrow-right-arrow-left text-2xl text-red-400"></i>
                                </div>
                                <div class="text-center w-1/3">
                                    <p class="text-xs font-medium text-gray-300">${t('baht')}</p>
                                    <p class="text-2xl font-bold text-gray-50 mt-1">${thbHomeDelivery_MMK_TO_THB} ${t('baht')}</p>
                                </div>
                            </div>
                            <p class="text-sm text-center text-gray-200">
                                ${currentLanguage === 'my' ? 'မြန်မာမှထိုင်း: ၁သိန်းလျှင်ရမည့်ဘတ်:' : 'MMK to THB: 100,000 Kyat ='} ${thbHomeDelivery_MMK_TO_THB} ${t('baht')}
                            </p>
                        </div>
                    </div>

                    <!-- Account Transfer Rate Card -->
                    <div class="card p-6 rounded-xl space-y-4">
                        <h2 class="text-lg font-bold text-emerald-400">${t('accountTransfer')}</h2>
                        <div class="space-y-4">
                            <!-- ထိုင်းမှမြန်မာ -->
                            <div class="flex items-center justify-between p-4 bg-gray-600 rounded-xl">
                                <div class="text-center w-1/3">
                                    <p class="text-xs font-medium text-gray-300">${t('baht')}</p>
                                    <p class="text-xl font-bold text-gray-50 mt-1">${thbFor100kMMK} ${t('baht')}</p>
                                </div>

                                <div class="arrow-right">
                                    <i class="fa-solid fa-arrow-right text-2xl text-emerald-400"></i>
                                </div>

                                <div class="text-center w-1/3">
                                    <p class="text-xs font-medium text-gray-300">${t('kyat')}</p>
                                    <p class="text-xl font-bold text-gray-50 mt-1">100,000 ${t('kyat')}</p>
                                </div>
                            </div>
                            <p class="text-sm text-center font-bold text-gray-200">
                                ${currentLanguage === 'my' ? 'အကောင့်ထဲထည့်ဖို့ ၁သိန်းရရန်:' : 'For 100,000 Kyat to account:'} ${thbFor100kMMK} ${t('baht')}
                            </p>
                            
                            <!-- မြန်မာမှထိုင်း -->
                            <div class="flex items-center justify-between p-4 bg-gray-600 rounded-xl mt-4">
                                <div class="text-center w-1/3">
                                    <p class="text-xs font-medium text-gray-300">${t('kyat')}</p>
                                    <p class="text-xl font-bold text-gray-50 mt-1">100,000 ${t('kyat')}</p>
                                </div>

                                <div class="arrow-right">
                                    <i class="fa-solid fa-arrow-right text-2xl text-emerald-400"></i>
                                </div>

                                <div class="text-center w-1/3">
                                    <p class="text-xs font-medium text-gray-300">${t('baht')}</p>
                                    <p class="text-xl font-bold text-gray-50 mt-1">${thbFor100kMMK_reverse} ${t('baht')}</p>
                                </div>
                            </div>
                            <p class="text-sm text-center font-bold text-gray-200">
                                ${currentLanguage === 'my' ? 'အကောင့်ထဲထည့်ဖို့ ၁သိန်းရရန်:' : 'For 100,000 Kyat to account:'} ${thbFor100kMMK_reverse} ${t('baht')}
                            </p>
                        </div>
                    </div>

                    <!-- MyanmarPay Bank Info -->
                    ${renderMyanmarPayBankInfo()}
                    
                    ${isAdmin ? renderAdminRatePanel() : ''}
                </div>
            `;
        };

        const renderMyanmarPayBankInfo = () => {
            return `
                <div class="card p-5 rounded-xl border border-blue-400/50">
                    <h2 class="text-xl font-bold text-blue-400 mb-3">MyanmarPay ဘဏ်ပြင်ဆင်ချက်</h2>
                    <div class="bank-image-container">
                        <div class="bank-image-item">
                            <img src="${adminBankInfo.image1URL}" onerror="this.src='https://placehold.co/200x100/10B981/ffffff?text=Bank+QR+1'" class="bank-image" alt="ဘဏ်ပုံ ၁">
                            <button onclick="downloadImage('${adminBankInfo.image1URL}')" class="w-full mt-2 flex items-center justify-center p-2 text-xs bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                                <i class="fa-solid fa-download mr-2"></i> ${t('download')}
                            </button>
                        </div>
                        <div class="bank-image-item">
                            <img src="${adminBankInfo.image2URL}" onerror="this.src='https://placehold.co/200x100/60A5FA/ffffff?text=Bank+QR+2'" class="bank-image" alt="ဘဏ်ပုံ ၂">
                            <button onclick="downloadImage('${adminBankInfo.image2URL}')" class="w-full mt-2 flex items-center justify-center p-2 text-xs bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                                <i class="fa-solid fa-download mr-2"></i> ${t('download')}
                            </button>
                        </div>
                        <div class="bank-image-item">
                            <img src="${adminBankInfo.image3URL}" onerror="this.src='https://placehold.co/200x100/8B5CF6/ffffff?text=Bank+QR+3'" class="bank-image" alt="ဘဏ်ပုံ ၃">
                            <button onclick="downloadImage('${adminBankInfo.image3URL}')" class="w-full mt-2 flex items-center justify-center p-2 text-xs bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                                <i class="fa-solid fa-download mr-2"></i> ${t('download')}
                            </button>
                        </div>
                        <div class="bank-image-item">
                            <img src="${adminBankInfo.image4URL}" onerror="this.src='https://placehold.co/200x100/F59E0B/ffffff?text=Bank+QR+4'" class="bank-image" alt="ဘဏ်ပုံ ၄">
                            <button onclick="downloadImage('${adminBankInfo.image4URL}')" class="w-full mt-2 flex items-center justify-center p-2 text-xs bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                                <i class="fa-solid fa-download mr-2"></i> ${t('download')}
                            </button>
                        </div>
                    </div>
                    ${isAdmin ? renderMyanmarPayBankUpdateForm() : ''}
                </div>
            `;
        };

        const renderMyanmarPayBankUpdateForm = () => {
            return `
                <form id="bank-image-update-form" onsubmit="event.preventDefault(); updateBankImages()" class="mt-4 pt-4 border-t border-gray-600 space-y-3">
                    <h3 class="text-lg font-semibold text-red-400">${t('adminBankImages')}</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label for="bankImage1File" class="block text-xs font-medium">ဘဏ်ပုံ (၁)</label>
                            <input type="file" id="bankImage1File" accept="image/*" class="mt-1 w-full p-1 border rounded-lg text-xs">
                        </div>
                        <div>
                            <label for="bankImage2File" class="block text-xs font-medium">ဘဏ်ပုံ (၂)</label>
                            <input type="file" id="bankImage2File" accept="image/*" class="mt-1 w-full p-1 border rounded-lg text-xs">
                        </div>
                        <div>
                            <label for="bankImage3File" class="block text-xs font-medium">ဘဏ်ပုံ (၃)</label>
                            <input type="file" id="bankImage3File" accept="image/*" class="mt-1 w-full p-1 border rounded-lg text-xs">
                        </div>
                        <div>
                            <label for="bankImage4File" class="block text-xs font-medium">ဘဏ်ပုံ (၄)</label>
                            <input type="file" id="bankImage4File" accept="image/*" class="mt-1 w-full p-1 border rounded-lg text-xs">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary w-full py-2 rounded-lg font-semibold text-sm">${t('updateBankImages')}</button>
                </form>
            `;
        };

        const updateBankImages = async () => {
            if (!isAdmin) return showMessage('Admin only function', 'error');
            
            const file1 = document.getElementById('bankImage1File').files[0];
            const file2 = document.getElementById('bankImage2File').files[0];
            const file3 = document.getElementById('bankImage3File').files[0];
            const file4 = document.getElementById('bankImage4File').files[0];
            
            if (!file1 && !file2 && !file3 && !file4) {
                return showMessage('Select at least one image', 'error');
            }

            document.getElementById('loading-overlay').classList.remove('hidden');
            let updatedURLs = {};

            try {
                if (file1) {
                    updatedURLs.image1URL = await uploadToCloudinary(file1);
                }
                if (file2) {
                    updatedURLs.image2URL = await uploadToCloudinary(file2);
                }
                if (file3) {
                    updatedURLs.image3URL = await uploadToCloudinary(file3);
                }
                if (file4) {
                    updatedURLs.image4URL = await uploadToCloudinary(file4);
                }

                const docRef = doc(db, PUBLIC_DATA_PATH, 'config', 'bankInfo');
                await updateDoc(docRef, updatedURLs);
                showMessage('Bank images updated successfully', 'success');

            } catch (e) {
                console.error("Error updating bank images: ", e);
                showMessage('Error updating bank images', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        const renderAdminRatePanel = () => {
            return `
                <div class="card p-5 rounded-xl border border-red-400/50">
                    <h2 class="text-xl font-bold text-red-400 mb-3">${t('adminRates')}</h2>
                    <form id="rate-update-form" onsubmit="event.preventDefault(); updateRates()" class="space-y-3">
                        <div>
                            <label for="rateBuyMMKInput" class="block text-sm font-medium">${currentLanguage === 'my' ? 'အကောင့်သို့ - ထိုင်းမှမြန်မာ (၁သိန်းရရန် ဘတ်)' : 'Account - THB to MMK (Baht for 100,000 Kyat)'}</label>
                            <input type="number" id="rateBuyMMKInput" step="0.01" value="${(100000 / currentRates.THB_TO_MMK).toFixed(2)}" required class="mt-1 w-full p-2 border rounded-lg">
                            <p class="text-xs text-gray-400 mt-1">${currentLanguage === 'my' ? 'လက်ရှိ: ၁ ဘတ် =' : 'Current: 1 Baht ='} ${currentRates.THB_TO_MMK.toFixed(2)} ${t('kyat')}</p>
                        </div>
                        <div>
                            <label for="rateBuyTHBInput" class="block text-sm font-medium">${currentLanguage === 'my' ? 'အကောင့်သို့ - မြန်မာမှထိုင်း (၁သိန်းရရန် ဘတ်)' : 'Account - MMK to THB (Baht for 100,000 Kyat)'}</label>
                            <input type="number" id="rateBuyTHBInput" step="0.01" value="${(100000 / currentRates.MMK_TO_THB).toFixed(2)}" required class="mt-1 w-full p-2 border rounded-lg">
                            <p class="text-xs text-gray-400 mt-1">${currentLanguage === 'my' ? 'လက်ရှိ: ၁ ဘတ် =' : 'Current: 1 Baht ='} ${currentRates.MMK_TO_THB.toFixed(2)} ${t('kyat')}</p>
                        </div>
                        <div>
                            <label for="rateHomeDeliveryTHBInput" class="block text-sm font-medium">${currentLanguage === 'my' ? 'အိမ်သို့ - ထိုင်းမှမြန်မာ (၁သိန်းရရန် ဘတ်)' : 'Home Delivery - THB to MMK (Baht for 100,000 Kyat)'}</label>
                            <input type="number" id="rateHomeDeliveryTHBInput" step="0.01" value="${currentRates.rateHomeDeliveryTHB_TO_MMK}" required class="mt-1 w-full p-2 border rounded-lg">
                            <p class="text-xs text-gray-400 mt-1">${currentLanguage === 'my' ? 'လက်ရှိ: ၁ ဘတ် =' : 'Current: 1 Baht ='} ${(100000 / currentRates.rateHomeDeliveryTHB_TO_MMK).toFixed(2)} ${t('kyat')}</p>
                        </div>
                        <div>
                            <label for="rateHomeDeliveryMMKInput" class="block text-sm font-medium">${currentLanguage === 'my' ? 'အိမ်သို့ - မြန်မာမှထိုင်း (၁သိန်းရရန် ဘတ်)' : 'Home Delivery - MMK to THB (Baht for 100,000 Kyat)'}</label>
                            <input type="number" id="rateHomeDeliveryMMKInput" step="0.01" value="${(100000 / currentRates.rateHomeDeliveryMMK_TO_THB).toFixed(2)}" required class="mt-1 w-full p-2 border rounded-lg">
                            <p class="text-xs text-gray-400 mt-1">${currentLanguage === 'my' ? 'လက်ရှိ: ၁ ဘတ် =' : 'Current: 1 Baht ='} ${currentRates.rateHomeDeliveryMMK_TO_THB.toFixed(2)} ${t('kyat')}</p>
                        </div>
                        <button type="submit" class="btn-primary w-full py-2 rounded-lg font-semibold">${t('updateRates')}</button>
                    </form>
                    
                    <!-- Payment Method Image Upload -->
                    <form id="payment-method-update-form" onsubmit="event.preventDefault(); updatePaymentMethodImages()" class="mt-6 pt-4 border-t border-gray-600 space-y-3">
                        <h3 class="text-lg font-semibold text-blue-400">Payment Method ပုံများ အပ်ဒိတ်လုပ်ရန်</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center">
                                <p class="text-sm font-medium mb-2">Wave Pay</p>
                                <img src="${paymentMethodImages.wavepay}" class="payment-image mb-2" alt="Wave Pay">
                            </div>
                            <div class="text-center">
                                <p class="text-sm font-medium mb-2">K Pay</p>
                                <img src="${paymentMethodImages.kpay}" class="payment-image mb-2" alt="K Pay">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="wavepayFile" class="block text-xs font-medium">Wave Pay ပုံ</label>
                                <input type="file" id="wavepayFile" accept="image/*" class="mt-1 w-full p-1 border rounded-lg text-xs">
                            </div>
                            <div>
                                <label for="kpayFile" class="block text-xs font-medium">K Pay ပုံ</label>
                                <input type="file" id="kpayFile" accept="image/*" class="mt-1 w-full p-1 border rounded-lg text-xs">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary w-full py-2 rounded-lg font-semibold text-sm">Payment Method ပုံများ အပ်ဒိတ်လုပ်ရန်</button>
                    </form>
                </div>
            `;
        };

        const updatePaymentMethodImages = async () => {
            if (!isAdmin) return showMessage('Admin only function', 'error');
            
            const wavepayFile = document.getElementById('wavepayFile').files[0];
            const kpayFile = document.getElementById('kpayFile').files[0];
            
            if (!wavepayFile && !kpayFile) {
                return showMessage('Select at least one image', 'error');
            }

            document.getElementById('loading-overlay').classList.remove('hidden');
            let updatedImages = {};

            try {
                if (wavepayFile) {
                    updatedImages.wavepay = await uploadToCloudinary(wavepayFile);
                }
                if (kpayFile) {
                    updatedImages.kpay = await uploadToCloudinary(kpayFile);
                }

                const docRef = doc(db, PUBLIC_DATA_PATH, 'config', 'paymentMethods');
                await updateDoc(docRef, updatedImages);
                showMessage('Payment method images updated successfully', 'success');

            } catch (e) {
                console.error("Error updating payment method images: ", e);
                showMessage('Error updating payment method images', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        const updateRates = async () => {
            if (!isAdmin) return showMessage('Admin only function', 'error');

            const thbFor100kMMK = parseFloat(document.getElementById('rateBuyMMKInput').value);
            const thbFor100kMMK_reverse = parseFloat(document.getElementById('rateBuyTHBInput').value);
            const thbHomeDelivery_TO_MMK = parseFloat(document.getElementById('rateHomeDeliveryTHBInput').value);
            const thbHomeDelivery_MMK_TO_THB = parseFloat(document.getElementById('rateHomeDeliveryMMKInput').value);
            
            if (isNaN(thbFor100kMMK) || isNaN(thbFor100kMMK_reverse) || isNaN(thbHomeDelivery_TO_MMK) || isNaN(thbHomeDelivery_MMK_TO_THB)) {
                return showMessage('Please enter valid rates', 'error');
            }

            const rateBuyMMK = 100000 / thbFor100kMMK;
            const rateBuyTHB = 100000 / thbFor100kMMK_reverse;
            const rateHomeDeliveryTHB_TO_MMK = thbHomeDelivery_TO_MMK;
            const rateHomeDeliveryMMK_TO_THB = 100000 / thbHomeDelivery_MMK_TO_THB;

            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                const docRef = doc(db, PUBLIC_DATA_PATH, 'rates', 'current');
                await updateDoc(docRef, { 
                    rateBuyMMK, 
                    rateBuyTHB,
                    rateHomeDeliveryTHB_TO_MMK,
                    rateHomeDeliveryMMK_TO_THB,
                    lastUpdated: serverTimestamp() 
                });
                showMessage('Rates updated successfully', 'success');
            } catch (e) {
                console.error("Error updating rates: ", e);
                showMessage('Error updating rates', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Transfer Screen ---
        const renderTransfer = () => {
            const content = document.getElementById('content-area');
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="card p-5 rounded-xl border border-blue-400/50">
                        <h2 class="text-xl font-bold text-blue-400 mb-3">MyanmarPay ငွေလွဲမှု အမျိုးအစား</h2>
                        <p class="text-sm text-gray-300 mb-2">MyanmarPay မှ ပေးထားသော QR/ဖုန်းနံပါတ်သို့ ငွေပို့ပြီးမှ ဖောင်ဖြည့်ပါ။</p>
                    </div>

                    <!-- Tabs for Transfer Type -->
                    <div class="flex border-b border-gray-700">
                        <button id="tab-account" onclick="setTransferTab('account')" 
                                class="tab-button flex-1 py-3 text-sm font-medium text-gray-400 hover:text-emerald-400 ${currentTransferTab === 'account' ? 'active' : ''}">
                            <i class="fa-solid fa-wallet mr-2"></i> ${currentLanguage === 'my' ? 'အကောင့်သို့ ငွေလွဲရန်' : 'Account Transfer'}
                        </button>
                        <button id="tab-home" onclick="setTransferTab('home')" 
                                class="tab-button flex-1 py-3 text-sm font-medium text-gray-400 hover:text-emerald-400 ${currentTransferTab === 'home' ? 'active' : ''}">
                            <i class="fa-solid fa-house-chimney-user mr-2"></i> ${currentLanguage === 'my' ? 'အိမ်အရောက် ပို့ရန်' : 'Home Delivery'}
                        </button>
                    </div>

                    <!-- Transfer Form Section -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-xl font-bold mb-4" id="transfer-form-title">${currentTransferTab === 'account' ? (currentLanguage === 'my' ? 'အကောင့်သို့ ငွေလွဲရန်' : 'Account Transfer') : (currentLanguage === 'my' ? 'အိမ်အရောက် ပို့ရန်' : 'Home Delivery')} ${t('transferFormTitle')}</h2>
                        <form id="transfer-form" onsubmit="event.preventDefault(); submitTransfer('${currentTransferTab}')">
                            <div class="space-y-4">
                                
                                <!-- Payment Method Selection with Images (ONLY for Account Tab) -->
                                <div id="payment-method-field" class="${currentTransferTab === 'account' ? '' : 'hidden'}">
                                    <label class="block text-sm font-medium mb-2">${t('paymentMethod')}</label>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <label class="cursor-pointer">
                                            <input type="radio" name="paymentMethod" value="wavepay" class="hidden peer" required>
                                            <div class="card p-4 text-center peer-checked:border-emerald-500 peer-checked:border-2">
                                                <img src="${paymentMethodImages.wavepay}" class="payment-image mb-2 mx-auto" alt="Wave Pay">
                                                <p class="text-sm font-medium">Wave Pay</p>
                                            </div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="paymentMethod" value="kpay" class="hidden peer" required>
                                            <div class="card p-4 text-center peer-checked:border-emerald-500 peer-checked:border-2">
                                                <img src="${paymentMethodImages.kpay}" class="payment-image mb-2 mx-auto" alt="K Pay">
                                                <p class="text-sm font-medium">K Pay</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="senderName" class="block text-sm font-medium">${t('senderName')}</label>
                                        <input type="text" id="senderName" required class="mt-1 w-full p-2 border rounded-lg" placeholder="Aung Aung">
                                    </div>
                                    <div>
                                        <label for="receiverName" class="block text-sm font-medium">${t('receiverName')}</label>
                                        <input type="text" id="receiverName" required class="mt-1 w-full p-2 border rounded-lg" placeholder="Ma Ma">
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="senderPhoneTH" class="block text-sm font-medium">${t('senderPhone')}</label>
                                        <input type="tel" id="senderPhoneTH" required class="mt-1 w-full p-2 border rounded-lg" placeholder="09xxxxxxxxx">
                                    </div>
                                    <div>
                                        <label for="receiverPhoneMM" class="block text-sm font-medium">${t('receiverPhone')}</label>
                                        <input type="tel" id="receiverPhoneMM" required class="mt-1 w-full p-2 border rounded-lg" placeholder="09xxxxxxxxx">
                                    </div>
                                </div>
                                
                                <!-- Amount Input -->
                                <div>
                                    <label for="amountInput" class="block text-sm font-medium">${t('amount')}</label>
                                    <div class="mt-1 flex rounded-lg shadow-sm">
                                        <select id="amountDirection" onchange="updateCalculatedAmount()" class="p-2 border border-r-0 rounded-l-lg focus:ring-emerald-500 focus:border-emerald-500">
                                            ${currentTransferTab === 'account' ? 
                                                `<option value="THB_MMK">${t('baht')} ➜ ${t('kyat')}</option>` : 
                                                `<option value="THB_MMK">${t('baht')} ➜ ${t('kyat')}</option><option value="MMK_THB">${t('kyat')} ➜ ${t('baht')}</option>`
                                            }
                                        </select>
                                        <input type="number" id="amountInput" step="0.01" min="1" required class="flex-grow p-2 border focus:ring-emerald-500 focus:border-emerald-500" placeholder="1000">
                                    </div>
                                    <p id="calculated-amount" class="mt-1 text-sm text-emerald-400 font-medium">
                                        ${t('calculatedAmount')} 0.00
                                    </p>
                                </div>
                                
                                <!-- Bank QR Upload (ONLY for Account Tab) -->
                                <div id="bank-qr-field" class="${currentTransferTab === 'account' ? '' : 'hidden'}">
                                    <label for="bankQrFile" class="block text-sm font-medium text-blue-400">${t('bankQr')}</label>
                                    <input type="file" id="bankQrFile" accept="image/*" ${currentTransferTab === 'account' ? 'required' : ''} class="mt-1 w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-blue-400 hover:file:bg-gray-500">
                                    <p class="text-xs text-blue-400 mt-1">** ${currentLanguage === 'my' ? 'ငွေလက်ခံမည့်သူ၏ ဘဏ်အကောင့် QR ပုံကို ထည့်သွင်းပေးပါ' : 'Upload the receiver\'s bank account QR code'}</p>
                                </div>

                                <!-- Home Delivery Specific Field -->
                                <div id="home-address-field" class="${currentTransferTab === 'home' ? '' : 'hidden'}">
                                    <label for="deliveryAddress" class="block text-sm font-medium text-red-400">${t('deliveryAddress')}</label>
                                    <textarea id="deliveryAddress" rows="3" ${currentTransferTab === 'home' ? 'required' : ''} class="mt-1 w-full p-2 border rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="${currentLanguage === 'my' ? 'လက်ခံမည့်သူ၏ လိပ်စာ အပြည့်အစုံ' : 'Complete delivery address'}"></textarea>
                                </div>

                                <!-- Receipt File Upload -->
                                <div>
                                    <label for="receiptFile" class="block text-sm font-medium">${t('receipt')}</label>
                                    <input type="file" id="receiptFile" accept="image/*" required class="mt-1 w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-emerald-400 hover:file:bg-gray-500">
                                    <p class="text-xs text-red-400 mt-1">** ${currentLanguage === 'my' ? 'လွဲပြီးကြောင်း အတည်ပြုရန်အတွက် ပုံဖိုင်ကို မဖြစ်မနေ ထည့်သွင်းပေးရပါမည်။' : 'Receipt image is required for verification'}</p>
                                </div>
                                
                            </div>
                            
                            <button type="submit" class="btn-primary w-full py-3 rounded-lg mt-6 text-lg font-semibold">${t('submit')}</button>
                        </form>
                    </div>
                </div>
            `;
            setTimeout(() => { updateCalculatedAmount(); }, 0);
            document.getElementById('amountInput').addEventListener('input', updateCalculatedAmount);
            document.getElementById('amountDirection').addEventListener('change', updateCalculatedAmount);
        };

        const updateCalculatedAmount = () => {
            const input = parseFloat(document.getElementById('amountInput').value);
            const direction = document.getElementById('amountDirection').value;
            const output = document.getElementById('calculated-amount');
            
            if (isNaN(input) || input <= 0) {
                output.textContent = `${t('calculatedAmount')} 0.00`;
                return;
            }

            let result, fromCurrency, toCurrency;
            
            if (direction === 'THB_MMK') {
                result = input * (currentTransferTab === 'home' ? (100000 / currentRates.rateHomeDeliveryTHB_TO_MMK) : currentRates.THB_TO_MMK);
                fromCurrency = t('baht');
                toCurrency = t('kyat');
            } else {
                result = input / (currentTransferTab === 'home' ? currentRates.rateHomeDeliveryMMK_TO_THB : currentRates.MMK_TO_THB);
                fromCurrency = t('kyat');
                toCurrency = t('baht');
            }
            
            output.textContent = `${input.toFixed(2)} ${fromCurrency} ${currentLanguage === 'my' ? 'သည် ရရှိမည့်ပမာဏ:' : 'will give you:'} ${result.toFixed(2)} ${toCurrency}`;
        };

        const setTransferTab = (tab) => {
            currentTransferTab = tab;
            
            document.getElementById('tab-account').classList.remove('active');
            document.getElementById('tab-home').classList.remove('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.getElementById('transfer-form-title').textContent = `${tab === 'account' ? (currentLanguage === 'my' ? 'အကောင့်သို့ ငွေလွဲရန်' : 'Account Transfer') : (currentLanguage === 'my' ? 'အိမ်အရောက် ပို့ရန်' : 'Home Delivery')} ${t('transferFormTitle')}`;
            
            const paymentMethodField = document.getElementById('payment-method-field');
            const bankQrField = document.getElementById('bank-qr-field');
            const bankQrInput = document.getElementById('bankQrFile');
            const addressField = document.getElementById('home-address-field');
            const addressInput = document.getElementById('deliveryAddress');
            const amountDirection = document.getElementById('amountDirection');

            if (tab === 'account') {
                paymentMethodField.classList.remove('hidden');
                bankQrField.classList.remove('hidden');
                bankQrInput.setAttribute('required', 'required');
                addressField.classList.add('hidden');
                addressInput.removeAttribute('required');
                // Only show THB to MMK for account transfer
                amountDirection.innerHTML = `<option value="THB_MMK">${t('baht')} ➜ ${t('kyat')}</option>`;
            } else {
                paymentMethodField.classList.add('hidden');
                bankQrField.classList.add('hidden');
                bankQrInput.removeAttribute('required');
                addressField.classList.remove('hidden');
                addressInput.setAttribute('required', 'required');
                // Show both directions for home delivery
                amountDirection.innerHTML = `<option value="THB_MMK">${t('baht')} ➜ ${t('kyat')}</option><option value="MMK_THB">${t('kyat')} ➜ ${t('baht')}</option>`;
            }
            
            document.getElementById('transfer-form').onsubmit = (e) => {
                e.preventDefault();
                submitTransfer(currentTransferTab);
            };
            
            // Update calculated amount when tab changes
            updateCalculatedAmount();
        };

        const submitTransfer = async (transferType) => {
            if (!userId) return showMessage('User not authenticated', 'error');

            const form = document.getElementById('transfer-form');
            const paymentMethod = transferType === 'account' ? document.querySelector('input[name="paymentMethod"]:checked')?.value : 'N/A';
            const senderName = document.getElementById('senderName').value;
            const senderPhoneTH = document.getElementById('senderPhoneTH').value;
            const receiverName = document.getElementById('receiverName').value;
            const receiverPhoneMM = document.getElementById('receiverPhoneMM').value;
            const amountInput = parseFloat(document.getElementById('amountInput').value);
            const amountDirection = document.getElementById('amountDirection').value;
            const receiptFileInput = document.getElementById('receiptFile');
            const receiptFile = receiptFileInput.files[0];
            const bankQrFileInput = document.getElementById('bankQrFile');
            const bankQrFile = transferType === 'account' ? bankQrFileInput.files[0] : null;
            
            let deliveryAddress = '';
            if (transferType === 'home') {
                deliveryAddress = document.getElementById('deliveryAddress').value;
            }
            
            if (isNaN(amountInput) || amountInput <= 0 || !receiptFile) {
                return showMessage('Please enter valid amount and upload receipt', 'error');
            }

            if (transferType === 'account' && !paymentMethod) {
                return showMessage('Please select payment method', 'error');
            }

            if (transferType === 'account' && !bankQrFile) {
                return showMessage('Please upload bank QR code', 'error');
            }

            let amountTHB, amountMMK;
            if (amountDirection === 'THB_MMK') {
                amountTHB = amountInput;
                amountMMK = amountInput * (transferType === 'home' ? (100000 / currentRates.rateHomeDeliveryTHB_TO_MMK) : currentRates.THB_TO_MMK);
            } else {
                amountMMK = amountInput;
                amountTHB = amountInput / (transferType === 'home' ? currentRates.rateHomeDeliveryMMK_TO_THB : currentRates.MMK_TO_THB);
            }

            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                let receiptImageURL = '';
                receiptImageURL = await uploadToCloudinary(receiptFile);

                let bankQrImageURL = '';
                if (transferType === 'account' && bankQrFile) {
                    bankQrImageURL = await uploadToCloudinary(bankQrFile);
                }

                const transfersColRef = collection(db, PUBLIC_DATA_PATH, 'transfers');
                const newTransferRef = doc(transfersColRef);
                
                const transferData = {
                    senderId: userId,
                    senderEmail: userEmail,
                    senderName,
                    senderPhoneTH,
                    receiverName,
                    receiverPhoneMM,
                    transferAccountType: paymentMethod, 
                    amountTHB: parseFloat(amountTHB.toFixed(2)),
                    amountMMK: parseFloat(amountMMK.toFixed(2)),
                    transferDirection: amountDirection,
                    transferType: transferType, 
                    deliveryAddress: deliveryAddress || 'N/A', 
                    receiptImageURL, 
                    bankQrImageURL: bankQrImageURL || 'N/A',
                    timestamp: serverTimestamp(),
                    status: 'Pending',
                    adminReply: { message: '', imageURL: '' }
                };
                
                await setDoc(newTransferRef, transferData);

                // Send notification to admin with ALL user data
                const adminNotificationSuccess = await sendAdminNotification(newTransferRef.id, transferData);
                
                if (adminNotificationSuccess) {
                    console.log('Admin notification sent successfully');
                } else {
                    console.log('Failed to send admin notification');
                }
                
                // Send confirmation notification to user
                await sendUserNotification(
                    userId,
                    currentLanguage === 'my' ? 'ငွေလွဲမှု တောင်းဆိုချက် ပို့ပြီးပါပြီ' : 'Transfer Request Submitted',
                    currentLanguage === 'my' ? 
                        `သင်၏ ${amountTHB.toFixed(2)} ဘတ် ➜ ${amountMMK.toFixed(2)} ကျပ် ငွေလွဲမှုအား လက်ခံရရှိပါသည်။ Admin မှ စစ်ဆေးပြီး ပြန်လည်အကြောင်းကြားပေးပါမည်။` :
                        `Your transfer of ${amountTHB.toFixed(2)} THB ➜ ${amountMMK.toFixed(2)} MMK has been received. Admin will review and notify you.`,
                    '',
                    newTransferRef.id
                );

                form.reset();
                updateCalculatedAmount(); 
                showMessage(currentLanguage === 'my' ? 'ငွေလွဲမှု တောင်းဆိုချက် အောင်မြင်စွာ ပို့ပြီးပါပြီ။' : 'Transfer request submitted successfully', 'success');
                showScreen('home');

            } catch (e) {
                console.error("Error in transfer process (Upload or Firestore): ", e);
                let errorMessage = currentLanguage === 'my' ? 'ငွေလွဲမှု တောင်းဆိုချက် ပို့ရာတွင် အမှားရှိပါသည်' : 'Error submitting transfer request';
                showMessage(errorMessage, 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Admin Panel Functions ---
        const renderAdminPanel = () => {
            if (!isAdmin) return showScreen('home');
            
            const pendingTransfers = adminTransfers.filter(t => t.status === 'Pending');
            const unreadAdminNotifications = adminNotifications.filter(n => !n.isRead);
            
            const content = document.getElementById('content-area');

            content.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-red-400">${t('adminPanel')} (${pendingTransfers.length})</h2>
                    <p class="text-sm text-gray-400">${t('pending')}</p>
                    
                    <!-- Admin Notifications -->
                    ${unreadAdminNotifications.length > 0 ? `
                        <div class="card p-4 rounded-xl border-2 border-yellow-500">
                            <h3 class="text-lg font-bold text-yellow-400 mb-2">${t('adminNotifications')} (${unreadAdminNotifications.length})</h3>
                            <div class="space-y-2">
                                ${unreadAdminNotifications.slice(0, 3).map(n => `
                                    <div class="p-3 bg-gray-700 rounded-lg">
                                        <p class="font-medium">${n.title}</p>
                                        <p class="text-sm text-gray-300">${n.message}</p>
                                        <p class="text-xs text-gray-500 mt-1">${n.timestamp ? n.timestamp.toDate().toLocaleString('my-MM') : ''}</p>
                                        <button onclick="markAdminNotificationAsRead('${n.id}')" class="text-xs text-blue-400 hover:text-blue-300 mt-2">
                                            ${t('markAllRead')}
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            ${unreadAdminNotifications.length > 3 ? `
                                <p class="text-sm text-gray-400 mt-2">+ ${unreadAdminNotifications.length - 3} more notifications</p>
                            ` : ''}
                        </div>
                    ` : ''}

                    <div id="admin-transfers-list" class="space-y-3">
                        ${pendingTransfers.length === 0 ? 
                            '<p class="text-gray-400 p-4 card rounded-lg text-center">' + t('noTransfers') + '</p>' :
                            pendingTransfers.map(t => `
                                <div onclick="renderAdminTransferDetail('${t.id}')" class="card p-4 rounded-xl cursor-pointer hover:bg-gray-700 transition duration-150">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-bold text-lg text-emerald-400">${t.senderName || 'N/A'}</p>
                                            <p class="text-xs text-gray-400">${t.senderEmail} (ID: ${t.senderId?.substring(0, 8)}...)</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-sm font-semibold px-2 py-1 rounded-full ${t.transferType === 'home' ? 'bg-red-600' : 'bg-blue-600'} text-white">
                                                ${t.transferType === 'home' ? (currentLanguage === 'my' ? 'အိမ်အရောက် ပို့ရန်' : 'Home Delivery') : (currentLanguage === 'my' ? 'အကောင့်သို့ ငွေလွဲ' : 'Account Transfer')}
                                            </span>
                                            <p class="text-xs mt-1">${t.amountTHB} ${t('baht')} ➜ ${t.amountMMK} ${t('kyat')}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                    
                    <!-- Auto Delete Section -->
                    <div class="card p-4 rounded-xl border border-yellow-500/50">
                        <h3 class="text-lg font-semibold text-yellow-400 mb-2">အလိုအလျောက် ဖျက်သိမ်းခြင်း</h3>
                        <p class="text-sm text-gray-300">ငွေလွဲစာရင်းများကို ၇ ရက်ကျော်သွားပါက အလိုအလျောက် ဖျက်သိမ်းပါမည်။</p>
                        <button onclick="autoDeleteOldTransfers()" class="w-full py-2 rounded-lg font-semibold bg-yellow-600 text-white mt-3 hover:bg-yellow-500">
                            <i class="fa-solid fa-trash-can mr-2"></i> လက်ရှိ ၇ ရက်ကျော်သော စာရင်းများ ဖျက်ရန်
                        </button>
                    </div>
                </div>
            `;
        };

        const renderAdminTransferDetail = (transferId) => {
            const transfer = adminTransfers.find(t => t.id === transferId);
            if (!transfer) return showMessage('Transfer not found', 'error');

            const content = document.getElementById('content-area');
            const transferTypeLabel = transfer.transferType === 'home' ? 
                (currentLanguage === 'my' ? 'အိမ်အရောက် ပို့ရန်' : 'Home Delivery') : 
                (currentLanguage === 'my' ? 'အကောင့်သို့ ငွေလွဲ' : 'Account Transfer');
            const date = transfer.timestamp ? transfer.timestamp.toDate().toLocaleString('my-MM') : 'N/A';
            
            content.innerHTML = `
                <div class="space-y-6">
                    <button onclick="showScreen('admin')" class="text-blue-400 hover:text-blue-300 mb-4"><i class="fa-solid fa-arrow-left mr-2"></i> ${currentLanguage === 'my' ? 'စီမံခန့်ခွဲမှု သို့ ပြန်သွားရန်' : 'Back to Admin Panel'}</button>
                    
                    <h2 class="text-2xl font-bold text-red-400">${t('transferDetail')} - (${transferTypeLabel})</h2>
                    <div class="card p-5 rounded-xl space-y-3">
                        <p><strong>${currentLanguage === 'my' ? 'ငွေလွဲသူ (Name):' : 'Sender:'}</strong> ${transfer.senderName}</p>
                        <p><strong>Email:</strong> ${transfer.senderEmail}</p>
                        <p><strong>User ID:</strong> ${transfer.senderId}</p>
                        <p><strong>${currentLanguage === 'my' ? 'Phone (TH):' : 'Phone (TH):'}</strong> ${transfer.senderPhoneTH}</p>
                        <p><strong>${currentLanguage === 'my' ? 'လက်ခံသူ (Name):' : 'Receiver:'}</strong> ${transfer.receiverName}</p>
                        <p><strong>${currentLanguage === 'my' ? 'Phone (MM):' : 'Phone (MM):'}</strong> ${transfer.receiverPhoneMM}</p>
                        <p><strong>${currentLanguage === 'my' ? 'Amount:' : 'Amount:'}</strong> ${transfer.amountTHB.toFixed(2)} ${t('baht')} ➜ ${transfer.amountMMK.toFixed(2)} ${t('kyat')}</p>
                        <p><strong>${currentLanguage === 'my' ? 'Type:' : 'Type:'}</strong> ${transferTypeLabel} (${transfer.transferAccountType})</p>
                        <p class="text-red-400"><strong>${currentLanguage === 'my' ? 'ပို့ရမည့်လိပ်စာ:' : 'Delivery Address:'}</strong> ${transfer.deliveryAddress || 'N/A'}</p>
                        <p><strong>${currentLanguage === 'my' ? 'ရက်စွဲ:' : 'Date:'}</strong> ${date}</p>
                        <p><strong>${currentLanguage === 'my' ? 'Status:' : 'Status:'}</strong> <span class="font-bold text-yellow-400">${transfer.status}</span></p>
                    </div>

                    <!-- Receipt Image and Download -->
                    <div class="card p-5 rounded-xl space-y-3">
                        <h3 class="text-xl font-bold mb-2">${currentLanguage === 'my' ? 'ငွေပို့စလစ်ပုံ' : 'Transfer Receipt'}</h3>
                        <img src="${transfer.receiptImageURL}" onerror="this.src='https://placehold.co/400x200/374151/ffffff?text=No+Receipt'" class="w-full rounded-lg object-cover border border-gray-600 max-h-48" alt="[Image of Transfer Receipt]">
                        <button onclick="downloadImage('${transfer.receiptImageURL}')" class="w-full flex items-center justify-center p-2 text-sm bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                            <i class="fa-solid fa-download mr-2"></i> ${t('download')}
                        </button>
                    </div>

                    ${transfer.bankQrImageURL && transfer.bankQrImageURL !== 'N/A' ? `
                    <!-- Bank QR Image and Download -->
                    <div class="card p-5 rounded-xl space-y-3">
                        <h3 class="text-xl font-bold mb-2 text-blue-400">${currentLanguage === 'my' ? 'ငွေလက်ခံမည့်သူ၏ ဘဏ် QR ပုံ' : 'Receiver\'s Bank QR Code'}</h3>
                        <img src="${transfer.bankQrImageURL}" onerror="this.src='https://placehold.co/400x200/374151/ffffff?text=No+Bank+QR'" class="w-full rounded-lg object-cover border border-gray-600 max-h-48" alt="[Image of Bank QR]">
                        <button onclick="downloadImage('${transfer.bankQrImageURL}')" class="w-full flex items-center justify-center p-2 text-sm bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                            <i class="fa-solid fa-download mr-2"></i> ${t('download')}
                        </button>
                    </div>
                    ` : ''}

                    <!-- Admin Reply Form -->
                    <div class="card p-5 rounded-xl space-y-3">
                        <h3 class="text-xl font-bold mb-2 text-emerald-400">${t('reply')}</h3>
                        <form id="admin-reply-form" onsubmit="event.preventDefault(); sendAdminReply('${transfer.id}')">
                            <div>
                                <label for="replyMessage" class="block text-sm font-medium">${currentLanguage === 'my' ? 'စာသား' : 'Message'}</label>
                                <textarea id="replyMessage" rows="2" class="mt-1 w-full p-2 border rounded-lg" placeholder="${currentLanguage === 'my' ? 'ငွေလွဲမှု အတည်ပြုချက် သို့မဟုတ် မက်ဆေ့ခ်ျ' : 'Transfer confirmation or message'}"></textarea>
                            </div>
                            <div>
                                <label for="replyImage" class="block text-sm font-medium">${currentLanguage === 'my' ? 'ပုံ ပြန်ပို့ရန် (ရွေးချယ်ရန်)' : 'Reply with image (optional)'}</label>
                                <input type="file" id="replyImage" accept="image/*" class="mt-1 w-full p-2 border rounded-lg file:bg-gray-600 file:text-emerald-400">
                            </div>
                            <button type="submit" class="w-full py-2 rounded-lg font-semibold bg-emerald-600 text-white mt-3 hover:bg-emerald-500">
                                <i class="fa-solid fa-reply mr-2"></i> ${t('sendReply')}
                            </button>
                        </form>
                    </div>

                    <!-- Complete Button -->
                    <button onclick="completeTransfer('${transfer.id}')" class="w-full py-3 rounded-lg font-bold bg-green-600 text-white hover:bg-green-500">
                        <i class="fa-solid fa-check-circle mr-2"></i> ${t('complete')}
                    </button>
                </div>
            `;
        };

        const sendAdminReply = async (transferId) => {
            if (!isAdmin) return;
            const transfer = adminTransfers.find(t => t.id === transferId);
            if (!transfer) return;
            
            const message = document.getElementById('replyMessage').value.trim();
            const imageFile = document.getElementById('replyImage').files[0];

            if (!message && !imageFile) return showMessage('Please enter message or upload image', 'error');

            document.getElementById('loading-overlay').classList.remove('hidden');

            let replyImageURL = '';
            
            try {
                if (imageFile) {
                    replyImageURL = await uploadToCloudinary(imageFile);
                }

                // Send notification to user
                await sendUserNotification(
                    transfer.senderId,
                    currentLanguage === 'my' ? 'Admin မှ ပြန်ကြားချက်' : 'Admin Reply',
                    message || (currentLanguage === 'my' ? 'ပုံဖြင့် အကြောင်းပြန်ကြားထားပါသည်။' : 'Reply with image'),
                    replyImageURL,
                    transferId
                );

                // Update transfer with admin reply
                await updateDoc(doc(db, PUBLIC_DATA_PATH, 'transfers', transferId), { 
                    adminReply: {
                        message: message,
                        imageURL: replyImageURL,
                        timestamp: serverTimestamp()
                    }
                });

                if (message.includes('Completed') || message.includes('ပြီးပါပြီ')) {
                    await updateDoc(doc(db, PUBLIC_DATA_PATH, 'transfers', transferId), { status: 'Completed' });
                    
                    // Send completion notification to user
                    await sendUserNotification(
                        transfer.senderId,
                        currentLanguage === 'my' ? '✅ ငွေလွဲမှု အောင်မြင်ပါသည်။' : '✅ Transfer Completed',
                        currentLanguage === 'my' ? 
                            `သင့်၏ ${transfer.amountTHB.toFixed(2)} ဘတ် ➜ ${transfer.amountMMK.toFixed(0)} ကျပ် ငွေလွဲမှု အောင်မြင်စွာ ပြီးဆုံးပါပြီ။` :
                            `Your transfer of ${transfer.amountTHB.toFixed(2)} THB ➜ ${transfer.amountMMK.toFixed(0)} MMK has been completed successfully.`,
                        '',
                        transferId
                    );
                }

                showMessage(currentLanguage === 'my' ? 'User သို့ အကြောင်းပြန်ကြားချက် ပို့ပြီးပါပြီ။' : 'Reply sent to user', 'success');
                document.getElementById('admin-reply-form').reset();
            } catch (e) {
                console.error("Error sending reply: ", e);
                showMessage(currentLanguage === 'my' ? 'ပြန်ပို့ရာတွင် အမှားရှိသည်' : 'Error sending reply', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };
        
        const completeTransfer = async (transferId) => {
            if (!isAdmin) return;
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                await updateDoc(doc(db, PUBLIC_DATA_PATH, 'transfers', transferId), { status: 'Completed' });
                
                const transfer = adminTransfers.find(t => t.id === transferId);
                
                // Send completion notification to user
                await sendUserNotification(
                    transfer.senderId,
                    currentLanguage === 'my' ? '✅ ငွေလွဲမှု အောင်မြင်ပါသည်။' : '✅ Transfer Completed',
                    currentLanguage === 'my' ? 
                        `သင့်၏ ${transfer.amountTHB.toFixed(2)} ဘတ် ➜ ${transfer.amountMMK.toFixed(0)} ကျပ် ငွေလွဲမှု အောင်မြင်စွာ ပြီးဆုံးပါပြီ။` :
                        `Your transfer of ${transfer.amountTHB.toFixed(2)} THB ➜ ${transfer.amountMMK.toFixed(0)} MMK has been completed successfully.`,
                    '',
                    transferId
                );

                showMessage(currentLanguage === 'my' ? 'ငွေလွဲမှု ပြီးဆုံးကြောင်း အတည်ပြုပြီးပါပြီ။' : 'Transfer marked as completed', 'success');
                showScreen('admin');
            } catch (e) {
                console.error("Error completing transfer: ", e);
                showMessage(currentLanguage === 'my' ? 'အတည်ပြုရာတွင် အမှားရှိသည်' : 'Error completing transfer', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Inbox Screen ---
        const renderInbox = () => {
            const content = document.getElementById('content-area');
            
            content.innerHTML = `
                <div class="space-y-6" id="inbox-content">
                    <h2 class="text-2xl font-bold text-emerald-400">${t('inboxTitle')}</h2>
                    <p class="text-sm text-gray-400">${currentLanguage === 'my' ? 'MyanmarPay မှ ပို့သော မက်ဆေ့ခ်ျများ' : 'Messages from MyanmarPay'}</p>
                    
                    <div id="notifications-list" class="space-y-3">
                        ${userNotifications.length === 0 ? 
                            '<p class="text-gray-400 p-4 card rounded-lg text-center">' + t('noNotifications') + '</p>' :
                            userNotifications.map(n => {
                                const date = n.timestamp ? n.timestamp.toDate().toLocaleString('my-MM') : 'N/A';
                                return `
                                    <div onclick="markNotificationAsRead('${n.id}')" class="card p-4 rounded-xl cursor-pointer transition duration-150 ${n.isRead ? 'opacity-80' : 'border-2 border-yellow-400'}">
                                        <div class="flex items-start">
                                            <i class="fa-solid fa-bell text-xl ${n.isRead ? 'text-gray-400' : 'text-yellow-400'} mr-3 mt-1"></i>
                                            <div class="flex-grow">
                                                <p class="font-bold ${n.isRead ? 'text-gray-200' : 'text-white'}">${n.title}</p>
                                                <p class="text-sm text-gray-400">${n.message}</p>
                                                ${n.imageURL ? `
                                                    <img src="${n.imageURL}" onerror="this.src='https://placehold.co/100x50/374151/ffffff?text=Image'" class="mt-2 rounded-lg max-h-20 object-contain border border-gray-600" alt="">
                                                    <a href="${n.imageURL}" target="_blank" onclick="event.stopPropagation();" class="text-xs text-blue-400 hover:text-blue-300 mt-1 inline-block"><i class="fa-solid fa-expand-alt mr-1"></i> ${currentLanguage === 'my' ? 'ပုံကြီးချဲ့ကြည့်ရန်' : 'View Image'}</a>
                                                ` : ''}
                                                <p class="text-xs text-gray-500 mt-2">${date}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                </div>
            `;
        };

        const markNotificationAsRead = async (id) => {
            if (!userId) return;
            try {
                const docRef = doc(db, `artifacts/${APP_ID}/users/${userId}`, 'notifications', id);
                await updateDoc(docRef, { isRead: true });
                loadNotifications(); // Refresh notifications
            } catch(e) {
                console.error("Error marking as read:", e);
            }
        };

        // --- Profile Screen ---
        const renderProfile = () => {
            console.log('Rendering profile...', { userId, userEmail, userTransfers: userTransfers.length });
            
            const user = auth.currentUser;
            const userEmail = user?.email || 'N/A';
            const userDisplayName = user?.displayName || '';

            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Profile Card -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-2xl font-bold mb-4">${t('profileTitle')}</h2>
                        
                        <div class="space-y-3">
                            <p><strong>${currentLanguage === 'my' ? 'Username:' : 'Username:'}</strong> ${userDisplayName || 'N/A'}</p>
                            <p><strong>Email:</strong> ${userEmail}</p>
                            <p><strong>User ID:</strong> ${userId ? userId.substring(0, 12) + '...' : 'N/A'}</p>
                        </div>
                        
                        <form id="update-profile-form" onsubmit="event.preventDefault(); updateProfileName()" class="mt-4 pt-4 border-t border-gray-600">
                            <label for="usernameInput" class="block text-sm font-medium">${t('updateProfile')}</label>
                            <input type="text" id="usernameInput" value="${userDisplayName}" placeholder="${t('username')}" class="mt-1 w-full p-2 border rounded-lg">
                            <button type="submit" class="btn-primary w-full py-2 rounded-lg mt-3 font-semibold">${t('updateProfile')}</button>
                        </form>

                        <!-- Logout Button under username update -->
                        <button onclick="handleLogout()" class="w-full py-2 rounded-lg font-bold bg-red-600 text-white mt-4 hover:bg-red-500">
                            <i class="fa-solid fa-sign-out-alt mr-2"></i> ${t('logout')}
                        </button>
                    </div>

                    <!-- Past Transfers Section -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-xl font-bold mb-3">${t('pastTransfers')}</h2>
                        <div id="profile-transfers-list" class="space-y-3">
                            ${renderProfileTransfers()}
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-xl font-bold mb-3">${t('settings')}</h2>
                        
                        <!-- Language Selection -->
                        <div class="flex justify-between items-center py-2 border-b border-gray-600">
                            <span class="font-medium">${t('language')}</span>
                            <select id="profile-language-select" onchange="setLanguage(this.value)" class="p-1 border rounded-lg bg-gray-600">
                                <option value="my" ${currentLanguage === 'my' ? 'selected' : ''}>မြန်မာ (Burmese)</option>
                                <option value="en" ${currentLanguage === 'en' ? 'selected' : ''}>English</option>
                            </select>
                        </div>

                        <!-- Contact Information -->
                        <div class="py-4 space-y-3">
                            <h3 class="text-lg font-semibold text-emerald-400 mb-2">${t('contact')}</h3>
                            
                            <div class="contact-link">
                                <a href="mailto:c388925@gmail.com" class="flex items-center text-blue-400 hover:text-blue-300 py-2">
                                    <i class="fa-solid fa-envelope mr-3 w-5 text-center"></i>
                                    <span>Email: c388925@gmail.com</span>
                                </a>
                            </div>
                            
                            <div class="contact-link">
                                <a href="tel:0926459800" class="flex items-center text-green-400 hover:text-green-300 py-2">
                                    <i class="fa-solid fa-phone mr-3 w-5 text-center"></i>
                                    <span>Phone: 0926459800</span>
                                </a>
                            </div>
                            
                            <div class="contact-link">
                                <a href="https://www.facebook.com/share/17qjePm9bA/" target="_blank" class="flex items-center text-blue-500 hover:text-blue-400 py-2">
                                    <i class="fa-brands fa-facebook mr-3 w-5 text-center"></i>
                                    <span>Facebook</span>
                                </a>
                            </div>
                            
                            <div class="contact-link">
                                <a href="https://t.me/@waiyanfelix" target="_blank" class="flex items-center text-blue-400 hover:text-blue-300 py-2">
                                    <i class="fa-brands fa-telegram mr-3 w-5 text-center"></i>
                                    <span>Telegram: @waiyanfelix</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderProfileTransfers = () => {
            console.log('Rendering profile transfers:', userTransfers.length);
            
            if (userTransfers.length === 0) {
                return '<p class="text-gray-400 text-center">' + t('noPastTransfers') + '</p>';
            }

            return userTransfers.slice(0, 5).map(t => {
                const date = t.timestamp ? t.timestamp.toDate().toLocaleString('my-MM') : 'N/A';
                const statusColor = t.status === 'Completed' ? 'bg-green-600' : (t.status === 'Pending' ? 'bg-yellow-600' : 'bg-red-600');
                const transferTypeLabel = t.transferType === 'home' ? 
                    (currentLanguage === 'my' ? 'အိမ်အရောက် ပို့ရန်' : 'Home Delivery') : 
                    (currentLanguage === 'my' ? 'အကောင့်သို့ ငွေလွဲ' : 'Account Transfer');

                return `
                    <div class="card p-3 rounded-xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-100">${t.amountTHB.toFixed(2)} ${t('baht')} ➜ ${t.amountMMK.toFixed(2)} ${t('kyat')}</p>
                                <p class="text-xs text-gray-400 mt-1">${transferTypeLabel} (${t.receiverName})</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColor} text-white">${t.status}</span>
                                <p class="text-xs text-gray-500 mt-1">${date}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        const updateProfileName = async () => {
            const usernameInput = document.getElementById('usernameInput').value.trim();
            if (!usernameInput) return showMessage('Please enter username', 'error');

            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await updateProfile(auth.currentUser, { displayName: usernameInput });
                showMessage('Username updated successfully', 'success');
                showScreen('profile');
            } catch (error) {
                console.error("Error updating profile:", error);
                showMessage('Error updating username', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Core Application Logic ---
        const showScreen = (screenName) => {
            if (!isAuthReady) {
                console.log('Auth not ready, showing loading...');
                const content = document.getElementById('content-area');
                content.innerHTML = `<p class="text-center text-gray-500">${t('loading')}</p>`;
                return;
            }

            if (screenName === 'admin' && !isAdmin) {
                screenName = 'home';
            }

            currentScreen = screenName;
            console.log('Showing screen:', screenName);

            // Update navigation buttons
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(btn => {
                if (btn.id !== 'admin-nav-button') {
                    btn.classList.remove('text-emerald-400');
                    btn.classList.add('text-gray-400');
                } else {
                    btn.classList.remove('text-red-400');
                }
            });

            const activeBtn = document.querySelector(`[onclick="showScreen('${screenName}')"]`);
            if (activeBtn) {
                if (screenName === 'admin') {
                    activeBtn.classList.add('text-red-400');
                    activeBtn.classList.remove('text-gray-400');
                } else {
                    activeBtn.classList.add('text-emerald-400');
                    activeBtn.classList.remove('text-gray-400');
                }
            }

            // Clear content area
            const content = document.getElementById('content-area');
            content.innerHTML = `<p class="text-center text-gray-500">${t('loading')}</p>`;

            // Render screen after short delay
            setTimeout(() => {
                try {
                    switch (screenName) {
                        case 'home':
                            renderHome();
                            break;
                        case 'transfer':
                            renderTransfer();
                            break;
                        case 'inbox':
                            renderInbox();
                            break;
                        case 'profile':
                            renderProfile();
                            break;
                        case 'admin':
                            renderAdminPanel();
                            break;
                        default:
                            renderHome();
                    }
                } catch (error) {
                    console.error('Error rendering screen:', error);
                    content.innerHTML = `
                        <div class="p-4 text-center">
                            <p class="text-red-400">Error loading screen: ${error.message}</p>
                            <button onclick="showScreen('home')" class="mt-4 px-4 py-2 bg-emerald-500 text-white rounded-lg">
                                Back to Home
                            </button>
                        </div>
                    `;
                }
            }, 100);
        };

        const setLanguage = (lang) => {
            currentLanguage = lang;
            localStorage.setItem('remittance_language', lang);
            
            // Update language selector
            const languageSelect = document.getElementById('language-select');
            if (languageSelect) languageSelect.value = lang;
            
            const profileLanguageSelect = document.getElementById('profile-language-select');
            if (profileLanguageSelect) profileLanguageSelect.value = lang;
            
            // Update app title
            const appTitle = document.getElementById('app-title');
            if (appTitle) appTitle.textContent = t('appTitle');
            
            // Update loading text
            const loadingText = document.getElementById('loading-text');
            if (loadingText) loadingText.textContent = t('loading');
            
            // Refresh current screen
            if (isAuthReady) {
                showScreen(currentScreen);
            }
            
            showMessage(currentLanguage === 'my' ? 'ဘာသာစကား ပြောင်းလဲမှု အောင်မြင်ပါသည်' : 'Language changed successfully', 'success');
        };

        // Start initialization
        initFirebase();

        // Load saved language
        const savedLanguage = localStorage.getItem('remittance_language') || 'my';
        setLanguage(savedLanguage);

        // Global functions
        window.renderAuthScreen = renderAuthScreen;
        window.handleAuthSubmit = handleAuthSubmit;
        window.handleLogout = async () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await signOut(auth);
                showMessage(currentLanguage === 'my' ? 'အောင်မြင်စွာ ထွက်ခွာခဲ့ပြီးပါပြီ။' : 'Logged out successfully', 'success');
            } catch (error) {
                showMessage(currentLanguage === 'my' ? 'ထွက်ခွာရန် အမှားရှိသည်' : 'Error logging out', 'error');
            }
        };
        window.updateRates = updateRates;
        window.showScreen = showScreen;
        window.setTransferTab = setTransferTab;
        window.submitTransfer = submitTransfer;
        window.updateCalculatedAmount = updateCalculatedAmount;
        window.renderAdminPanel = renderAdminPanel;
        window.renderAdminTransferDetail = renderAdminTransferDetail;
        window.sendAdminReply = sendAdminReply;
        window.completeTransfer = completeTransfer;
        window.markNotificationAsRead = markNotificationAsRead;
        window.updateProfileName = updateProfileName;
        window.downloadImage = downloadImage;
        window.updateBankImages = updateBankImages;
        window.updatePaymentMethodImages = updatePaymentMethodImages;
        window.autoDeleteOldTransfers = autoDeleteOldTransfers;
        window.setLanguage = setLanguage;
        window.markAdminNotificationAsRead = markAdminNotificationAsRead;

    </script>
</body>
</html>
