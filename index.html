<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #10B981;
            --primary-dark: #059669;
            --bg-dark: #1f2937;
            --text-dark: #f3f4f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
            border: 1px solid #4b5563;
        }

        input, select, textarea {
            background-color: #4b5563;
            color: var(--text-dark);
            border-color: #6b7280;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .scrollable-content {
            height: calc(100vh - 120px); 
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollable-content::-webkit-scrollbar {
            display: none;
        }
        
        .tab-button.active {
            border-bottom-width: 3px;
            border-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Global Modals and Overlays -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
            <p class="mt-4 text-white text-lg" id="loading-text">ဒေတာများ ဆွဲယူနေပါသည်...</p>
        </div>
    </div>
    
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-transform duration-300 transform translate-x-full"></div>

    <!-- Login/Sign Up Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <!-- Auth UI will be rendered here -->
    </div>
    
    <!-- Main App Content (Hidden until authenticated) -->
    <div id="app-content-wrapper" class="max-w-xl mx-auto min-h-screen flex flex-col hidden">
        <!-- Header -->
        <header id="app-header" class="p-4 pt-6 text-center">
            <h1 class="text-2xl font-extrabold" id="app-title">ထိုင်း-မြန်မာငွေလွဲ (ရေကျော်)</h1>
            <p id="user-info" class="text-sm mt-1 text-gray-500">Loading user...</p>
        </header>

        <!-- Content Area -->
        <main id="content-area" class="flex-grow p-4 scrollable-content">
            <!-- Content will be rendered here based on the current screen -->
        </main>

        <!-- Navigation Footer -->
        <footer id="nav-footer" class="sticky bottom-0 w-full max-w-xl mx-auto bg-gray-800 border-t border-gray-700 p-2 shadow-lg">
            <div class="flex justify-around text-xs font-medium" id="nav-container">
                <!-- Nav items will be generated here -->
            </div>
        </footer>
    </div>
    
    <!-- Firebase SDKs and Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // --- Cloudinary Configuration ---
        const CLOUDINARY_CLOUD_NAME = 'drizdw5nc';
        const CLOUDINARY_UPLOAD_PRESET = 'waiyansoe118234';
        
        // --- Firebase Configuration ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAUL74mqVCIY1MMclrRhdVbY_VyP4lgQpY",
            authDomain: "waiappstore.firebaseapp.com",
            projectId: "waiappstore",
            storageBucket: "waiappstore.firebasestorage.app",
            messagingSenderId: "161610339691",
            appId: "1:161610339691:web:ce59fafb6a21729030682e",
            measurementId: "G-HH95X102MG"
        };

        const ADMIN_EMAIL = 'c388925@gmail.com';
        const APP_ID = 'thai-myanmar-remittance';
        
        let app, db, auth;
        let userId = null, userEmail = null, isAdmin = false;
        let currentScreen = 'home', isAuthReady = false, currentTransferTab = 'account';

        // State for rates - ပြင်ဆင်ထားသော format
        let currentRates = {
            THB_TO_MMK: 121.95, // ၁ ဘတ်လျှင် ကျပ် (အကောင့်ထဲထည့်ဖို့ ၁သိန်းရရန်)
            MMK_TO_THB: 126.58, // ၁ သိန်းလျှင် ရမည့်ဘတ်
            rateHomeDeliveryTHB: 820, // အိမ်အရောက်ပို့ ၁သိန်းရရန် ဘတ်
            lastUpdated: 'Loading...'
        };

        let adminBankInfo = {
            image1URL: 'https://placehold.co/200x100/10B981/ffffff?text=Bank+QR+1',
            image2URL: 'https://placehold.co/200x100/60A5FA/ffffff?text=Bank+QR+2'
        };

        let transferDirection = 'THB_TO_MMK'; 
        let userTransfers = [];
        let adminTransfers = [];
        let userNotifications = [];

        // --- Utility Functions ---
        const showMessage = (msg, type = 'success') => {
            const box = document.getElementById('message-box');
            const color = type === 'success' ? 'bg-emerald-500' : 'bg-red-500';
            const html = `
                <div class="${color} text-white p-3 rounded-lg shadow-xl mb-3 text-sm" style="min-width: 250px;">
                    ${msg}
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const messageElement = tempDiv.firstChild;
            
            box.prepend(messageElement);
            box.classList.remove('translate-x-full');
            box.classList.add('translate-x-0');

            setTimeout(() => {
                messageElement.remove();
                if (box.children.length === 0) {
                    box.classList.remove('translate-x-0');
                    box.classList.add('translate-x-full');
                }
            }, 5000);
        };

        const downloadImage = (url) => {
            fetch(url, { mode: 'cors' })
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = `remittance_image_${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(blobUrl);
                    showMessage('ပုံကို အောင်မြင်စွာ သိမ်းဆည်းပြီးပါပြီ။');
                })
                .catch(error => {
                    console.error("Download error:", error);
                    showMessage('ပုံဒေါင်းလုတ်ဆွဲရာတွင် အမှားရှိပါသည်', 'error');
                });
        };

        // Cloudinary Upload Function
        const uploadToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            
            try {
                console.log('Uploading to Cloudinary...');
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Cloudinary upload failed: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Upload successful:', data.secure_url);
                return data.secure_url;
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                throw new Error(`ပုံတင်ရာတွင် အမှားရှိပါသည်: ${error.message}`);
            }
        };

        // --- Firebase Initialization and Auth ---
        const initFirebase = async () => {
            try {
                app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userEmail = user.email;
                        isAdmin = user.email === ADMIN_EMAIL;
                        
                        document.getElementById('user-info').textContent = `${user.displayName || user.email} (ID: ${userId.substring(0, 8)}...)`;
                        
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('app-content-wrapper').classList.remove('hidden');

                        if (!isAuthReady) {
                            isAuthReady = true;
                            updateStaticText();
                            loadRates();
                            loadAdminBankInfo();
                            loadTransfers();
                            loadNotifications();
                            showScreen('home'); 
                        }
                    } else {
                        isAuthReady = false;
                        userId = null;
                        userEmail = null;
                        isAdmin = false;
                        document.getElementById('app-content-wrapper').classList.add('hidden');
                        document.getElementById('auth-screen').classList.remove('hidden');
                        renderAuthScreen();
                    }
                    document.getElementById('loading-overlay').classList.add('hidden');
                });
                
                document.getElementById('loading-overlay').classList.remove('hidden');

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading-overlay').classList.add('hidden');
                showMessage(`Firebase အမှား: ${error.message}`, 'error');
            }
        };

        const renderAuthScreen = (isLogin = true) => {
            const authScreen = document.getElementById('auth-screen');
            authScreen.innerHTML = `
                <div class="card w-full max-w-sm p-8 rounded-xl space-y-6">
                    <h2 class="text-3xl font-bold text-center text-emerald-400">${isLogin ? 'အကောင့်ဝင်ရန်' : 'အကောင့်ဖွင့်ရန်'}</h2>
                    
                    <form id="auth-form" onsubmit="event.preventDefault(); handleAuthSubmit(${isLogin})">
                        ${!isLogin ? `
                            <div>
                                <label for="username" class="block text-sm font-medium mb-1">Username</label>
                                <input type="text" id="username" required class="w-full p-3 border rounded-lg" placeholder="သင့်အမည်">
                            </div>` : ''}
                        <div>
                            <label for="email" class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" id="email" required class="w-full p-3 border rounded-lg" placeholder="example@gmail.com">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="password" required class="w-full p-3 border rounded-lg" placeholder="လျှို့ဝှက်နံပါတ် (၆ လုံးအထက်)">
                        </div>
                        
                        <button type="submit" class="btn-primary w-full py-3 rounded-lg mt-4 font-bold">
                            ${isLogin ? 'အကောင့်ဝင်ရန်' : 'အကောင့်ဖွင့်ရန်'}
                        </button>
                    </form>
                    
                    <button onclick="renderAuthScreen(!${isLogin})" class="w-full text-sm text-center text-blue-400 hover:text-blue-300">
                        ${isLogin ? 'အကောင့်မရှိသေးဘူးလား? အကောင့်ဖွင့်ရန်' : 'အကောင့်ရှိပြီးသားလား? အကောင့်ဝင်ရန်'}
                    </button>
                </div>
            `;
        };

        const handleAuthSubmit = async (isLogin) => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = isLogin ? null : document.getElementById('username').value;
            
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage('အကောင့်ဝင်ခြင်း အောင်မြင်ပါသည်။');
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: username });
                    showMessage('အကောင့်ဖွင့်ခြင်း အောင်မြင်ပါသည်။');
                }
            } catch (error) {
                console.error("Auth Error:", error);
                let msg = 'အမှားရှိသည်';
                if (error.code === 'auth/invalid-email') msg = 'Email မှားယွင်းနေသည်။';
                else if (error.code === 'auth/wrong-password') msg = 'Password မှားယွင်းနေသည်။';
                else if (error.code === 'auth/user-not-found') msg = 'ဤအကောင့် မရှိပါ။';
                else if (error.code === 'auth/email-already-in-use') msg = 'ဤ Email ဖြင့် အကောင့်ဖွင့်ထားပြီးဖြစ်သည်။';
                else if (error.code === 'auth/weak-password') msg = 'Password မှာ အနည်းဆုံး ၆ လုံးရှိရမည်။';

                showMessage(msg, 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Firestore Data Handlers ---
        const PUBLIC_DATA_PATH = `artifacts/${APP_ID}/public/data`;
        const USER_DATA_PATH = (uid) => `artifacts/${APP_ID}/users/${uid}`;

        const updateStaticText = () => {
            const adminButtonHtml = isAdmin ? `
                <button onclick="showScreen('admin')" id="admin-nav-button" class="nav-button flex flex-col items-center p-2 rounded-lg text-red-400 hover:text-red-300">
                    <i class="fa-solid fa-screwdriver-wrench text-xl"></i>
                    <span class="mt-1">စီမံခန့်ခွဲမှု</span>
                </button>
            ` : '';

            const navContainer = document.getElementById('nav-container');
            navContainer.innerHTML = `
                <button onclick="showScreen('home')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-exchange-alt text-xl"></i>
                    <span class="mt-1">ငွေလဲနှုန်း</span>
                </button>
                <button onclick="showScreen('transfer')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-paper-plane text-xl"></i>
                    <span class="mt-1">ငွေလွဲရန်</span>
                </button>
                <button onclick="showScreen('inbox')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500 relative">
                    <i class="fa-solid fa-inbox text-xl"></i>
                    <span id="inbox-badge" class="absolute top-0 right-0 inline-block w-3 h-3 bg-red-500 rounded-full hidden"></span>
                    <span class="mt-1">အဝင်စာ</span>
                </button>
                <button onclick="showScreen('profile')" class="nav-button flex flex-col items-center p-2 rounded-lg text-gray-400 hover:text-emerald-500">
                    <i class="fa-solid fa-user-gear text-xl"></i>
                    <span class="mt-1">Profile</span>
                </button>
                ${adminButtonHtml}
            `;
            showScreen(currentScreen);
        };

        // --- Rate Management ---
        const loadRates = () => {
            const docRef = doc(db, PUBLIC_DATA_PATH, 'rates', 'current');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentRates.THB_TO_MMK = data.rateBuyMMK || 121.95;
                    currentRates.MMK_TO_THB = data.rateBuyTHB || 126.58;
                    currentRates.rateHomeDeliveryTHB = data.rateHomeDeliveryTHB || 820;
                    
                    const timestamp = data.lastUpdated;
                    if (timestamp) {
                        const date = timestamp.toDate();
                        currentRates.lastUpdated = date.toLocaleString('my-MM', {
                            year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                    } else {
                        currentRates.lastUpdated = 'ယခုလေးတင်';
                    }
                    if (currentScreen === 'home') renderHome();
                } else {
                    // Create initial rates document if it doesn't exist
                    setDoc(docRef, { 
                        rateBuyMMK: currentRates.THB_TO_MMK,
                        rateBuyTHB: currentRates.MMK_TO_THB,
                        rateHomeDeliveryTHB: currentRates.rateHomeDeliveryTHB,
                        lastUpdated: serverTimestamp() 
                    });
                }
            }, (error) => {
                console.error("Error fetching rates: ", error);
            });
        };

        const loadAdminBankInfo = () => {
            const docRef = doc(db, PUBLIC_DATA_PATH, 'config', 'bankInfo');
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    adminBankInfo.image1URL = data.image1URL || adminBankInfo.image1URL;
                    adminBankInfo.image2URL = data.image2URL || adminBankInfo.image2URL;
                    if (currentScreen === 'home') renderHome();
                } else {
                    setDoc(docRef, adminBankInfo, { merge: true });
                }
            }, (error) => console.error("Error fetching bank info: ", error));
        };

        // --- Transfers and Notifications ---
        const loadTransfers = () => {
            if (!isAuthReady || !userId) return;
            
            const transfersColRef = collection(db, PUBLIC_DATA_PATH, 'transfers');
            
            onSnapshot(transfersColRef, (snapshot) => {
                const transfers = [];
                snapshot.forEach((doc) => {
                    transfers.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('Loaded transfers:', transfers.length);
                
                // Admin transfers - all transfers
                adminTransfers = transfers.sort((a, b) => {
                    if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                    if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                    return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
                });

                // User transfers - only user's transfers
                userTransfers = transfers.filter(t => t.senderId === userId)
                                         .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                if (currentScreen === 'admin') renderAdminPanel();
                if (currentScreen === 'profile') renderProfile();

            }, (error) => {
                console.error("Error fetching transfers: ", error);
            });
        };

        const loadNotifications = () => {
            if (!isAuthReady || !userId) return;
            
            const notificationsColRef = collection(db, `artifacts/${APP_ID}/users/${userId}`, 'notifications');
            
            onSnapshot(notificationsColRef, (snapshot) => {
                userNotifications = [];
                snapshot.forEach((doc) => {
                    userNotifications.push({ id: doc.id, ...doc.data() });
                });
                
                userNotifications.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                const unreadCount = userNotifications.filter(n => !n.isRead).length;
                const badge = document.getElementById('inbox-badge');
                if (badge) {
                    badge.classList.toggle('hidden', unreadCount === 0);
                }

                if (currentScreen === 'inbox') renderInbox();
            }, (error) => {
                console.error("Error fetching notifications: ", error);
            });
        };

        // --- UI Rendering Functions ---
        const renderHome = () => {
            const lastUpdated = currentRates.lastUpdated;
            
            // အကောင့်ထဲထည့်ဖို့ ၁သိန်းရရန် ဘတ်
            const thbFor100kMMK = (100000 / currentRates.THB_TO_MMK).toFixed(2);
            // ၁သိန်းလျှင် ရမည့်ဘတ်
            const thbFor100kMMK_reverse = (100000 / currentRates.MMK_TO_THB).toFixed(2);
            // အိမ်အရောက်ပို့ ၁သိန်းရရန် ဘတ်
            const thbHomeDelivery = currentRates.rateHomeDeliveryTHB;

            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="space-y-6">
                    <p class="text-sm font-semibold text-emerald-400">ငွေလဲနှုန်း (၁ ဘတ်လျှင် မြန်မာကျပ်)</p>
                    <p class="text-xs text-gray-400">နောက်ဆုံး အပ်ဒိတ်: ${lastUpdated}</p>

                    <!-- Home Delivery Rate Card -->
                    <div class="card p-6 rounded-xl space-y-4 border border-red-500/50">
                        <h2 class="text-lg font-bold text-red-400">အိမ်သို့ ငွေလွဲရန် (Home Delivery Rate)</h2>
                        <div class="flex items-center justify-between p-4 bg-gray-600 rounded-xl">
                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300">ဘတ်</p>
                                <p class="text-2xl font-bold text-gray-50 mt-1">${thbHomeDelivery} ဘတ်</p>
                            </div>
                            <i class="fa-solid fa-arrow-right text-2xl text-red-400"></i>
                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300">ကျပ်</p>
                                <p class="text-2xl font-bold text-gray-50 mt-1">100,000 ကျပ်</p>
                            </div>
                        </div>
                        <p class="text-sm text-center text-gray-200">
                            ၁ ဘတ် = ${(100000 / thbHomeDelivery).toFixed(2)} ကျပ်
                        </p>
                    </div>

                    <!-- Account Transfer Rate Card -->
                    <div class="card p-6 rounded-xl space-y-4">
                        <h2 class="text-lg font-bold text-emerald-400">အကောင့်သို့ ငွေလွဲရန်</h2>
                        <div class="flex items-center justify-between p-4 bg-gray-600 rounded-xl">
                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300">${transferDirection === 'THB_TO_MMK' ? 'ထိုင်းမှ' : 'မြန်မာမှ'}</p>
                                <p class="text-xl font-bold text-gray-50 mt-1">
                                    ${transferDirection === 'THB_TO_MMK' ? `${thbFor100kMMK} ဘတ်` : `100,000 ကျပ်`}
                                </p>
                            </div>

                            <button onclick="toggleRateDirection()" class="text-2xl text-emerald-400 transition-transform duration-300">
                                <i class="fa-solid fa-arrows-left-right"></i>
                            </button>

                            <div class="text-center w-1/3">
                                <p class="text-xs font-medium text-gray-300">${transferDirection === 'THB_TO_MMK' ? 'ကျပ်' : 'ဘတ်'}</p>
                                <p class="text-xl font-bold text-gray-50 mt-1">
                                    ${transferDirection === 'THB_TO_MMK' ? `100,000 ကျပ်` : `${thbFor100kMMK_reverse} ဘတ်`}
                                </p>
                            </div>
                        </div>
                        <div class="text-center pt-2">
                            <p class="text-sm font-bold text-gray-200">
                                ${transferDirection === 'THB_TO_MMK' ? 
                                    `အကောင့်ထဲထည့်ဖို့ ၁သိန်းရရန်: ${thbFor100kMMK} ဘတ်` : 
                                    `၁သိန်းလျှင်ရမည့်ဘတ်: ${thbFor100kMMK_reverse} ဘတ်`}
                            </p>
                        </div>
                    </div>

                    <!-- Admin Bank Info -->
                    ${renderAdminBankInfo()}
                    
                    ${isAdmin ? renderAdminRatePanel() : ''}
                </div>
            `;
        };

        const renderAdminBankInfo = () => {
            return `
                <div class="card p-5 rounded-xl border border-blue-400/50">
                    <h2 class="text-xl font-bold text-blue-400 mb-3">Admin ၏ ငွေလွဲမည့် ဘဏ်အချက်အလက်</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <img src="${adminBankInfo.image1URL}" onerror="this.src='https://placehold.co/200x100/374151/ffffff?text=Bank+QR+1'" class="w-full rounded-lg object-cover border border-gray-600" alt="ဘဏ်ပုံ ၁">
                            <button onclick="downloadImage('${adminBankInfo.image1URL}')" class="w-full flex items-center justify-center p-2 text-xs bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                                <i class="fa-solid fa-download mr-2"></i> ပုံကို Save
                            </button>
                        </div>
                        <div class="space-y-2">
                            <img src="${adminBankInfo.image2URL}" onerror="this.src='https://placehold.co/200x100/374151/ffffff?text=Bank+QR+2'" class="w-full rounded-lg object-cover border border-gray-600" alt="ဘဏ်ပုံ ၂">
                            <button onclick="downloadImage('${adminBankInfo.image2URL}')" class="w-full flex items-center justify-center p-2 text-xs bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                                <i class="fa-solid fa-download mr-2"></i> ပုံကို Save
                            </button>
                        </div>
                    </div>
                    ${isAdmin ? renderAdminBankUpdateForm() : ''}
                </div>
            `;
        };

        const renderAdminBankUpdateForm = () => {
            return `
                <form id="bank-image-update-form" onsubmit="event.preventDefault(); updateBankImages()" class="mt-4 pt-4 border-t border-gray-600 space-y-3">
                    <h3 class="text-lg font-semibold text-red-400">Admin: ဘဏ်ပုံများ ပြင်ဆင်ရန်</h3>
                    <div>
                        <label for="bankImage1File" class="block text-sm font-medium">ဘဏ်ပုံ (၁) အပ်လုဒ်</label>
                        <input type="file" id="bankImage1File" accept="image/*" class="mt-1 w-full p-1 border rounded-lg">
                    </div>
                    <div>
                        <label for="bankImage2File" class="block text-sm font-medium">ဘဏ်ပုံ (၂) အပ်လုဒ်</label>
                        <input type="file" id="bankImage2File" accept="image/*" class="mt-1 w-full p-1 border rounded-lg">
                    </div>
                    <button type="submit" class="btn-primary w-full py-2 rounded-lg font-semibold">ပုံများ အပ်ဒိတ်လုပ်ရန်</button>
                </form>
            `;
        };

        const updateBankImages = async () => {
            if (!isAdmin) return showMessage('Admin လုပ်ဆောင်ချက်သာ ဖြစ်သည်', 'error');
            const file1 = document.getElementById('bankImage1File').files[0];
            const file2 = document.getElementById('bankImage2File').files[0];
            
            if (!file1 && !file2) return showMessage('ပုံအသစ် အနည်းဆုံးတစ်ပုံကို ရွေးချယ်ပါ', 'error');

            document.getElementById('loading-overlay').classList.remove('hidden');
            let updatedURLs = {};

            try {
                if (file1) {
                    updatedURLs.image1URL = await uploadToCloudinary(file1);
                }
                if (file2) {
                    updatedURLs.image2URL = await uploadToCloudinary(file2);
                }

                const docRef = doc(db, PUBLIC_DATA_PATH, 'config', 'bankInfo');
                await updateDoc(docRef, updatedURLs);
                showMessage('ဘဏ်ပုံများ အောင်မြင်စွာ အပ်ဒိတ်လုပ်ပြီးပါပြီ။');

            } catch (e) {
                console.error("Error updating bank images: ", e);
                showMessage('ဘဏ်ပုံ အပ်ဒိတ်လုပ်ရာတွင် အမှားရှိပါသည်', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        const renderAdminRatePanel = () => {
            return `
                <div class="card p-5 rounded-xl border border-red-400/50">
                    <h2 class="text-xl font-bold text-red-400 mb-3">Admin: ငွေလဲနှုန်းများ ပြင်ဆင်ရန်</h2>
                    <form id="rate-update-form" onsubmit="event.preventDefault(); updateRates()" class="space-y-3">
                        <div>
                            <label for="rateBuyMMKInput" class="block text-sm font-medium">ထိုင်းမှမြန်မာ (အကောင့်ထဲထည့်ဖို့ ၁သိန်းရရန် ဘတ်)</label>
                            <input type="number" id="rateBuyMMKInput" step="0.01" value="${(100000 / currentRates.THB_TO_MMK).toFixed(2)}" required class="mt-1 w-full p-2 border rounded-lg">
                            <p class="text-xs text-gray-400 mt-1">လက်ရှိ: ၁ ဘတ် = ${currentRates.THB_TO_MMK.toFixed(2)} ကျပ်</p>
                        </div>
                        <div>
                            <label for="rateBuyTHBInput" class="block text-sm font-medium">မြန်မာမှထိုင်း (၁သိန်းလျှင်ရမည့်ဘတ်)</label>
                            <input type="number" id="rateBuyTHBInput" step="0.01" value="${(100000 / currentRates.MMK_TO_THB).toFixed(2)}" required class="mt-1 w-full p-2 border rounded-lg">
                            <p class="text-xs text-gray-400 mt-1">လက်ရှိ: ၁ ဘတ် = ${currentRates.MMK_TO_THB.toFixed(2)} ကျပ်</p>
                        </div>
                        <div>
                            <label for="rateHomeDeliveryTHBInput" class="block text-sm font-medium">အိမ်မှထိုင်းသို့ (၁သိန်းလျှင်ရမည့်ဘတ်)</label>
                            <input type="number" id="rateHomeDeliveryTHBInput" step="0.01" value="${(100000 / currentRates.rateHomeDeliveryTHB).toFixed(2)}" required class="mt-1 w-full p-2 border rounded-lg">
                            <p class="text-xs text-gray-400 mt-1">လက်ရှိ: ၁ ဘတ် = ${(100000 / currentRates.rateHomeDeliveryTHB).toFixed(2)} ကျပ်</p>
                        </div>
                        <button type="submit" class="btn-primary w-full py-2 rounded-lg font-semibold">နှုန်းထားများ အပ်ဒိတ်လုပ်ရန်</button>
                    </form>
                </div>
            `;
        };

        const updateRates = async () => {
            if (!isAdmin) return showMessage('Admin လုပ်ဆောင်ချက်သာ ဖြစ်သည်', 'error');

            // Get values from the new input format
            const thbFor100kMMK = parseFloat(document.getElementById('rateBuyMMKInput').value);
            const thbFor100kMMK_reverse = parseFloat(document.getElementById('rateBuyTHBInput').value);
            const thbFor100kHomeDelivery = parseFloat(document.getElementById('rateHomeDeliveryTHBInput').value);
            
            if (isNaN(thbFor100kMMK) || isNaN(thbFor100kMMK_reverse) || isNaN(thbFor100kHomeDelivery)) {
                return showMessage('မှန်ကန်သော နှုန်းထားများကို ဖြည့်သွင်းပါ', 'error');
            }

            // Convert back to rate per 1 THB
            const rateBuyMMK = 100000 / thbFor100kMMK;
            const rateBuyTHB = 100000 / thbFor100kMMK_reverse;
            const rateHomeDeliveryTHB = 100000 / thbFor100kHomeDelivery;

            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                const docRef = doc(db, PUBLIC_DATA_PATH, 'rates', 'current');
                await updateDoc(docRef, { 
                    rateBuyMMK, 
                    rateBuyTHB,
                    rateHomeDeliveryTHB,
                    lastUpdated: serverTimestamp() 
                });
                showMessage('နှုန်းထားများ အောင်မြင်စွာ အပ်ဒိတ်လုပ်ပြီးပါပြီ။');
            } catch (e) {
                console.error("Error updating rates: ", e);
                showMessage('နှုန်းထား အပ်ဒိတ်လုပ်ရာတွင် အမှားရှိသည်', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Transfer Screen ---
        const renderTransfer = () => {
            const content = document.getElementById('content-area');
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="card p-5 rounded-xl border border-blue-400/50">
                        <h2 class="text-xl font-bold text-blue-400 mb-3">ငွေလွဲမှု အမျိုးအစား</h2>
                        <p class="text-sm text-gray-300 mb-2">Admin မှ ပေးထားသော QR/ဖုန်းနံပါတ်သို့ ငွေပို့ပြီးမှ ဖောင်ဖြည့်ပါ။</p>
                    </div>

                    <!-- Tabs for Transfer Type -->
                    <div class="flex border-b border-gray-700">
                        <button id="tab-account" onclick="setTransferTab('account')" 
                                class="tab-button flex-1 py-3 text-sm font-medium text-gray-400 hover:text-emerald-400 ${currentTransferTab === 'account' ? 'active' : ''}">
                            <i class="fa-solid fa-wallet mr-2"></i> အကောင့်သို့ ငွေလွဲရန်
                        </button>
                        <button id="tab-home" onclick="setTransferTab('home')" 
                                class="tab-button flex-1 py-3 text-sm font-medium text-gray-400 hover:text-emerald-400 ${currentTransferTab === 'home' ? 'active' : ''}">
                            <i class="fa-solid fa-house-chimney-user mr-2"></i> အိမ်အရောက် ပို့ရန်
                        </button>
                    </div>

                    <!-- Transfer Form Section -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-xl font-bold mb-4" id="transfer-form-title">${currentTransferTab === 'account' ? 'အကောင့်သို့ ငွေလွဲရန်' : 'အိမ်အရောက် ပို့ရန်'} ဖောင်</h2>
                        <form id="transfer-form" onsubmit="event.preventDefault(); submitTransfer('${currentTransferTab}')">
                            <div class="space-y-4">
                                
                                <!-- Transfer Account Selection (ONLY for Account Tab) -->
                                <div id="account-type-field" class="${currentTransferTab === 'account' ? '' : 'hidden'}">
                                    <label for="transferAccountType" class="block text-sm font-medium">ငွေပို့ထားသည့် အကောင့် (ရွေးချယ်ပါ)</label>
                                    <select id="transferAccountType" ${currentTransferTab === 'account' ? 'required' : ''} class="mt-1 w-full p-2 border rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                                        <option value="">-- ရွေးချယ်ပါ --</option>
                                        <option value="KayPay">Kay Pay</option>
                                        <option value="WavePay">Wave Pay</option>
                                        <option value="Other">အခြား (Other)</option>
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="senderName" class="block text-sm font-medium">ငွေလွဲမည့်သူအမည်</label>
                                        <input type="text" id="senderName" required class="mt-1 w-full p-2 border rounded-lg" placeholder="Aung Aung">
                                    </div>
                                    <div>
                                        <label for="receiverName" class="block text-sm font-medium">ငွေလက်ခံမည့်သူအမည်</label>
                                        <input type="text" id="receiverName" required class="mt-1 w-full p-2 border rounded-lg" placeholder="Ma Ma">
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="senderPhoneTH" class="block text-sm font-medium">ဖုန်းနံပါတ် (ထိုင်း)</label>
                                        <input type="tel" id="senderPhoneTH" required class="mt-1 w-full p-2 border rounded-lg" placeholder="09xxxxxxxxx">
                                    </div>
                                    <div>
                                        <label for="receiverPhoneMM" class="block text-sm font-medium">ဖုန်းနံပါတ် (မြန်မာ)</label>
                                        <input type="tel" id="receiverPhoneMM" required class="mt-1 w-full p-2 border rounded-lg" placeholder="09xxxxxxxxx">
                                    </div>
                                </div>
                                
                                <!-- Amount Input -->
                                <div>
                                    <label for="amountInput" class="block text-sm font-medium">ငွေလွဲမည့် ပမာဏ</label>
                                    <div class="mt-1 flex rounded-lg shadow-sm">
                                        <select id="amountDirection" onchange="updateCalculatedAmount()" class="p-2 border border-r-0 rounded-l-lg focus:ring-emerald-500 focus:border-emerald-500">
                                            <option value="THB_MMK">ဘတ် ➜ ကျပ်</option>
                                            <option value="MMK_THB">ကျပ် ➜ ဘတ်</option>
                                        </select>
                                        <input type="number" id="amountInput" step="0.01" min="1" required class="flex-grow p-2 border focus:ring-emerald-500 focus:border-emerald-500" placeholder="1000">
                                    </div>
                                    <p id="calculated-amount" class="mt-1 text-sm text-emerald-400 font-medium">
                                        ရရှိမည့်ပမာဏ: 0.00
                                    </p>
                                </div>
                                
                                <!-- Home Delivery Specific Field -->
                                <div id="home-address-field" class="${currentTransferTab === 'home' ? '' : 'hidden'}">
                                    <label for="deliveryAddress" class="block text-sm font-medium text-red-400">ပို့ရမည့်လိပ်စာ (မဖြစ်မနေ)</label>
                                    <textarea id="deliveryAddress" rows="3" ${currentTransferTab === 'home' ? 'required' : ''} class="mt-1 w-full p-2 border rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="လက်ခံမည့်သူ၏ လိပ်စာ အပြည့်အစုံ"></textarea>
                                </div>

                                <!-- Receipt File Upload -->
                                <div>
                                    <label for="receiptFile" class="block text-sm font-medium">ငွေပို့ထားသော စလစ်ပုံ ထည့်ရန် (ပုံဖိုင်)</label>
                                    <input type="file" id="receiptFile" accept="image/*" required class="mt-1 w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-emerald-400 hover:file:bg-gray-500">
                                    <p class="text-xs text-red-400 mt-1">** လွဲပြီးကြောင်း အတည်ပြုရန်အတွက် ပုံဖိုင်ကို မဖြစ်မနေ ထည့်သွင်းပေးရပါမည်။</p>
                                </div>
                                
                            </div>
                            
                            <button type="submit" class="btn-primary w-full py-3 rounded-lg mt-6 text-lg font-semibold">ပို့ရန်</button>
                        </form>
                    </div>
                </div>
            `;
            setTimeout(() => { updateCalculatedAmount(); }, 0);
            document.getElementById('amountInput').addEventListener('input', updateCalculatedAmount);
            document.getElementById('amountDirection').addEventListener('change', updateCalculatedAmount);
        };

        const updateCalculatedAmount = () => {
            const input = parseFloat(document.getElementById('amountInput').value);
            const direction = document.getElementById('amountDirection').value;
            const output = document.getElementById('calculated-amount');
            
            if (isNaN(input) || input <= 0) {
                output.textContent = `ရရှိမည့်ပမာဏ: 0.00`;
                return;
            }

            let result, fromCurrency, toCurrency;
            
            if (direction === 'THB_MMK') {
                result = input * currentRates.THB_TO_MMK;
                fromCurrency = 'ဘတ်';
                toCurrency = 'ကျပ်';
            } else {
                result = input / currentRates.MMK_TO_THB;
                fromCurrency = 'ကျပ်';
                toCurrency = 'ဘတ်';
            }
            
            output.textContent = `${input.toFixed(2)} ${fromCurrency} သည် ရရှိမည့်ပမာဏ: ${result.toFixed(2)} ${toCurrency} ဖြစ်သည်`;
        };

        const setTransferTab = (tab) => {
            currentTransferTab = tab;
            // Update Tab Styles
            document.getElementById('tab-account').classList.remove('active');
            document.getElementById('tab-home').classList.remove('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // Update Form Fields
            document.getElementById('transfer-form-title').textContent = `${tab === 'account' ? 'အကောင့်သို့ ငွေလွဲရန်' : 'အိမ်အရောက် ပို့ရန်'} ဖောင်`;
            
            const accountTypeField = document.getElementById('account-type-field');
            const accountTypeInput = document.getElementById('transferAccountType');
            const addressField = document.getElementById('home-address-field');
            const addressInput = document.getElementById('deliveryAddress');

            // Account Type Visibility (Only for 'account' tab)
            if (tab === 'account') {
                accountTypeField.classList.remove('hidden');
                accountTypeInput.setAttribute('required', 'required');
            } else {
                accountTypeField.classList.add('hidden');
                accountTypeInput.removeAttribute('required');
            }
            
            // Address Visibility (Only for 'home' tab)
            if (tab === 'home') {
                addressField.classList.remove('hidden');
                addressInput.setAttribute('required', 'required');
            } else {
                addressField.classList.add('hidden');
                addressInput.removeAttribute('required');
            }
            
            // Update Submission handler
            document.getElementById('transfer-form').onsubmit = (e) => {
                e.preventDefault();
                submitTransfer(currentTransferTab);
            };
        };

        const submitTransfer = async (transferType) => {
            if (!userId) return showMessage('အသုံးပြုသူအချက်အလက် မရှိပါ', 'error');

            const form = document.getElementById('transfer-form');
            const transferAccountType = transferType === 'account' ? document.getElementById('transferAccountType').value : 'N/A';
            const senderName = document.getElementById('senderName').value;
            const senderPhoneTH = document.getElementById('senderPhoneTH').value;
            const receiverName = document.getElementById('receiverName').value;
            const receiverPhoneMM = document.getElementById('receiverPhoneMM').value;
            const amountInput = parseFloat(document.getElementById('amountInput').value);
            const amountDirection = document.getElementById('amountDirection').value;
            const receiptFileInput = document.getElementById('receiptFile');
            const receiptFile = receiptFileInput.files[0];
            
            let deliveryAddress = '';
            if (transferType === 'home') {
                deliveryAddress = document.getElementById('deliveryAddress').value;
            }
            
            if (isNaN(amountInput) || amountInput <= 0 || !receiptFile) {
                return showMessage('ပမာဏ သို့မဟုတ် စလစ်ပုံဖိုင်ကို မှန်ကန်စွာ ဖြည့်သွင်းပါ', 'error');
            }

            let amountTHB, amountMMK;
            if (amountDirection === 'THB_MMK') {
                amountTHB = amountInput;
                amountMMK = amountInput * currentRates.THB_TO_MMK;
            } else {
                amountMMK = amountInput;
                amountTHB = amountInput / currentRates.MMK_TO_THB;
            }

            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                // --- 1. Upload Logic using Cloudinary ---
                let receiptImageURL = '';
                receiptImageURL = await uploadToCloudinary(receiptFile);

                // --- 2. Firestore Logic ---
                const transfersColRef = collection(db, PUBLIC_DATA_PATH, 'transfers');
                const newTransferRef = doc(transfersColRef);
                
                await setDoc(newTransferRef, {
                    senderId: userId,
                    senderEmail: userEmail,
                    senderName,
                    senderPhoneTH,
                    receiverName,
                    receiverPhoneMM,
                    transferAccountType, 
                    amountTHB: parseFloat(amountTHB.toFixed(2)),
                    amountMMK: parseFloat(amountMMK.toFixed(2)),
                    transferDirection: amountDirection,
                    transferType: transferType, 
                    deliveryAddress: deliveryAddress || 'N/A', 
                    receiptImageURL, 
                    timestamp: serverTimestamp(),
                    status: 'Pending',
                    adminReply: { message: '', imageURL: '' }
                });

                form.reset();
                updateCalculatedAmount(); 
                showMessage('ငွေလွဲမှု တောင်းဆိုချက် အောင်မြင်စွာ ပို့ပြီးပါပြီ။');
                showScreen('home');

            } catch (e) {
                console.error("Error in transfer process (Upload or Firestore): ", e);
                let errorMessage = 'ငွေလွဲမှု တောင်းဆိုချက် ပို့ရာတွင် အမှားရှိပါသည် (သို့) ပုံတင်ရာတွင် ပြဿနာရှိပါသည်။';
                showMessage(errorMessage, 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Admin Panel Functions ---
        const renderAdminPanel = () => {
            if (!isAdmin) return showScreen('home');
            
            const pendingTransfers = adminTransfers.filter(t => t.status === 'Pending');
            const content = document.getElementById('content-area');

            content.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-red-400">Admin စစ်ဆေးဆဲ စာရင်း (${pendingTransfers.length})</h2>
                    <p class="text-sm text-gray-400">စစ်ဆေးရန်ကျန်ရှိသော စာရင်းများ</p>

                    <div id="admin-transfers-list" class="space-y-3">
                        ${pendingTransfers.length === 0 ? 
                            '<p class="text-gray-400 p-4 card rounded-lg text-center">စစ်ဆေးရန် ငွေလွဲမှုများ မရှိပါ</p>' :
                            pendingTransfers.map(t => `
                                <div onclick="renderAdminTransferDetail('${t.id}')" class="card p-4 rounded-xl cursor-pointer hover:bg-gray-700 transition duration-150">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-bold text-lg text-emerald-400">${t.senderName || 'N/A'}</p>
                                            <p class="text-xs text-gray-400">${t.senderEmail}</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-sm font-semibold px-2 py-1 rounded-full ${t.transferType === 'home' ? 'bg-red-600' : 'bg-blue-600'} text-white">
                                                ${t.transferType === 'home' ? 'အိမ်အရောက် ပို့ရန်' : 'အကောင့်သို့ ငွေလွဲ'}
                                            </span>
                                            <p class="text-xs mt-1">${t.amountTHB} ဘတ် ➜ ${t.amountMMK} ကျပ်</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
        };

        const renderAdminTransferDetail = (transferId) => {
            const transfer = adminTransfers.find(t => t.id === transferId);
            if (!transfer) return showMessage('အချက်အလက် ရှာမတွေ့ပါ', 'error');

            const content = document.getElementById('content-area');
            const transferTypeLabel = transfer.transferType === 'home' ? 'အိမ်အရောက် ပို့ရန်' : 'အကောင့်သို့ ငွေလွဲ';
            const date = transfer.timestamp ? transfer.timestamp.toDate().toLocaleString('my-MM') : 'N/A';
            
            content.innerHTML = `
                <div class="space-y-6">
                    <button onclick="showScreen('admin')" class="text-blue-400 hover:text-blue-300 mb-4"><i class="fa-solid fa-arrow-left mr-2"></i> စီမံခန့်ခွဲမှု သို့ ပြန်သွားရန်</button>
                    
                    <h2 class="text-2xl font-bold text-red-400">ငွေလွဲမှု အသေးစိတ် - (${transferTypeLabel})</h2>
                    <div class="card p-5 rounded-xl space-y-3">
                        <p><strong>ငွေလွဲသူ (Name):</strong> ${transfer.senderName}</p>
                        <p><strong>Email:</strong> ${transfer.senderEmail}</p>
                        <p><strong>Phone (TH):</strong> ${transfer.senderPhoneTH}</p>
                        <p><strong>လက်ခံသူ (Name):</strong> ${transfer.receiverName}</p>
                        <p><strong>Phone (MM):</strong> ${transfer.receiverPhoneMM}</p>
                        <p><strong>Amount:</strong> ${transfer.amountTHB.toFixed(2)} ဘတ် ➜ ${transfer.amountMMK.toFixed(2)} ကျပ်</p>
                        <p><strong>Type:</strong> ${transferTypeLabel} (${transfer.transferAccountType})</p>
                        <p class="text-red-400"><strong>ပို့ရမည့်လိပ်စာ:</strong> ${transfer.deliveryAddress || 'N/A'}</p>
                        <p><strong>ရက်စွဲ:</strong> ${date}</p>
                        <p><strong>Status:</strong> <span class="font-bold text-yellow-400">${transfer.status}</span></p>
                    </div>

                    <!-- Receipt Image and Download -->
                    <div class="card p-5 rounded-xl space-y-3">
                        <h3 class="text-xl font-bold mb-2">ငွေပို့စလစ်ပုံ</h3>
                        <img src="${transfer.receiptImageURL}" onerror="this.src='https://placehold.co/400x200/374151/ffffff?text=No+Receipt'" class="w-full rounded-lg object-cover border border-gray-600 max-h-48" alt="[Image of Transfer Receipt]">
                        <button onclick="downloadImage('${transfer.receiptImageURL}')" class="w-full flex items-center justify-center p-2 text-sm bg-gray-600 text-blue-400 rounded-lg hover:bg-gray-500">
                            <i class="fa-solid fa-download mr-2"></i> ပုံကို Save စလစ်ပုံ
                        </button>
                    </div>

                    <!-- Admin Reply Form -->
                    <div class="card p-5 rounded-xl space-y-3">
                        <h3 class="text-xl font-bold mb-2 text-emerald-400">စာ/ပုံ ပြန်ပို့ရန်</h3>
                        <form id="admin-reply-form" onsubmit="event.preventDefault(); sendAdminReply('${transfer.id}')">
                            <div>
                                <label for="replyMessage" class="block text-sm font-medium">စာသား</label>
                                <textarea id="replyMessage" rows="2" class="mt-1 w-full p-2 border rounded-lg" placeholder="ငွေလွဲမှု အတည်ပြုချက် သို့မဟုတ် မက်ဆေ့ခ်ျ"></textarea>
                            </div>
                            <div>
                                <label for="replyImage" class="block text-sm font-medium">ပုံ ပြန်ပို့ရန် (ရွေးချယ်ရန်)</label>
                                <input type="file" id="replyImage" accept="image/*" class="mt-1 w-full p-2 border rounded-lg file:bg-gray-600 file:text-emerald-400">
                            </div>
                            <button type="submit" class="w-full py-2 rounded-lg font-semibold bg-emerald-600 text-white mt-3 hover:bg-emerald-500">
                                <i class="fa-solid fa-reply mr-2"></i> User သို့ ပြန်ပို့ရန်
                            </button>
                        </form>
                    </div>

                    <!-- Complete Button -->
                    <button onclick="completeTransfer('${transfer.id}')" class="w-full py-3 rounded-lg font-bold bg-green-600 text-white hover:bg-green-500">
                        <i class="fa-solid fa-check-circle mr-2"></i> ငွေလွဲမှု ပြီးဆုံးကြောင်း အတည်ပြုရန်
                    </button>
                </div>
            `;
        };

        const sendAdminReply = async (transferId) => {
            if (!isAdmin) return;
            const transfer = adminTransfers.find(t => t.id === transferId);
            if (!transfer) return;
            
            const message = document.getElementById('replyMessage').value.trim();
            const imageFile = document.getElementById('replyImage').files[0];

            if (!message && !imageFile) return showMessage('စာ သို့မဟုတ် ပုံ တစ်ခုခု ထည့်သွင်းပေးပါ', 'error');

            document.getElementById('loading-overlay').classList.remove('hidden');

            let replyImageURL = '';
            
            try {
                if (imageFile) {
                    replyImageURL = await uploadToCloudinary(imageFile);
                }

                // 1. Send Notification to User's Inbox
                const notificationRef = doc(collection(db, `artifacts/${APP_ID}/users/${transfer.senderId}`, 'notifications'));
                await setDoc(notificationRef, {
                    title: `Admin မှ ${transfer.amountMMK.toFixed(0)} ကျပ် ငွေလွဲမှု အကြောင်း ပြန်ကြားချက်`,
                    message: message || 'Admin မှ သင့်အား ပုံဖြင့် အကြောင်းပြန်ကြားထားပါသည်။',
                    imageURL: replyImageURL,
                    isRead: false,
                    timestamp: serverTimestamp(),
                    relatedTransferId: transferId
                });

                // 2. Update Transfer status to Completed if message contains key phrase (optional, but good practice)
                if (message.includes('ပြီးပါပြီ') || message.includes('Completed')) {
                    await updateDoc(doc(db, PUBLIC_DATA_PATH, 'transfers', transferId), { status: 'Completed' });
                }

                showMessage('User သို့ အကြောင်းပြန်ကြားချက် အောင်မြင်စွာ ပို့ပြီးပါပြီ။');
                document.getElementById('admin-reply-form').reset();
            } catch (e) {
                console.error("Error sending reply: ", e);
                showMessage('ပြန်ပို့ရာတွင် အမှားရှိသည်', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };
        
        const completeTransfer = async (transferId) => {
            if (!isAdmin) return;
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                await updateDoc(doc(db, PUBLIC_DATA_PATH, 'transfers', transferId), { status: 'Completed' });
                
                // Also send a formal notification
                const transfer = adminTransfers.find(t => t.id === transferId);
                const notificationRef = doc(collection(db, `artifacts/${APP_ID}/users/${transfer.senderId}`, 'notifications'));
                await setDoc(notificationRef, {
                    title: `✅ ငွေလွဲမှု အောင်မြင်ပါသည်။`,
                    message: `သင့်၏ ${transfer.amountTHB.toFixed(2)} ဘတ် ➜ ${transfer.amountMMK.toFixed(0)} ကျပ် ငွေလွဲမှု အောင်မြင်စွာ ပြီးဆုံးကြောင်း အတည်ပြုပါသည်။`,
                    isRead: false,
                    timestamp: serverTimestamp(),
                    relatedTransferId: transferId
                });

                showMessage('ငွေလွဲမှု ပြီးဆုံးကြောင်း အောင်မြင်စွာ အတည်ပြုပြီးပါပြီ။');
                showScreen('admin');
            } catch (e) {
                console.error("Error completing transfer: ", e);
                showMessage('အတည်ပြုရာတွင် အမှားရှိသည်', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Inbox Screen ---
        const renderInbox = () => {
            const content = document.getElementById('content-area');
            
            content.innerHTML = `
                <div class="space-y-6" id="inbox-content">
                    <h2 class="text-2xl font-bold text-emerald-400">အဝင်စာ</h2>
                    <p class="text-sm text-gray-400">Admin မှ ပို့သော မက်ဆေ့ခ်ျများ</p>
                    
                    <div id="notifications-list" class="space-y-3">
                        ${userNotifications.length === 0 ? 
                            '<p class="text-gray-400 p-4 card rounded-lg text-center">အဝင်စာ မရှိပါ</p>' :
                            userNotifications.map(n => {
                                const date = n.timestamp ? n.timestamp.toDate().toLocaleString('my-MM') : 'N/A';
                                return `
                                    <div onclick="markNotificationAsRead('${n.id}')" class="card p-4 rounded-xl cursor-pointer transition duration-150 ${n.isRead ? 'opacity-80' : 'border-2 border-yellow-400'}">
                                        <div class="flex items-start">
                                            <i class="fa-solid fa-bell text-xl ${n.isRead ? 'text-gray-400' : 'text-yellow-400'} mr-3 mt-1"></i>
                                            <div class="flex-grow">
                                                <p class="font-bold ${n.isRead ? 'text-gray-200' : 'text-white'}">${n.title}</p>
                                                <p class="text-sm text-gray-400">${n.message}</p>
                                                ${n.imageURL ? `
                                                    <img src="${n.imageURL}" onerror="this.src='https://placehold.co/100x50/374151/ffffff?text=Image'" class="mt-2 rounded-lg max-h-20 object-contain border border-gray-600" alt="">
                                                    <a href="${n.imageURL}" target="_blank" onclick="event.stopPropagation();" class="text-xs text-blue-400 hover:text-blue-300 mt-1 inline-block"><i class="fa-solid fa-expand-alt mr-1"></i> ပုံကြီးချဲ့ကြည့်ရန်</a>
                                                ` : ''}
                                                <p class="text-xs text-gray-500 mt-2">${date}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')
                        }
                    </div>
                </div>
            `;
        };

        const markNotificationAsRead = async (id) => {
            if (!userId) return;
            try {
                const docRef = doc(db, `artifacts/${APP_ID}/users/${userId}`, 'notifications', id);
                await updateDoc(docRef, { isRead: true });
            } catch(e) {
                console.error("Error marking as read:", e);
            }
        };

        // --- Profile Screen ---
        const renderProfile = () => {
            const content = document.getElementById('content-area');
            const user = auth.currentUser;
            const userEmail = user?.email || 'N/A';
            const userDisplayName = user?.displayName || '';

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Profile Card -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-2xl font-bold mb-4">Profile နှင့် Account</h2>
                        
                        <div class="space-y-3">
                            <p><strong>Username:</strong> ${userDisplayName || 'N/A'}</p>
                            <p><strong>Email:</strong> ${userEmail}</p>
                            <p><strong>User ID:</strong> ${userId || 'N/A'}</p>
                        </div>
                        
                        <form id="update-profile-form" onsubmit="event.preventDefault(); updateProfileName()" class="mt-4 pt-4 border-t border-gray-600">
                            <label for="usernameInput" class="block text-sm font-medium">Username (ပြောင်းလဲရန်)</label>
                            <input type="text" id="usernameInput" value="${userDisplayName}" placeholder="သင့်အမည်" class="mt-1 w-full p-2 border rounded-lg">
                            <button type="submit" class="btn-primary w-full py-2 rounded-lg mt-3 font-semibold">Username အပ်ဒိတ်</button>
                        </form>
                    </div>

                    <!-- Past Transfers Section -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-xl font-bold mb-3">ငွေပို့ထားသည့် စာရင်းများ</h2>
                        <div id="profile-transfers-list" class="space-y-3">
                            ${renderProfileTransfers()}
                        </div>
                    </div>

                    <!-- Settings & Logout -->
                    <div class="card p-5 rounded-xl">
                        <h2 class="text-xl font-bold mb-3">Settings</h2>
                        
                        <!-- Language Selection -->
                        <div class="flex justify-between items-center py-2 border-b border-gray-600">
                            <span class="font-medium">ဘာသာစကား (Language)</span>
                            <select onchange="setLanguage(this.value)" class="p-1 border rounded-lg bg-gray-600">
                                <option value="my" selected>မြန်မာ (Burmese)</option>
                                <option value="en">English</option>
                            </select>
                        </div>

                        <!-- Logout Button -->
                        <button onclick="handleLogout()" class="w-full py-2 rounded-lg font-bold bg-red-600 text-white mt-4 hover:bg-red-500">
                            <i class="fa-solid fa-sign-out-alt mr-2"></i> Log Out
                        </button>
                    </div>
                </div>
            `;
        };

        const renderProfileTransfers = () => {
            if (userTransfers.length === 0) return '<p class="text-gray-400 text-center">သင် ငွေလွဲထားသော စာရင်းများ မရှိပါ</p>';

            return userTransfers.map(t => {
                const date = t.timestamp ? t.timestamp.toDate().toLocaleString('my-MM') : 'N/A';
                const statusColor = t.status === 'Completed' ? 'bg-green-600' : (t.status === 'Pending' ? 'bg-yellow-600' : 'bg-red-600');
                const transferTypeLabel = t.transferType === 'home' ? 'အိမ်အရောက် ပို့ရန်' : 'အကောင့်သို့ ငွေလွဲ';

                return `
                    <div class="card p-3 rounded-xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-100">${t.amountTHB.toFixed(2)} ဘတ် ➜ ${t.amountMMK.toFixed(2)} ကျပ်</p>
                                <p class="text-xs text-gray-400 mt-1">${transferTypeLabel} (${t.receiverName})</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColor} text-white">${t.status}</span>
                                <p class="text-xs text-gray-500 mt-1">${date}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        const updateProfileName = async () => {
            const usernameInput = document.getElementById('usernameInput').value.trim();
            if (!usernameInput) return showMessage('Username ဖြည့်သွင်းပါ', 'error');

            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await updateProfile(auth.currentUser, { displayName: usernameInput });
                showMessage('Username အောင်မြင်စွာ ပြောင်းလဲပြီးပါပြီ။');
                // Re-render to show updated name
                showScreen('profile');
            } catch (error) {
                console.error("Error updating profile:", error);
                showMessage('Username ပြောင်းလဲရာတွင် အမှားရှိသည်', 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        // --- Core Application Logic ---
        const showScreen = (screenName) => {
            if (!isAuthReady) return;

            if (screenName === 'admin' && !isAdmin) {
                screenName = 'home';
            }

            currentScreen = screenName;
            const navButtons = document.querySelectorAll('.nav-button');

            // Reset navigation styles
            navButtons.forEach(btn => {
                // Ensure only non-admin buttons reset to gray
                if (btn.id !== 'admin-nav-button') {
                    btn.classList.remove('text-emerald-400');
                    btn.classList.add('text-gray-400');
                } else {
                    btn.classList.remove('text-red-400');
                }
            });

            // Set active navigation style
            const activeBtn = document.querySelector(`[onclick="showScreen('${screenName}')"]`);
            if (activeBtn) {
                if (screenName === 'admin') {
                    activeBtn.classList.add('text-red-400');
                    activeBtn.classList.remove('text-gray-400');
                } else {
                    activeBtn.classList.add('text-emerald-400');
                    activeBtn.classList.remove('text-gray-400');
                }
            }

            const content = document.getElementById('content-area');
            content.innerHTML = `<p class="text-center text-gray-500">ဒေတာများ ဆွဲယူနေပါသည်...</p>`;

            switch (screenName) {
                case 'home':
                    renderHome();
                    break;
                case 'transfer':
                    renderTransfer();
                    break;
                case 'inbox':
                    renderInbox();
                    break;
                case 'profile':
                    renderProfile();
                    break;
                case 'admin':
                    renderAdminPanel();
                    break;
                default:
                    renderHome();
            }
        };

        // Start initialization
        initFirebase();

        // Global functions
        window.renderAuthScreen = renderAuthScreen;
        window.handleAuthSubmit = handleAuthSubmit;
        window.handleLogout = async () => {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await signOut(auth);
                showMessage('အောင်မြင်စွာ ထွက်ခွာခဲ့ပြီးပါပြီ။');
            } catch (error) {
                showMessage('ထွက်ခွာရန် အမှားရှိသည်', 'error');
            }
        };
        window.toggleRateDirection = () => {
            transferDirection = transferDirection === 'THB_TO_MMK' ? 'MMK_TO_THB' : 'THB_TO_MMK';
            renderHome();
        };
        window.updateRates = updateRates;
        window.showScreen = showScreen;
        window.setTransferTab = setTransferTab;
        window.submitTransfer = submitTransfer;
        window.updateCalculatedAmount = updateCalculatedAmount;
        window.renderAdminPanel = renderAdminPanel;
        window.renderAdminTransferDetail = renderAdminTransferDetail;
        window.sendAdminReply = sendAdminReply;
        window.completeTransfer = completeTransfer;
        window.markNotificationAsRead = markNotificationAsRead;
        window.updateProfileName = updateProfileName;
        window.downloadImage = downloadImage;
        window.updateBankImages = updateBankImages;
        window.setLanguage = (lang) => {
            // Language change functionality
            showMessage('ဘာသာစကား ပြောင်းလဲမှု အောင်မြင်ပါသည်');
        };

    </script>
</body>
</html>
